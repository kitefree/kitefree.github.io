<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kitefree.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="地球人的修練">
<meta property="og:url" content="https://kitefree.github.io/page/2/index.html">
<meta property="og:site_name" content="地球人的修練">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="kite">
<meta property="article:tag" content="c#,Asp.net,Asp.net MVC,Net Core,後端,WebApi,SQL,SQL Server">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kitefree.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>地球人的修練</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球人的修練</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>網站地圖</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/06/18/2022-06-18%20OWASP%20ZAP%20%E5%BF%83%E5%BE%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/18/2022-06-18%20OWASP%20ZAP%20%E5%BF%83%E5%BE%97/" class="post-title-link" itemprop="url">OWASP ZAP 心得</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-06-18 11:23:00" itemprop="dateCreated datePublished" datetime="2022-06-18T11:23:00+08:00">2022-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-07-14 19:02:20" itemprop="dateModified" datetime="2022-07-14T19:02:20+08:00">2022-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B3%87%E5%AE%89/" itemprop="url" rel="index"><span itemprop="name">資安</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B3%87%E5%AE%89/OWASP-ZAP/" itemprop="url" rel="index"><span itemprop="name">OWASP ZAP</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>客戶的案子希望提供簡單的弱點掃描服務，這次使用OWASP ZAP 2.11.1版本進行掃描測試。如何修復弱點…過程是痛苦的(可能心中只想寫程式…)，於是決定寫下筆記，或許之後會用得上。(朋友提醒我，要注意軟體有沒有誤判)</p>
<h2 id="2-Missing-Anti-clickjacking-Header-風險：中"><a href="#2-Missing-Anti-clickjacking-Header-風險：中" class="headerlink" title="2. Missing Anti-clickjacking Header (風險：中)"></a>2. Missing Anti-clickjacking Header (風險：中)</h2><p><img src="https://i.imgur.com/lEtVkxN.png" alt="image-20220618144640064"></p>
<h3 id="2-1-Description"><a href="#2-1-Description" class="headerlink" title="2.1. Description"></a>2.1. Description</h3><blockquote>
<p>The response does not include either Content-Security-Policy with ‘frame-ancestors’ directive or X-Frame-Options to protect against ‘Click.Jacking’ attacks.</p>
</blockquote>
<h3 id="2-2-Solution"><a href="#2-2-Solution" class="headerlink" title="2.2. Solution"></a>2.2. Solution</h3><blockquote>
<p>Modern Web Browsers support the Content-Security-Policy and X-Frame-Options HTTP headers. Ensure one of them is set on all web pages returned by your site&#x2F;app.</p>
<p>If you expect the page to be framed only by pages on your server(e.g. it’s part of a FRAMESET) then you’ll want to use SAMEORIGIN. otherwise if you nerver expect the page to be framed,you should use DENY. Alternatively consider implementing Content Security Policy’s “frame-ancestors” directive.</p>
</blockquote>
<h3 id="2-3-Before-response-header"><a href="#2-3-Before-response-header" class="headerlink" title="2.3. Before response header"></a>2.3. Before response header</h3><p><img src="https://i.imgur.com/rpV0bso.png" alt="image-20220619192311369"></p>
<h3 id="2-4-解決方式"><a href="#2-4-解決方式" class="headerlink" title="2.4. 解決方式"></a>2.4. 解決方式</h3><p>設定web.config ，加入<code>&lt;add name=&quot;X-Frame-Options&quot; value=&quot;SAMEORIGIN&quot; /&gt;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-After-Response-header"><a href="#2-5-After-Response-header" class="headerlink" title="2.5. After Response header"></a>2.5. After Response header</h3><p><img src="https://i.imgur.com/4QSbJp1.png" alt="image-20220619192406171"></p>
<h3 id="2-6-進行OWASP-ZAP-驗證"><a href="#2-6-進行OWASP-ZAP-驗證" class="headerlink" title="2.6. 進行OWASP ZAP 驗證"></a>2.6. 進行OWASP ZAP 驗證</h3><p><img src="https://i.imgur.com/njtWTjT.png" alt="image-20220618145351126"></p>
<h3 id="2-7-小結"><a href="#2-7-小結" class="headerlink" title="2.7. 小結"></a>2.7. 小結</h3><p>其實跟下一題解決方式一樣(X-Frame-Options Setting Malformed)，筆者這邊只是練習了二次，別分使用<code>web.config</code>、<code>IIS工具介面</code>，想知道效果是不是一樣的。這裡比較令我感到好奇的是，同一個解法解決了「Missing Anti-clickjacking Header」、「X-Frame-Options Setting Malformed 」二個題目，只是有時候OWASP ZAP 出現的alert 卻是不同的。</p>
<h2 id="3-X-Frame-Options-Setting-Malformed-風險：中"><a href="#3-X-Frame-Options-Setting-Malformed-風險：中" class="headerlink" title="3. X-Frame-Options Setting Malformed (風險：中)"></a>3. X-Frame-Options Setting Malformed (風險：中)</h2><p><img src="https://i.imgur.com/2bLyCYw.jpg" alt="messageImage_1655471403029"></p>
<h3 id="3-1-Description"><a href="#3-1-Description" class="headerlink" title="3.1. Description"></a>3.1. Description</h3><blockquote>
<p>An X-Frame-Options header was present in the response but the value was not correctly set.</p>
</blockquote>
<h3 id="3-2-Solution"><a href="#3-2-Solution" class="headerlink" title="3.2. Solution"></a>3.2. Solution</h3><blockquote>
<p>Ensure a valid setting is used on all web pages returned by your site (if you expect the page to be framed only by pages on your server (e.g. it’s part of a FRAMESET) then you’ll want to use SAMEORIGIN, otherwise if you never expect the page to be framed, you should use DENY.  Alternatively consider implementing Content Security Policy’s “frame-ancestors” directive.</p>
</blockquote>
<h3 id="3-3-Before-response-header"><a href="#3-3-Before-response-header" class="headerlink" title="3.3. Before response header"></a>3.3. Before response header</h3><p><img src="https://i.imgur.com/QUAkUoB.png" alt="image-20220619192525912"></p>
<h3 id="3-4-解決方式"><a href="#3-4-解決方式" class="headerlink" title="3.4. 解決方式"></a>3.4. 解決方式</h3><p>在IIS介面使用<code>HTTP回應標題</code>點擊進入後，再點擊右邊的<code>新增</code>，開始填寫<code>名稱</code>、<code>值</code>。</p>
<p><img src="https://i.imgur.com/lp54xAM.png" alt="image-20220618141806921"></p>
<p><img src="https://i.imgur.com/AIeNGfA.png" alt="image-20220618150503383"></p>
<p><img src="https://i.imgur.com/R28DEli.jpg" alt="1655470906467"></p>
<h3 id="3-5-After-response-header"><a href="#3-5-After-response-header" class="headerlink" title="3.5. After response header"></a>3.5. After response header</h3><p><img src="https://i.imgur.com/XhogXK8.png" alt="image-20220618114602656"></p>
<h3 id="3-6-進行OWASP-ZAP-驗證"><a href="#3-6-進行OWASP-ZAP-驗證" class="headerlink" title="3.6. 進行OWASP ZAP 驗證"></a>3.6. 進行OWASP ZAP 驗證</h3><p><img src="https://i.imgur.com/X6fcSdR.jpg" alt="1655471705151"></p>
<h2 id="4-Re-examine-Cache-control-Directives-風險：低"><a href="#4-Re-examine-Cache-control-Directives-風險：低" class="headerlink" title="4. Re-examine Cache-control Directives(風險：低)"></a>4. Re-examine Cache-control Directives(風險：低)</h2><p>無圖(忘了截圖，放棄補…)</p>
<h3 id="4-1-Description"><a href="#4-1-Description" class="headerlink" title="4.1. Description"></a>4.1. Description</h3><blockquote>
<p>The cache-control header has not been set properly or is missing, allowing the browser and proxies to cache content. For static assets like css, js, or image files this might be intended, however, the resources should be reviewed to ensure that no sensitive content will be cached.</p>
</blockquote>
<h3 id="4-2-Solution"><a href="#4-2-Solution" class="headerlink" title="4.2. Solution"></a>4.2. Solution</h3><blockquote>
<p>For secure content, ensure the cache-control HTTP header is set with “no-cache, no-store, must-revalidate”. If an asset should be cached consider setting the directives “public, max-age, immutable”.</p>
</blockquote>
<p><img src="https://i.imgur.com/lp54xAM.png" alt="image-20220618141806921"></p>
<h3 id="4-3-Before-response-header"><a href="#4-3-Before-response-header" class="headerlink" title="4.3. Before response header"></a>4.3. Before response header</h3><p><img src="https://i.imgur.com/1YjiIcO.png" alt="image-20220619193259536"></p>
<h3 id="4-4-解決方式"><a href="#4-4-解決方式" class="headerlink" title="4.4. 解決方式"></a>4.4. 解決方式</h3><p><img src="https://i.imgur.com/X1ucSSv.png" alt="image-20220618142106847"></p>
<p>如果在站台下有web.config檔，則會自動添加紅色區塊的設定</p>
<p><img src="https://i.imgur.com/Ec3jntc.png" alt="image-20220618142246166"></p>
<h3 id="4-5-After-Response-header"><a href="#4-5-After-Response-header" class="headerlink" title="4.5. After Response header"></a>4.5. After Response header</h3><p><img src="https://i.imgur.com/zUzaYa7.png" alt="image-20220619193212629"></p>
<h3 id="4-6-進行OWASP-ZAP驗證"><a href="#4-6-進行OWASP-ZAP驗證" class="headerlink" title="4.6. 進行OWASP ZAP驗證"></a>4.6. 進行OWASP ZAP驗證</h3><p>無圖(忘了截圖，放棄補…)</p>
<h2 id="5-X-Content-Type-Options-Header-Missing-風險：低"><a href="#5-X-Content-Type-Options-Header-Missing-風險：低" class="headerlink" title="5. X-Content-Type-Options Header Missing (風險：低)"></a>5. X-Content-Type-Options Header Missing (風險：低)</h2><p><img src="https://i.imgur.com/gZ0QL3x.png" alt="image-20220618152728961"></p>
<h3 id="5-1-Description"><a href="#5-1-Description" class="headerlink" title="5.1. Description"></a>5.1. Description</h3><blockquote>
<p>The Anti-MIME-Sniffing header X-Content-Type-Options was not set to ‘nosniff’. This allows older versions of Internet Explorer and Chrome to perform MIME-sniffing on the response body, potentially causing the response body to be interpreted and displayed as a content type other than the declared content type. Current (early 2014) and legacy versions of Firefox will use the declared content type (if one is set), rather than performing MIME-sniffing.</p>
</blockquote>
<h3 id="5-2-Solution"><a href="#5-2-Solution" class="headerlink" title="5.2. Solution"></a>5.2. Solution</h3><blockquote>
<p>Ensure that the application&#x2F;web server sets the Content-Type header appropriately, and that it sets the X-Content-Type-Options header to ‘nosniff’ for all web pages.<br>If possible, ensure that the end user uses a standards-compliant and modern web browser that does not perform MIME-sniffing at all, or that can be directed by the web application&#x2F;web server to not perform MIME-sniffing.</p>
</blockquote>
<h3 id="5-3-Before-response-header"><a href="#5-3-Before-response-header" class="headerlink" title="5.3. Before response header"></a>5.3. Before response header</h3><p><img src="https://i.imgur.com/CF0rtyh.png" alt="image-20220619193337785"></p>
<h3 id="5-4-解決方式"><a href="#5-4-解決方式" class="headerlink" title="5.4. 解決方式"></a>5.4. 解決方式</h3><p>加入 <code>&lt;add name=&quot;X-Content-Type-Options&quot; value=&quot;nosniff&quot; /&gt;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-5-After-response-header"><a href="#5-5-After-response-header" class="headerlink" title="5.5. After response header"></a>5.5. After response header</h3><p><img src="https://i.imgur.com/lLgnEH2.png" alt="image-20220619193423691"></p>
<h3 id="5-6-進行OWASP-ZAP-驗證"><a href="#5-6-進行OWASP-ZAP-驗證" class="headerlink" title="5.6. 進行OWASP ZAP 驗證"></a>5.6. 進行OWASP ZAP 驗證</h3><p><img src="https://i.imgur.com/3SciMww.png" alt="image-20220618153815955"></p>
<h2 id="6-Content-Security-Policy-CSP"><a href="#6-Content-Security-Policy-CSP" class="headerlink" title="6. Content Security Policy (CSP)"></a>6. Content Security Policy (CSP)</h2><h3 id="6-1-心得說明"><a href="#6-1-心得說明" class="headerlink" title="6.1. 心得說明"></a>6.1. 心得說明</h3><p>使用vscode的<code>Live Server</code>extension跑一個臨時起一個網站，這種方式設定CSP，瀏覽器的確會吃到這個設定，比方說<code>default-src &#39;none&#39;;</code>，網頁確實都沒有相關載入資源，但是去查看response header 卻看不出CSP的設定，而且在OWASP ZAP去attack這個<code>http://127.0.0.1:5502</code>網站，也是會回饋沒有設定CSP。</p>
<p>對照的另一個實驗是在客戶的伺服器上，使用的是IIS機器。如果有設定CSP的情況下，在response header就會有看到CSP的設定，在OWASP ZAP的掃描的確有掃到CSP，並且是alert另一種CSP的問題。</p>
<p>可能的狀況是HTTP、HTTPS的不同？ 有實體的IIS 與臨時的extension架站有實質上的差異？ 不過…都沒有關係，就先以客戶的https機器 + IIS 進行測試吧…。</p>
<p>PS：因為跑客戶的實體機一次掃描都太久了，所以在想有沒有更快的作法，比如先掃自己電腦架的網站(的確掃描速度非常快…但就是不太正常，alert 消不掉)。</p>
<h3 id="6-2-Content-Security-Policy-CSP-Header-Not-Set-風險：中"><a href="#6-2-Content-Security-Policy-CSP-Header-Not-Set-風險：中" class="headerlink" title="6.2. Content Security Policy(CSP) Header Not Set(風險：中)"></a>6.2. Content Security Policy(CSP) Header Not Set(風險：中)</h3><p><img src="https://i.imgur.com/rowqcEj.png" alt="image-20220619175219207"></p>
<h4 id="6-2-1-Description"><a href="#6-2-1-Description" class="headerlink" title="6.2.1. Description"></a>6.2.1. Description</h4><blockquote>
<p>Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross Site Scripting (XSS) and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. CSP provides a set of standard HTTP headers that allow website owners to declare approved sources of content that browsers should be allowed to load on that page — covered types are JavaScript, CSS, HTML frames, fonts, images and embeddable objects such as Java applets, ActiveX, audio and video files.</p>
</blockquote>
<h4 id="6-2-2-Solution"><a href="#6-2-2-Solution" class="headerlink" title="6.2.2. Solution"></a>6.2.2. Solution</h4><blockquote>
<p>Ensure that your web server, application server, load balancer, etc. is configured to set the Content-Security-Policy header, to achieve optimal browser support: “Content-Security-Policy” for Chrome 25+, Firefox 23+ and Safari 7+, “X-Content-Security-Policy” for Firefox 4.0+ and Internet Explorer 10+, and “X-WebKit-CSP” for Chrome 14+ and Safari 6+.</p>
</blockquote>
<h4 id="6-2-3-Before-response-header"><a href="#6-2-3-Before-response-header" class="headerlink" title="6.2.3. Before response header"></a>6.2.3. Before response header</h4><p><img src="https://i.imgur.com/rZXUZjv.png" alt="image-20220619180854290"></p>
<h4 id="6-2-4-解決方式"><a href="#6-2-4-解決方式" class="headerlink" title="6.2.4. 解決方式"></a>6.2.4. 解決方式</h4><p>加上<code>Content-Security-Policy</code>，參考如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27;;&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="6-2-5-After-response-header"><a href="#6-2-5-After-response-header" class="headerlink" title="6.2.5. After response header"></a>6.2.5. After response header</h4><p><img src="https://i.imgur.com/AqjZJbE.png" alt="image-20220619184257141"></p>
<h4 id="6-2-6-進行OWASP-ZAP-驗證"><a href="#6-2-6-進行OWASP-ZAP-驗證" class="headerlink" title="6.2.6. 進行OWASP ZAP 驗證"></a>6.2.6. 進行OWASP ZAP 驗證</h4><p><img src="https://i.imgur.com/ki8Pq9k.png" alt="image-20220619181157201"></p>
<h3 id="6-3-CSP-Wildcard-Directive-風險：中"><a href="#6-3-CSP-Wildcard-Directive-風險：中" class="headerlink" title="6.3. CSP:Wildcard Directive(風險：中)"></a>6.3. CSP:Wildcard Directive(風險：中)</h3><h4 id="6-3-1-Description"><a href="#6-3-1-Description" class="headerlink" title="6.3.1. Description"></a>6.3.1. Description</h4><blockquote>
<p>Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks. Including (but not limited to) Cross Site Scripting (XSS), and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. CSP provides a set of standard HTTP headers that allow website owners to declare approved sources of content that browsers should be allowed to load on that page — covered types are JavaScript, CSS, HTML frames, fonts, images and embeddable objects such as Java applets, ActiveX, audio and video files.</p>
</blockquote>
<h4 id="6-3-2-Other-Info"><a href="#6-3-2-Other-Info" class="headerlink" title="6.3.2. Other Info"></a>6.3.2. Other Info</h4><blockquote>
<p>The following directives either allow wildcard sources (or ancestors), are not defined, or are overly broadly defined:<br>frame-ancestors, form-action</p>
<p>The directive(s): frame-ancestors, form-action are among the directives that do not fallback to default-src, missing&#x2F;excluding them is the same as allowing anything.</p>
</blockquote>
<h4 id="6-3-3-Solution"><a href="#6-3-3-Solution" class="headerlink" title="6.3.3. Solution"></a>6.3.3. Solution</h4><blockquote>
<p>Ensure that your web server, application server, load balancer, etc. is properly configured to set the Content-Security-Policy header.</p>
</blockquote>
<h4 id="6-3-4-Before-response-header"><a href="#6-3-4-Before-response-header" class="headerlink" title="6.3.4. Before response header"></a>6.3.4. Before response header</h4><p><img src="https://i.imgur.com/XCXVNr2.png" alt="image-20220619184133110"></p>
<h4 id="6-3-5-解決方法"><a href="#6-3-5-解決方法" class="headerlink" title="6.3.5. 解決方法"></a>6.3.5. 解決方法</h4><p>在OWASP ZAP 的 other info 裡其實有提到 <code>frame-ancestors</code> <code>form-action</code> director，所以補上了這個兩個director：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27;; frame-ancestors &#x27;self&#x27;; form-action &#x27;self&#x27;&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span>	  	  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="6-3-6-After-response-header"><a href="#6-3-6-After-response-header" class="headerlink" title="6.3.6. After response header"></a>6.3.6. After response header</h4><p><img src="https://i.imgur.com/YIN41R0.png" alt="image-20220619184432581"></p>
<h4 id="6-3-7-進行OWASP-ZAP驗證"><a href="#6-3-7-進行OWASP-ZAP驗證" class="headerlink" title="6.3.7. 進行OWASP ZAP驗證"></a>6.3.7. 進行OWASP ZAP驗證</h4><p><img src="https://i.imgur.com/SdqCzFg.png" alt="image-20220619184451166"></p>
<h3 id="6-4-CSP-script-src-unsafe-inline-風險：中"><a href="#6-4-CSP-script-src-unsafe-inline-風險：中" class="headerlink" title="6.4. CSP: script-src unsafe-inline(風險：中)"></a>6.4. CSP: script-src unsafe-inline(風險：中)</h3><h4 id="6-4-1-Description"><a href="#6-4-1-Description" class="headerlink" title="6.4.1. Description"></a>6.4.1. Description</h4><blockquote>
<p>Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks. Including (but not limited to) Cross Site Scripting (XSS), and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. CSP provides a set of standard HTTP headers that allow website owners to declare approved sources of content that browsers should be allowed to load on that page — covered types are JavaScript, CSS, HTML frames, fonts, images and embeddable objects such as Java applets, ActiveX, audio and video files.</p>
</blockquote>
<h4 id="6-4-2-Other-Info"><a href="#6-4-2-Other-Info" class="headerlink" title="6.4.2. Other Info"></a>6.4.2. Other Info</h4><blockquote>
<p>script-src includes unsafe-inline.</p>
</blockquote>
<h4 id="6-4-3-Solution"><a href="#6-4-3-Solution" class="headerlink" title="6.4.3. Solution"></a>6.4.3. Solution</h4><blockquote>
<p>Ensure that your web server, application server, load balancer, etc. is properly configured to set the Content-Security-Policy header.</p>
</blockquote>
<p>Before response header</p>
<h4 id="6-4-4-解決方式"><a href="#6-4-4-解決方式" class="headerlink" title="6.4.4. 解決方式"></a>6.4.4. 解決方式</h4><p>在某一次的嘗試CSP設定為如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-inline&#x27;&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span>	</span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>當時還不是很懂隨便亂設定，讓OWASP ZAP 掃描，就發現了這個風險中的alert。解決方式很簡單，將<code>script-src</code>改為<code>self</code>就可以了：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span>	</span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除此之外，在程式的部分<strong>不能</strong>有類似<code>inline</code>JS的寫法，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:goTop()&quot;</span> <span class="attr">class</span>=<span class="string">&quot;fs-4 bg-secondary px-2&quot;</span> <span class="attr">title</span>=<span class="string">&quot;Go to top&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;go to top&quot;</span>&gt;</span>TOP<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;...</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這種JS寫法，必須移到<code>index.js</code>(舉例，可能是別的js名稱)裡面去定義相關的實作。</p>
<p>同樣的，在<code>style-src</code> 也有一樣<code>inline</code>的問題，我們來舉例個有問題的程式，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">accesskey</span>=<span class="string">&quot;M&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#M&quot;</span> <span class="attr">id</span>=<span class="string">&quot;MU&quot;</span> <span class="attr">class</span>=<span class="string">&quot;nav-link text-white pe-0 &quot;</span> <span class="attr">style</span>=<span class="string">&quot;vertical-align: bottom;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;相關連結區塊&quot;</span>&gt;</span>:::<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;banner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;img-fluid&quot;</span> <span class="attr">id</span>=<span class="string">&quot;banner01&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;banner01&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:1266px;&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;img-fluid&quot;</span> <span class="attr">id</span>=<span class="string">&quot;banner02&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./images/banner02.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;banner02&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:1266px;&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這種css寫法，必須移到<code>all.css</code>裡面去定義相關的實作。</p>
<h4 id="6-4-5-如果沒改會怎樣？"><a href="#6-4-5-如果沒改會怎樣？" class="headerlink" title="6.4.5. 如果沒改會怎樣？"></a>6.4.5. 如果沒改會怎樣？</h4><p>你會發現這定這樣的CSP規則，而程式卻沒有遵循，瀏覽器是會報錯的，並且網頁的LAYOUT會壞掉哦…(畫面就不方便截圖了)， 報錯畫面如下：</p>
<p><img src="https://i.imgur.com/bepCT9m.png" alt="image-20220619191312687"></p>
<h3 id="6-5-OWASP-ZAP-到這裡…就沒有alert了"><a href="#6-5-OWASP-ZAP-到這裡…就沒有alert了" class="headerlink" title="6.5. OWASP ZAP 到這裡…就沒有alert了"></a>6.5. OWASP ZAP 到這裡…就沒有alert了</h3><p>接下來後面的東西是為了加強資安進行的實驗，於是改了一下CSP設定：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span>	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;; style-src &#x27;self&#x27;; img-src &#x27;self&#x27;; connect-src &#x27;self&#x27;; object-src &#x27;none&#x27;; frame-src &#x27;self&#x27;; frame-ancestors &#x27;self&#x27;; form-action &#x27;self&#x27;; block-all-mixed-content; base-uri &#x27;self&#x27;&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Frame-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SAMEORIGIN&quot;</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span>	  </span><br><span class="line">	  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提供一個產生CSP規則的網站：<a target="_blank" rel="noopener" href="https://report-uri.com/home/generate">report-uri.com</a></p>
<h2 id="7-其它小筆記"><a href="#7-其它小筆記" class="headerlink" title="7. 其它小筆記"></a>7. 其它小筆記</h2><h3 id="7-1-chrome-extension-CSP-scanner"><a href="#7-1-chrome-extension-CSP-scanner" class="headerlink" title="7.1. chrome extension CSP scanner"></a>7.1. chrome extension CSP scanner</h3><p>這個工具還滿不錯的，可以針對CSP問題進行檢測，並且回饋您一些資訊與建議。最後在用OWASP ZAP 大部分時間都是在測試 CSP的問題，但是OWASP ZAP 是很全面的掃描，所以一輪下來都會花不少時間(2~5min)。這個工具就可以直接針對CSP 進行掃描。我猜想或許在OWASP ZAP 可以設定針對CSP掃描也說不定。</p>
<p><img src="https://i.imgur.com/GIRTOuZ.png" alt="image-20220619210152807"></p>
<p><img src="https://i.imgur.com/SITrgSd.png" alt="image-20220619204838625"></p>
<h3 id="7-2-IIS-的-web-config-的記錄"><a href="#7-2-IIS-的-web-config-的記錄" class="headerlink" title="7.2. IIS 的 web.config 的記錄"></a>7.2. IIS 的 web.config 的記錄</h3><p>太久沒玩web.config了，所以稍微記錄一下實驗心得，方便回憶。</p>
<p>放在某個專案底下的資料夾：</p>
<p><img src="https://i.imgur.com/7w8At1b.png" alt="image-20220618135856027"></p>
<p><code>web.config</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">staticContent</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">clientCache</span> <span class="attr">cacheControlMode</span>=<span class="string">&quot;DisableCache&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">staticContent</span>&gt;</span></span><br><span class="line">	  </span><br><span class="line">		<span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default-src &#x27;self&#x27; data:; img-src &#x27;self&#x27; data: ; script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27; www.google-analytics.com;&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span>	  </span><br><span class="line">	  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>改完通常不用重啟服務，就直接生效了(不管是在web.config 還是在 IIS 工具介面設定都一樣)</p>
<h2 id="8-備註"><a href="#8-備註" class="headerlink" title="8. 備註"></a>8. 備註</h2><p>寫一些有關文件</p>
<ol>
<li>SSH 、固定IP 在 IIS上設定的文件(複習)</li>
<li>site map .xml(複習)</li>
<li>robots(複習)</li>
<li>寫一個CSP相關概念文件</li>
</ol>
<h2 id="9-相關連結"><a href="#9-相關連結" class="headerlink" title="9. 相關連結"></a>9. 相關連結</h2><p><a target="_blank" rel="noopener" href="https://sdwh.dev/posts/2020/10/Cyber-Security-Web-Config-Configuration/">ASP.NET Web.config &amp; Http Headers 安全設定大全 (Guide to Secure your Web application by web.config configuration)</a></p>
<p>CSP Inline Styles</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://content-security-policy.com/examples/allow-inline-style/">CSP Inline Styles</a></li>
</ol>
<p>X-Content-Type-Options</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10273029">Day12-記得要戴安全帽（二）</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options">X-Content-Type-Options</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.zhangxinxu.com/wordpress/2018/08/css-svg-background-image-base64-encode/">学习了，CSS中内联SVG图片有比Base64更好的形式</a></p>
<p>SiteMap </p>
<p><a target="_blank" rel="noopener" href="https://www.da-vinci.com.tw/tw/blog/Sitemap">Sitemap是什麼？一次搞懂網站地圖提交</a></p>
<p><a target="_blank" rel="noopener" href="https://awoo.ai/zh-hant/blog/sitemap-xml/">sitemap.xml網站地圖是什麼？從工具&#x2F;產生器&#x2F;程式製作到進行提交教學</a></p>
<p>robots</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://welly.tw/serp-rank-optimization/how-to-use-or-check-robots.txt-and-meta-robots">robots.txt V.S. meta robots！SEO爬蟲溝通教學！</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/seo-day-1/%E6%92%B0%E5%AF%ABrobots-txt%E6%AA%94-%E8%AE%93%E7%88%AC%E8%9F%B2%E4%B9%96%E4%B9%96%E8%81%BD%E4%BD%A0%E7%9A%84%E8%A9%B1-8fa06b01fd59">撰寫robots.txt檔，讓爬蟲乖乖聽你的話</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yesharris.com/meta-robots-and-robots-txt/">三分鐘搞懂 SEO的《meta robots、robots.txt》</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.mxp.tw/9267/">[WordPress] 通過 OWASP ZAP 黑箱安全性檢測的幾個要點</a></p>
<p>Cache-Control</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://shunnien.github.io/2018/05/08/cache-control/">Cache-Control 在 IIS 上的設定</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yamab2b.com/how/368526.html">IIS的Connection由改為close改為Keep-Alive?</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10013447">不要把網頁 cache 起來的語法</a></li>
</ol>
<p>CSP 產生網站</p>
<p><a target="_blank" rel="noopener" href="https://report-uri.com/home/generate">https://report-uri.com/home/generate</a></p>
<p>CSP介紹</p>
<p><a target="_blank" rel="noopener" href="https://rainmakerho.github.io/2021/06/16/CSP-script-src-unsafe-inline/">CSP script-src unsafe-inline</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.bepsvpt.me/2020/11/25/introduction-to-content-security-policy/">淺談 Content Security Policy (CSP)</a></p>
<p><a target="_blank" rel="noopener" href="https://content-security-policy.com/">Content Security Policy Reference</a></p>
<p><a target="_blank" rel="noopener" href="https://iter01.com/524950.html">Content Security Policy</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/%E7%A8%8B%E5%BC%8F%E8%A3%A1%E6%9C%89%E8%9F%B2/content-security-policy-for-iis-c923e9f43c8a">Content Security Policy for IIS</a></p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@Eotones/BkOX6u5kX">Content Security Policy (CSP) 筆記</a></p>
<p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10223568">Web Security 魔法使攻略─嗑一下 CSP</a></p>
<p><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10224306">Web Security 魔法使攻略─CSP bypasss</a></p>
<p><a target="_blank" rel="noopener" href="https://csper.io/blog/an-introduction-to-report-uri">An Introduction To Report-URI</a></p>
<p><a target="_blank" rel="noopener" href="https://www.gushiciku.cn/pl/2UlJ/zh-tw">WEB應用內容安全策略(Content Security Policy)</a></p>
<p><a target="_blank" rel="noopener" href="https://itw01.com/NRWNEBR.html">【學習筆記】Content Security Policy 入門教程</a></p>
<p><a target="_blank" rel="noopener" href="https://devco.re/blog/2014/04/08/security-issues-of-http-headers-2-content-security-policy/">Content-Security-Policy - HTTP Headers 的資安議題 (2)</a></p>
<p>CSP 評估</p>
<p><a target="_blank" rel="noopener" href="https://csp-evaluator.withgoogle.com/">CSP Evaluator</a></p>
<p><a target="_blank" rel="noopener" href="https://rapidsec.com/resources/knowledge-base/6-common-web-application-client-side-vulnerabilities/#xss-cross-site-scripting">6 Common Web Application Client-side Vulnerabilities</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.darkthread.net/blog/applicationhost-config/">隨手記 - IIS &#x2F; IIS Express 伺服器 config 檔</a></p>
<p>X-Frame-Options </p>
<p>看這篇就對了-&gt;<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/X-Frame-Options">X-Frame-Options 回應標頭</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/04/29/2022-04-29%20%E7%B7%A8%E7%A2%BC%E6%AD%B7%E5%8F%B2%E6%95%B4%E5%90%88%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/29/2022-04-29%20%E7%B7%A8%E7%A2%BC%E6%AD%B7%E5%8F%B2%E6%95%B4%E5%90%88%E5%8C%85/" class="post-title-link" itemprop="url">編碼歷史</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-04-29 14:07:00" itemprop="dateCreated datePublished" datetime="2022-04-29T14:07:00+08:00">2022-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-06-18 11:17:18" itemprop="dateModified" datetime="2022-06-18T11:17:18+08:00">2022-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B7%A8%E7%A2%BC/" itemprop="url" rel="index"><span itemprop="name">編碼</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>21k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>38 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-名詞定義"><a href="#1-名詞定義" class="headerlink" title="1. 名詞定義"></a>1. 名詞定義</h2><h3 id="1-1-位元-bit"><a href="#1-1-位元-bit" class="headerlink" title="1.1. 位元 - bit"></a>1.1. 位元 - bit</h3><p><strong>位元</strong>（英語：Bit，亦稱<strong>二進制位</strong>）指<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%BF%9B%E5%88%B6">二進位</a>中的一位，是資訊的最小單位[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E4%BD%8D%E5%85%83#cite_note-1">1]</a>。<strong>Bit</strong>是<strong>Bi</strong>nary digi<strong>t</strong>（二進位數位）的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B7%B7%E6%88%90%E8%A9%9E">混成詞</a>，由數學家John Wilder Tukey提出可能是1946年提出，但有資料稱1943年就提出了）。這個術語第一次被正式使用，是在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%8B%E5%8A%B3%E5%BE%B7%C2%B7%E8%89%BE%E5%B0%94%E4%BC%8D%E5%BE%B7%C2%B7%E9%A6%99%E5%86%9C">香農</a>著名的論文《通信的數學理論》（A Mathematical Theory of Communication）第1頁中。</p>
<h3 id="1-2-位元組-字節-bytes"><a href="#1-2-位元組-字節-bytes" class="headerlink" title="1.2. 位元組(字節) - bytes"></a>1.2. 位元組(字節) - bytes</h3><p><strong>位元組</strong>（英語：Byte），通常用作<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E8%85%A6">電腦</a>及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%99%BA%E6%85%A7%E5%9E%8B%E6%89%8B%E6%A9%9F">手機</a>及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%99%BA%E6%85%A7%E5%9E%8B%E6%89%8B%E9%8C%B6">手錶</a>等 資訊計量單位，不分資料型態。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E5%AD%97%E8%8A%82#cite_note-Buchholz_1962-1">1]</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E5%AD%97%E8%8A%82#cite_note-Bemer_1959-2">2]</a> 是通信和資料儲存的概念。一個位元組代表八個<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%85%83">位元</a>。從歷史的觀點上，「位元組」表示用於編碼單個<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">字元</a>所需要的位元數量。歷史上位元組長度曾基於硬體為1-48位元不等，最初通常使用6位元或9位元為一位元組。今日標準以8位元作為一位元組，因8為<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E8%BF%9B%E5%88%B6">二進位</a>整數。</p>
<p>bit與byte示意圖：</p>
<p><img src="https://i.imgur.com/4hLOMRr.png" alt="bit &amp; byte"></p>
<h3 id="1-3-字元-字符-character"><a href="#1-3-字元-字符-character" class="headerlink" title="1.3. 字元(字符) - character"></a>1.3. 字元(字符) - character</h3><p>字元（character）是人類語文的最基本單位，例如：中文字、英文字母、阿拉伯數字、標點符號等。而字元集（character set）則是指某種語文的全部字元（例如：英文的字元）或部份字元（例如：中文的字元）所形成的集合</p>
<ul>
<li>圖形字元（graphic characters）<ul>
<li>指的是可以被顯示在螢光幕上或是被列印在報表紙上，用以構成文數字資訊或電腦語言的字元。就英文字元集而言，所包含的圖形字元為52個大小寫英文字母、10個阿拉伯數字和一些標點符號，總數還不到100個。但就中文字元集而言，所包含的圖形字元至少是成千上萬的中文字。</li>
</ul>
</li>
<li>控制字元（control characters）<ul>
<li>則代表特定的處理功能，可驅使電腦或通信設備執行特定程式，以進行特定處理或表現特定動作，例如：驅使螢光幕上的游標回到行首並換行、驅使印表機換行或跳頁、開始或終止資料的傳輸等。原則上，控制字元不具備可顯示或可列印的圖形。</li>
</ul>
</li>
</ul>
<h3 id="1-4-編碼"><a href="#1-4-編碼" class="headerlink" title="1.4. 編碼"></a>1.4. 編碼</h3><p>計算機中儲存的信息都是用二進制數表示的；而我們在屏幕上看到的英文、漢字等字符是二進制數轉換之後的結果。通俗的說，按照何種規則將字符存儲在計算機中，如<code>a</code>用什麼表示，稱為”編碼”；反之，將存儲在計算機中的二進制數解析顯示出來，稱為”解碼”，如同密碼學中的加密和解密。在解碼過程中，如果使用了錯誤的解碼規則，則導致<code>a</code>解析成<code>b</code>或者亂碼。</p>
<p><img src="https://i.imgur.com/aq6BpZr.png"></p>
<h4 id="1-4-1-字元集-字符集-characterset"><a href="#1-4-1-字元集-字符集-characterset" class="headerlink" title="1.4.1. 字元集(字符集) - characterset"></a>1.4.1. 字元集(字符集) - characterset</h4><p>是一個系統支持的所有抽象字符的集合。字符是各種文字和符號的總稱，包括各國家文字、標點符號、圖形符號、數字等。</p>
<p>一組由不同字元構成的有限集合，它對某些特定用途而言，被認為是完整而有意義的。在字元集中，每個字元均有不同的代碼，且所包括的字元數目是固定的。這些組合在一起的字元，有其唯一的表示形式及順序。例如ISO第646號標準「資訊互換用七數元碼字符集」、128個ASCII字元、CNS 11643「中文標準交換碼」等，都是一組有效字元使用於特定原因的字元集。</p>
<p>字符集：多個字符的集合。</p>
<p>字符集的目的是完成映射, 映射完成後二進制數就變成了新的字符</p>
<h4 id="1-4-2-字元編碼-字符編碼-Character-Encoding"><a href="#1-4-2-字元編碼-字符編碼-Character-Encoding" class="headerlink" title="1.4.2. 字元編碼(字符編碼) - Character Encoding"></a>1.4.2. 字元編碼(字符編碼) - Character Encoding</h4><p>是一套法則，使用該法則能夠對自然語言的字符的一個集合（如字母表或音節表），與其他東西的一個集合（如號碼或電脈衝）進行配對。即在符號集合與數字系統之間建立對應關係，它是信息處理的一項基本技術。通常人們用符號集合（一般情況下就是文字）來表達信息。而以計算機為基礎的信息處理系統則是利用元件（硬件）不同狀態的組合來存儲和處理信息的。元件不同狀態的組合能代表數字系統的數字，因此字符編碼就是將符號轉換為計算機可以接受的數字系統的數，稱為數字代碼。</p>
<p>常見字符集名稱：<code>ASCII</code>、<code>GB2312</code>、<code>BIG5</code>、<code>GB18030</code>、<code>Unicode</code>字符集等。計算機要準確的處理各種字符集文字，需要進行字符編碼，以便計算機能夠識別和存儲各種文字。</p>
<p>其實，在網頁上常見的寫法，我們也會發現<code>UTF-8</code>也常宣告在header中，告訴瀏覽器請以<code>UTF-8</code>編碼格式來閱讀這份文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-位元組順序記號-BOM"><a href="#1-5-位元組順序記號-BOM" class="headerlink" title="1.5. 位元組順序記號 (BOM)"></a>1.5. 位元組順序記號 (BOM)</h3><p>BIG-5、GBK、UTF-8 等編碼方式都是以單位元組為單位，所以沒有位元組順序的問題，不過 UTF-16 編碼是以兩個位元組為單位，所以需要知道資料使用的位元組順序才能解析資料。</p>
<p>Unocode 推薦判斷位元組順序的方式是 BOM (Byte Order Mark)，其原理是在位元組流的開頭使用 <code>FEFF</code> 字元來識別位元組順序，如果在文件開頭讀到 <code>FF</code> <code>FE</code> 就代表使用小端序，反之代表使用大端序。</p>
<p>有人一定會問，<code>FF</code> <code>FE</code> 有沒有可能是沒使用 BOM 的大端序中的 <code>FFFE</code> 這個字元，這個問題其實在設計 BOM 時已經有考慮進去了，在 Unocode 中確保 <code>FFFE</code> 不會被指定為字元，因此也不該出現在資料中，所以 <code>FF</code> <code>FE</code> 只能被解釋為小端序的 <code>FEFF</code>，不可能是大端序的 <code>FFFE</code>。</p>
<h3 id="1-6-代碼頁-Code-Page"><a href="#1-6-代碼頁-Code-Page" class="headerlink" title="1.6. 代碼頁 (Code Page)"></a>1.6. 代碼頁 (Code Page)</h3><p>代碼頁的用途是用來區分不同的字元集編碼，告訴系統該使用哪種方式來解析文字編碼，例如記事本讀到 <code>B1</code> <code>F0</code>，那麼到底該解釋為 GBK 的 “别” 字，還是 BIG5 的 “梗” 字，這兩個字的編碼都是 B1F0，在沒有指定編碼訊息的情況下，Windows 會使用預設的代碼頁來解析文字編碼，Windows 的代碼頁也被稱為 <code>ANSI</code> 代碼頁，在 Windows 上預設代碼頁不能直接修改，必須透過選擇系統的 Locale 間接改變代碼頁。</p>
<p>代碼頁也用於不同編碼之間的轉換，在 Windows 2000 之後，Windows 統一採用 UTF-16 作為系統內部的字元編碼，代碼頁其實就是一張各國文字編碼和 Unocode 的對應表，Windows 就是透過此表實現不同編碼間的轉換。</p>
<p>不知道大家有沒有試過在不同編碼的文件中使用複製貼上，大家一定都有做過，只是可能不會特別去注意文件的編碼是否相同，例如在 GBK 文件中將 “文” 複製貼上到 BIG5 文件中，如果系統只是複製字元的編碼 CEC4 的話，那麼貼過去後看到的應該是 “恅”，可是實際上看到的還是 “文”，所以很明顯系統在這之間做了轉碼的動作，先將 GBK 對應到 Unicode，再將 Unicode 對應到 BIG5，所以字才沒有跑掉，大家無聊可以去試試看。</p>
<p>大家可以再試試上面的 “别”，會發現貼過去怎麼變成了問號 <code>?</code>，為什麼沒有轉為繁體字 “別” 呢，因為在 Unicode 簡體字别和繁體字別其實是不同的兩個字，對應不同的碼位，所以無法直接轉換。那為什麼會變成問號呢，因為 BIG5 編碼中並沒有簡體字 “别”，系統在轉換的過程中，會將代碼頁對應不到的字用問號 <code>?</code> 取代，所以才會看到問號，而這個過程是不可逆的，轉換失敗後字碼就被改變了，無法再轉回原來的字。</p>
<h3 id="1-7-CMAP-表"><a href="#1-7-CMAP-表" class="headerlink" title="1.7. CMAP 表"></a>1.7. CMAP 表</h3><p>CMAP 表的功能是將 <code>字元編碼</code> 和 <code>字元點陣圖</code> 對應起來，透過此表字型檔才能將文字由字元編碼轉換為字型圖檔顯示在螢幕上，不過一張 CMAP 表只能對應一種編碼方式，如果需要字型檔支援不同的編碼方案就需要多張對應表，因此 CMAP 表可以包含多個子表，每個子表對應一種編碼方案，字型檔可透過多種支援的編碼方案來查表，可以是 Unicode 或其他 Code Page，不過這裡我還沒有更深入研究，目前還只會用 Unicode 來查表，未來有機會再嘗試更多的編碼方案。</p>
<p><img src="https://i.imgur.com/tfRSnCN.png" alt="img"></p>
<h2 id="2-編碼歷史概圖"><a href="#2-編碼歷史概圖" class="headerlink" title="2. 編碼歷史概圖"></a>2. 編碼歷史概圖</h2><p><img src="https://i.imgur.com/jeiEdzg.png" alt="encode.drawio"></p>
<h2 id="3-ASCII"><a href="#3-ASCII" class="headerlink" title="3. ASCII"></a>3. ASCII</h2><p>ASCII（American Standard Code for Information Interchange，美國信息交換標準代碼）是基於拉丁字母的一套電腦編碼系統。它主要用於顯示現代英語，而其擴展版本EASCII則可以勉強顯示其他西歐語言。它是現今最通用的單字節編碼系統，並等同於國際標準ISO。</p>
<h3 id="3-1-標準ASCII"><a href="#3-1-標準ASCII" class="headerlink" title="3.1. 標準ASCII"></a>3.1. 標準ASCII</h3><p>8位二進制中第一位(高位)一直為<code>0</code> 後面7位一共有2^7次, 128種不同的組合, 表示所有的大寫和小寫字母，數字0 到9、標點符號， 以及在美式英語中使用的特殊控制字符。</p>
<p><img src="https://i.imgur.com/xcZcCz4.png" alt="img"></p>
<ul>
<li>可顯示字元<ul>
<li>ASCII<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6">控制字元</a>的編號範圍是0-31和127（0x00-0x1F和0x7F），共33個字元。</li>
</ul>
</li>
<li>控制字元<ul>
<li>可顯示字元編號範圍是32-126（0x20-0x7E），共95個字元。</li>
</ul>
</li>
</ul>
<p>注意：在電腦的存儲單元中，一個ASCII碼值占一個位元組(8個二進位位元)，其最高位元(b7)用作奇偶校驗位。</p>
<p>所謂奇偶校驗，是指在代碼傳送過程中用來檢驗是否出現錯誤的一種方法，一般分奇校驗和偶校驗兩種。</p>
<p>奇校驗規定：正確的代碼一個位元組中1的個數必須是奇數，若非奇數，則在最高位b7添1；偶校驗規定：正確的代碼一個位元組中1的個數必須是偶數，若非偶數，則在最高位b7添1。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/ASCII">參考連結：wiki ASCII</a></p>
<h3 id="3-2-擴展ASCII-EASCII-Extended-ASCII"><a href="#3-2-擴展ASCII-EASCII-Extended-ASCII" class="headerlink" title="3.2. 擴展ASCII - EASCII(Extended ASCII)"></a>3.2. 擴展ASCII - EASCII(Extended ASCII)</h3><p><strong>EASCII</strong>（<strong>Extended ASCII</strong>，延伸美國標準資訊交換碼）是將<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ASCII">ASCII</a>碼由7<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D">位</a>擴充為8位元而成。EASCII的內碼是由0到255共有256個字元組成。EASCII碼比ASCII碼擴充出來的符號包括表格符號、計算符號、希臘字母和特殊的拉丁符號。</p>
<p>標準ASCII碼在美國使用基本沒問題,但是一旦推廣到其它國家, 他們有屬於自己的字母和符號, 現有的符號無法滿足需求, 因此其它國家就將8位二進制的第一位置位1, 然後用擴展出來的128種組合, 作為自己國家特殊符號的表示.</p>
<p>比如，法語中的<code>é</code>的編碼為130（二進制10000010）。這樣一來，這些歐洲國家使用的編碼體系，可以表示最多256個符號。</p>
<p>但是，這裡又出現了新的問題。不同的國家有不同的字母，因此，哪怕它們都使用256個符號的編碼方式，代表的字母卻不一樣。比如，130在法語編碼中代表了<code>é</code>，在希伯來語編碼中卻代表了字母<code>Gimel (ג)</code>，在俄語編碼中又會代表另一個符號。但是不管怎樣，所有這些編碼方式中，0–127表示的符號是一樣的，不一樣的只是128–255的這一段。</p>
<p>至於亞洲國家的文字，使用的符號就更多了，漢字就多達10萬左右。一個字節只能表示256種符號，肯定是不夠的，就必須使用多個字節表達一個符號。比如，簡體中文常見的編碼方式是 GB2312，使用兩個字節表示一個漢字，所以理論上最多可以表示 256 x 256 &#x3D; 65536 個符號。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/EASCII">參考連結：wiki EASCII</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">參考連結：字符编码笔记：ASCII，Unicode 和 UTF-8</a></p>
<h2 id="4-GB家族"><a href="#4-GB家族" class="headerlink" title="4. GB家族"></a>4. GB家族</h2><p>中國設計了GB系列編碼(“GB”為“國標”的漢語拼音首字母縮寫，即“國家標準”之意)。</p>
<h3 id="4-1-GB2312"><a href="#4-1-GB2312" class="headerlink" title="4.1. GB2312"></a>4.1. GB2312</h3><p>計算機發展的很迅速，很快傳入了亞洲，傳入了中國。中國的文字博大精深，光常用的漢字就多達幾千個，ASCII和ISO-8859顯然都是不適用的。所以聰明的中國人想到了一個辦法：用2個字節表示一個漢字。我們知道ASCII但是單字節的，1個字節可以表示256個字符，那兩個字節就可以表示256*256&#x3D; 65536個漢字，這就基本可以滿足我們了，這就是最早的GB2312編碼。</p>
<p>GB2312中收錄了大概有7000個漢字，同時收錄了拉丁字母、希臘字母、日文平假名及片假名字母、俄語西里爾字母在內的 682 個字符。</p>
<h3 id="4-2-GBK"><a href="#4-2-GBK" class="headerlink" title="4.2. GBK"></a>4.2. GBK</h3><p>但是隨著的問題有出現了。在GB2312使用的過程中發現一些生僻字無法處理，所以就出現了GBK。GBK設計兼容GB2312的，收錄了2萬多的漢字和圖形符號。</p>
<h3 id="4-3-GB18030"><a href="#4-3-GB18030" class="headerlink" title="4.3. GB18030"></a>4.3. GB18030</h3><p>為了進一步擴展編碼所能表示更多的漢字。信息產業部和國家質量技術監督局在2000年發布了GB 18030。GB 18030總共收錄了7萬多漢字，並且兼容GBK和GB2312。到這裡中國基本所有的漢字就可以在計算機中表示了。</p>
<h2 id="5-BIG5"><a href="#5-BIG5" class="headerlink" title="5. BIG5"></a>5. BIG5</h2><p><strong>大五碼</strong>（英語：Big5，又稱為<strong>五大碼</strong>）是使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B9%81%E4%BD%93%E4%B8%AD%E6%96%87">繁體中文</a>（正體中文）社群中最常用的電腦<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B1%89%E5%AD%97">漢字</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E9%9B%86">字元集</a>標準，共收錄13,060個漢字[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%A7%E4%BA%94%E7%A2%BC#cite_note-1">1]</a>。</p>
<p>中文碼分為<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%A7%E7%A2%BC">內碼</a>及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%A4%E6%8F%9B%E7%A2%BC">交換碼</a>兩類，Big5屬中文內碼，知名的中文交換碼有<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/CCCII">CCCII</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/CNS11643">CNS11643</a>。</p>
<p>Big5雖普及於<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%B0%E7%81%A3">台灣</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%A6%99%E6%B8%AF">香港</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%BE%B3%E9%96%80">澳門</a>等繁體中文區域，但長期以來並非當地的國家&#x2F;地區標準或官方標準，而只是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%A5%AD%E7%95%8C%E6%A8%99%E6%BA%96">業界標準</a>。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%80%9A%E5%A4%A9%E4%B8%AD%E6%96%87%E7%B3%BB%E7%B5%B1">倚天中文系統</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Windows">Windows</a>繁體中文版等主要作業系統的字元集都是以Big5為基準，但廠商又各自增加不同的造字與造字區，衍生成多種不同版本。</p>
<p><strong>五大中文套裝軟體</strong>，即<strong>Big-5</strong>軟體，是1984年由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E8%8F%AF%E6%B0%91%E5%9C%8B">中華民國</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B3%87%E8%A8%8A%E5%B7%A5%E6%A5%AD%E7%AD%96%E9%80%B2%E6%9C%83">財團法人資訊工業策進會</a>與<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%B0%E7%81%A3">台灣</a>國內13家廠商合作進行「五大軟體專案」，所開發出來的五種中文套裝軟體，分別為「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%96%87%E6%9B%B8%E8%99%95%E7%90%86">文書處理</a>」、「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%BA%AB">資料庫</a>」、「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A9%A6%E7%AE%97%E8%A1%A8">試算表</a>」、「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%80%9A%E8%A8%8A">通訊</a>」及「<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E7%B9%AA%E5%9C%96&action=edit&redlink=1">繪圖</a>」。</p>
<p>Big5碼的產生，是因為當時<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%80%8B%E4%BA%BA%E9%9B%BB%E8%85%A6">個人電腦</a>沒有共通的內碼，導致廠商推出的中文應用軟體無法推廣，並且與<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/IBM_5550">IBM 5550</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E7%8E%8B%E5%AE%89%E7%A2%BC&action=edit&redlink=1">王安碼</a>等內碼，彼此不能相容；另一方面，台灣當時尚未推出中文編碼標準。在這樣的時空背景下，為了使台灣早日進入資訊時代，所採行的一個計畫；同時，這個計畫對於以台灣為核心的亞洲繁體漢字圈也產生了久遠的影響。</p>
<h2 id="6-ANSI"><a href="#6-ANSI" class="headerlink" title="6. ANSI"></a>6. ANSI</h2><p>ANSI指American National Standards Institute（美國國家標準學會）。</p>
<p>在全世界所有國家和民族的文字符號統一編碼的Unicode編碼方案問世之前，各個國家、民族為了用計算機記錄並顯示自己的字符，都在ASCII編碼方案的基礎上，設計了各自的編碼方案。</p>
<p>比如歐洲先後設計了EASCII和ISO&#x2F;IEC 8859系列字符編碼方案；為了顯示中文及相關字符，中國設計了GB系列編碼(“GB”為“國標”的漢語拼音首字母縮寫，即“國家標準”之意)。</p>
<p>同樣，日文、韓文、世界各國文字都有它們各自的編碼。所有這些各個國家和地區所獨立制定的既兼容ASCII又互相不兼容的字符編碼，微軟統稱為ANSI編碼。</p>
<p>ANSI編碼不是一種具體的編碼方式，而是一種指定在某些環境下使用某些編碼方式的標準。比如，在中文環境中ANSI的編碼標準為GBK，在日語環境中ANSI的編碼標準則是Shift_JIS編碼。</p>
<p>不同的國家和地區製定了不同的標準，由此產生了 GB2312、GBK、Big5、Shift_JIS 等各自的編碼標準。這些使用 1 至 4 個字節來代表一個字符的各種漢字延伸編碼方式，稱為 ANSI 編碼。在簡體中文Windows操作系統中，ANSI 編碼代表 GBK 編碼；在日文Windows操作系統中，ANSI 編碼代表 Shift_JIS 編碼。 “ANSI編碼”被稱為“本地編碼”。</p>
<p>ANSI另外一個名稱是MBCS，MBCS(Multi-Byte Character Set)是多字節編碼的統稱。目前為止大家都是用了雙字節，所以有時候也叫做DBCS(Double-Byte Character Set)。必須明確的是，MBCS並不是某一種特定的編碼，Windows裡根據你設定的區域不同，MBCS指代不同的編碼，而Linux裡無法使用MBCS作為編碼。在Windows中你看不到MBCS這幾個字符，因為微軟為了更加洋氣，使用了ANSI來嚇唬人，記事本的另存為對話框裡編碼ANSI就是MBCS。</p>
<h3 id="6-1-實驗ANSI編碼"><a href="#6-1-實驗ANSI編碼" class="headerlink" title="6.1. 實驗ANSI編碼"></a>6.1. 實驗ANSI編碼</h3><p>用Notepad++創建一個文本文件text.txt，其默認編碼格式為ANSI（乍看之下，還以為是ASCII呢），輸入漢字居然不是亂碼：<br><img src="https://i.imgur.com/13Cbivx.png" alt="img"></p>
<p>保存為test.txt，發送給你美國的同事Bob。他也用Notepad++，不幸的是，卻發現你的文件內容是這樣的：<br><img src="https://i.imgur.com/DFD6Hxw.png" alt="img"></p>
<p>也許你會認為：你用的是中文系統，能正常顯示中文；他用的是英文系統，不能顯示中文！</p>
<p>這麼想，好像很有道理呢！</p>
<p>但是再細想一下：<strong>一個系統顯示亂碼，說明它不支持這種編碼格式（或者解碼方式不對）。難道英文系統不支持ANSI？難道ANSI是一種中文編碼？</strong></p>
<p>如果你身邊有一個韓文系統，也裝一個Notepad++，默認還是ANSI編碼，你可以輸入“한국어”，發現也能正常顯示：<br><img src="https://i.imgur.com/X7xgkAv.png" alt="img"><br>但是你要輸入“漢字”可能就會發現是亂碼了…</p>
<p>通過這個反例，就可以說明<strong>ANSI不是一種中文編碼。那麼，ANSI到底是什麼編碼？</strong></p>
<p>用十六進制編輯器打開內容為“漢字”的test.txt文件，你會發現其中baba和d7d6正好是“漢”和“字”兩個字的<a target="_blank" rel="noopener" href="http://www.qqxiuzi.cn/zh/hanzi-gbk-bianma.php">GBK編碼</a>值。<br><img src="https://i.imgur.com/plzhK8L.png" alt="img"></p>
<p>同樣，用十六進制編輯器打開內容為“한국어”的test.txt文件，你會發現其中c7d1、b1b9和beee正好是“한”、“국”和“어”三個字符的<a target="_blank" rel="noopener" href="http://www.chi2ko.com/jingyan/euckr2uni.htm">EUC-KR編碼</a>值。<br><img src="https://i.imgur.com/6HdhF9f.png" alt="img"></p>
<p>由此可以看出：其實ANSI並不是某一種特定的字符編碼，而是在不同的系統中，ANSI表示不同的編碼。你的美國同事Bob的系統中ANSI編碼其實是ASCII編碼（ASCII編碼不能表示漢字，所以漢字為亂碼），而你的系統中（“漢字”正常顯示）ANSI編碼其實是GBK編碼，而韓文系統中（“한국어”正常顯示）ANSI編碼其實是EUC-KR編碼。</p>
<h3 id="6-2-Windows系統是如何區分ANSI背後的真實編碼的呢？"><a href="#6-2-Windows系統是如何區分ANSI背後的真實編碼的呢？" class="headerlink" title="6.2. Windows系統是如何區分ANSI背後的真實編碼的呢？"></a>6.2. Windows系統是如何區分ANSI背後的真實編碼的呢？</h3><p>微軟用一個叫“ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Code_page">Windows code pages</a> ”（在命令行下執行chcp命令可以查看當前code page的值）的值來判斷系統默認編碼，比如：簡體中文的code page值為936（它表示GBK編碼，win95之前表示GB2312，詳見：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Code_page_1386">Microsoft Windows’ Code Page 936</a>），繁體中文的code page值為950（表示Big-5編碼）。</p>
<h3 id="6-3-通過修改Windows-code-pages的值來改變“ANSI編碼”"><a href="#6-3-通過修改Windows-code-pages的值來改變“ANSI編碼”" class="headerlink" title="6.3. 通過修改Windows code pages的值來改變“ANSI編碼”"></a>6.3. 通過修改Windows code pages的值來改變“ANSI編碼”</h3><p>命令提示符下，我們可以通過chcp命令來修改當前終端的active code page，例如：<br>(1) 執行：chcp 437，code page改為437，當前終端的默認編碼就為ASCII編碼了（漢字就成亂碼了）；<br>(2) 執行：chcp 936，code page改為936，當前終端的默認編碼就為GBK編碼了（漢字又能正常顯示了）。<br>上面的操作只在當前終端起作用，並不會影響系統默認的“ANSI編碼”。（更改命令行默認codepage參看：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/SunWentao/archive/2010/05/26/1744382.html">設置cmd的codepage的方法</a>）。</p>
<p>Windows下code page是根據當前系統區域（locale）來設置的，要想修改系統默認的“ANSI編碼”，我們可以通過修改系統區域來實現（“控制面板” &#x3D;&gt;“時鐘、語言和區域”&#x3D;&gt;“區域和語言”&#x3D;&gt;“管理”&#x3D;&gt;“更改系統區域設置…”）：<br><img src="https://i.imgur.com/QOuL8CU.png" alt="img"><br>圖中的系統locale為簡體中文，意味著當前“ANSI編碼”實際是GBK編碼。當你把它改成Korean(Korea)時，“ANSI編碼”實際是EUC-KR編碼，“한국어”就能正常顯示了；當你把它改成English(US)時，“ANSI編碼”實際是ASCII編碼，“漢字”和“한국어”都成亂碼了。（改了之後需要重啟系統的。。。）</p>
<p>說明：locale是國際化與本地化中重要的概念，本文不深入講解該內容。</p>
<p>常見編碼：</p>
<p>codepage&#x3D;936 簡體中文GBK<br>codepage&#x3D;950 繁體中文BIG5<br>codepage&#x3D;437 美國&#x2F;加拿大英語<br>codepage&#x3D;932 日文<br>codepage&#x3D;949 韓文<br>codepage&#x3D;866 俄文</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/malecrab/p/5300486.html">參考連結：ANSI是什麼編碼？</a></p>
<h2 id="7-UNICODE"><a href="#7-UNICODE" class="headerlink" title="7. UNICODE"></a>7. UNICODE</h2><p>由於 ASCII 只能儲存最多 256 種組合，顯然對於多國語系來說相當不夠，因此出現 <strong>Unicode</strong>。</p>
<p>Unicode字碼表（Unicode characters）收集了大量的Unicode字符代碼，以表格形式呈現。Unicode（統一碼、萬國碼、單一碼）是電腦科學領域裡的一項業界標準，包括字符集(字元集)、編碼方案等。Unicode 是為了解決傳統的字元編碼方案的局限而產生的，它為每種語言中的每個字元設定了統一，併且唯一的二進制編碼，以滿足跨語言、跨平台進行文本轉換、處理的要求。1990年開始研發，1994年正式公佈。</p>
<p><strong>Unicode 就像一個資料庫，每一個文字符號（symbol）都可以對應到一組數字</strong>。</p>
<p>在 Unicode 中常用 <code>U+&lt;hex&gt;</code> 表示，<code>U+</code> 後面的 16 進制數就叫「<strong>碼點（Code Point）」</strong>或「<strong>編碼位置</strong>」。<strong>這個編碼位置是唯一的</strong>。透過這種方式可以簡單的存取特定文字符號而不用直接輸入符號本身，例如，<code>U+0000</code> 則碼點為 <code>0000</code>。</p>
<h3 id="7-1-基本平面和輔助平面（BMP-and-SMP）"><a href="#7-1-基本平面和輔助平面（BMP-and-SMP）" class="headerlink" title="7.1. 基本平面和輔助平面（BMP and SMP）"></a>7.1. 基本平面和輔助平面（BMP and SMP）</h3><p>Unicode 編碼範圍從  <code>U+0000</code> 到  <code>U+10FFFF</code> 超過 110 萬個符號。</p>
<p><strong>基本平面</strong>（BMP, Basic Multilingual Plane）：<strong>由兩個位元組組成</strong>，是 Unicode 中最前面的 65536 個文字符號，寫成 16 進制就是從<code>U+0000</code> 到 <code>U+FFFF</code>。所有最常見的字符都放在這個平面，這是 Unicode 最先定義和公佈的一個平面。</p>
<p><strong>輔助平面</strong>（SMP, Supplementary planes or Astral planes）：<strong>由三個位元組組成</strong>，除了基本平面外，剩下的文字符號都放在輔助平面，碼點範圍從 <code>U+010000</code> 一直到 <code>U+10FFFF</code>，如果某個字符需要超過 4 位數的 16 進制來表示那它就屬於輔助平面。</p>
<p>目前的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode">Unicode</a>字元分為17組編排，每組稱為<strong>平面</strong>（Plane），而每平面擁有65536（即216）個代碼點。然而目前只用了少數平面。</p>
<p><img src="https://i.imgur.com/OyuPCqM.png" alt="3330817-c188b53396c14318"></p>
<table>
<thead>
<tr>
<th align="center">平面</th>
<th align="center">始末字元值</th>
<th align="center">中文名稱</th>
<th align="center">英文名稱</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0號平面</td>
<td align="center">U+0000 - U+FFFF</td>
<td align="center"><strong>基本多文種平面</strong></td>
<td align="center">Basic Multilingual Plane，簡稱<strong>BMP</strong></td>
</tr>
<tr>
<td align="center">1號平面</td>
<td align="center">U+10000 - U+1FFFF</td>
<td align="center"><strong>多文種補充平面</strong></td>
<td align="center">Supplementary Multilingual Plane，簡稱<strong>SMP</strong></td>
</tr>
<tr>
<td align="center">2號平面</td>
<td align="center">U+20000 - U+2FFFF</td>
<td align="center"><strong>表意文字補充平面</strong></td>
<td align="center">Supplementary Ideographic Plane，簡稱<strong>SIP</strong></td>
</tr>
<tr>
<td align="center">3號平面</td>
<td align="center">U+30000 - U+3FFFF</td>
<td align="center"><strong>表意文字第三平面</strong></td>
<td align="center">Tertiary Ideographic Plane，簡稱<strong>TIP</strong></td>
</tr>
<tr>
<td align="center">4號平面 至 13號平面</td>
<td align="center">U+40000 - U+DFFFF</td>
<td align="center">（尚未使用）</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">14號平面</td>
<td align="center">U+E0000 - U+EFFFF</td>
<td align="center"><strong>特別用途補充平面</strong></td>
<td align="center">Supplementary Special-purpose Plane，簡稱<strong>SSP</strong></td>
</tr>
<tr>
<td align="center">15號平面</td>
<td align="center">U+F0000 - U+FFFFF</td>
<td align="center">保留作為<strong>私人使用區（A區）</strong>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84#cite_note-PUA-1">1]</a></td>
<td align="center">Private Use Area-A，簡稱<strong>PUA-A</strong></td>
</tr>
<tr>
<td align="center">16號平面</td>
<td align="center">U+100000 - U+10FFFF</td>
<td align="center">保留作為<strong>私人使用區（B區）</strong>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84#cite_note-PUA-1">1]</a></td>
<td align="center">Private Use Area-B，簡稱<strong>PUA-B</strong></td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%B9%B3%E9%9D%A2%E6%98%A0%E5%B0%84">參考連結：Unicode字元平面對映</a></p>
<h3 id="7-2-Unicode和Unicode-big-endian有什麼區別？"><a href="#7-2-Unicode和Unicode-big-endian有什麼區別？" class="headerlink" title="7.2. Unicode和Unicode big endian有什麼區別？"></a>7.2. Unicode和Unicode big endian有什麼區別？</h3><h4 id="7-2-1-位元組順序"><a href="#7-2-1-位元組順序" class="headerlink" title="7.2.1. 位元組順序"></a>7.2.1. 位元組順序</h4><p>學過組語的大大們應該很了解，不同 CPU 在處理多位元資料型態時，暫存器和記憶體存放資料的方式有兩種大端序 (big-endian) 和小端序 (little-endian)。 </p>
<ul>
<li><p>大端序會將資料的高位位元組儲存在記憶體的低位地址。 </p>
</li>
<li><p>小端序會將資料的低位位元組儲存在記憶體的低位地址。</p>
</li>
</ul>
<p>例如 “字” 的 Unicode 是 5B57，5B 為高位位元組，57 為低為位元位，如果開啟記事本後讀取到的順序是 5B 57，就是使用大端序儲存，反之就是小端序。</p>
<p>像我第一次在 C# 將 string 轉成 hex 時就覺得很困惑，為什麼 Unicode 是 5B57，而我看到的卻是 575B，後來才知道是因為 C# 和 C++ 一樣，位元組順序會隨著 CPU 架構而不同，在 Intel x86 x64 架構下會採用小端序，所以才會看到低位地址57放在前面，而 JAVA 因為 JVM 的原因沒有這種差異，都是採用大端序。 </p>
<p>主機間不同的位元組順序，會造成網路通訊的困難，因此 TCP&#x2F;IP 協議也規範了統一的位元組順序 網絡位元組序，採用大端序，大部分的網路協定也都是使用大端序。</p>
<p>不同的計算機系統會以不同的順序保存字節。這意味著字符U+4E2D在UTF-16編碼方式下可能被保存為4E 2D或者2D 4E，這取決於該系統使用的是大尾端(big-endian)還是小尾端(little-endian)。 （對於UTF-32編碼方式，則有更多種可能的字節排列。）只要文檔沒有離開你的計算機，它還是安全的——同一台電腦上的不同程序使用相同的字節順序(byte order)。但是當我們需要在系統之間傳輸這個文檔的時候，也許在萬維網中，我們就需要一種方法來指示當前我們的字節是怎樣存儲的。不然的話，接收文檔的計算機就無法知道這兩個字節4E 2D表達的到底是U+4E2D還是U+2D4E。</p>
<p><img src="https://i.imgur.com/8PJdxGO.png" alt="img"></p>
<h4 id="7-2-2-大端序（英：big-endian）"><a href="#7-2-2-大端序（英：big-endian）" class="headerlink" title="7.2.2. 大端序（英：big-endian）"></a>7.2.2. 大端序（英：big-endian）</h4><ul>
<li>數據以8bit為單位：地址增長方向 → 0x0A 0x0B 0x0C 0x0D</li>
<li>示例中，最高位字節是0x0A 存儲在最低的內存地址處。下一個字節0x0B存在後面的地址處。正類似於十六進製字節從左到右的閱讀順序。</li>
<li>數據以16bit為單位: 地址增長方向 → 0x0A0B 0x0C0D</li>
<li>最高的16bit單元0x0A0B存儲在低位。</li>
</ul>
<h4 id="7-2-3-小端序（英：little-endian）"><a href="#7-2-3-小端序（英：little-endian）" class="headerlink" title="7.2.3. 小端序（英：little-endian）"></a>7.2.3. 小端序（英：little-endian）</h4><ul>
<li>數據以8bit為單位: 地址增長方向 → 0x0D 0x0C 0x0B 0x0A</li>
<li>最低位字節是0x0D 存儲在最低的內存地址處。後面字節依次存在後面的地址處。</li>
<li>數據以16bit為單位: 地址增長方向 → 0x0C0D 0x0A0B</li>
<li>最低的16bit單元0x0D0C存儲在低位。</li>
</ul>
<p>以漢字<code>严</code>為例，Unicode碼是<code>4E25</code>，需要用兩個字節存儲，一個字節是4E，另一個字節是25。</p>
<p>存儲的時候，4E在前，25在後，就是Big endian方式(也就是<code>4E25</code>)；25在前，4E在後，就是Little endian方式(也就是<code>254E</code>)。</p>
<p>Unicode規範中定義，每一個文件的最前面分別加入一個表示編碼順序的字符，這個字符的名字叫做”零寬度非換行空格”（Zero Width No-Break Space），用FEFF表示。這正好是兩個字節，而且FF比FE大1。</p>
<p>如果一個文本文件的頭兩個字節是FE FF，就表示該文件採用大頭方式；如果頭兩個字節是FF FE，就表示該文件採用小頭方式。</p>
<ul>
<li>Unicode：編碼是四個字節”FF FE 25 4E”，其中”FF FE”表明是小頭方式存儲，真正的編碼是4E25。</li>
<li>Unicode big endian：編碼是四個字節”FE FF 4E 25″，其中”FE FF”表明是大頭方式存儲。</li>
</ul>
<h3 id="7-3-Unicode-版本"><a href="#7-3-Unicode-版本" class="headerlink" title="7.3. Unicode 版本"></a>7.3. Unicode 版本</h3><table>
<thead>
<tr>
<th align="center">版本</th>
<th align="center">發布日期</th>
<th align="center">書籍</th>
<th align="center">對應<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E5%AD%97%E7%AC%A6%E9%9B%86">ISO&#x2F;IEC 10646</a>版本</th>
<th align="center">文字數</th>
<th align="center">字元數</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">總計[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-9">註 1]</a></td>
<td align="center">已知的擴增</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td></td>
</tr>
<tr>
<td align="center">1.0.0</td>
<td align="center">1991年10月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-201-56788-1">0-201-56788-1</a>（Vol. 1）</td>
<td align="center"></td>
<td align="center">24</td>
<td align="center">7,161</td>
<td>最初包含的文字有：<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%98%BF%E6%8B%89%E4%BC%AF%E5%AD%97%E6%AF%8D">阿拉伯字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BA%9E%E7%BE%8E%E5%B0%BC%E4%BA%9E%E5%AD%97%E6%AF%8D">亞美尼亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%AD%9F%E5%8A%A0%E6%8B%89%E6%96%87">孟加拉文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B3%A8%E9%9F%B3%E7%AC%A6%E8%99%9F">注音符號</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%A5%BF%E9%87%8C%E7%88%BE%E5%AD%97%E6%AF%8D">西里爾字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A4%A9%E5%9F%8E%E6%96%87">天城文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%A0%BC%E9%B2%81%E5%90%89%E4%BA%9A%E5%AD%97%E6%AF%8D">喬治亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B8%8C%E8%87%98%E5%AD%97%E6%AF%8D">希臘字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E5%90%89%E6%8B%89%E7%89%B9%E6%96%87">古吉拉特文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E6%9C%A8%E5%9F%BA%E6%96%87">古木基文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%AB%BA%E6%96%87">諺文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B8%8C%E4%BC%AF%E4%BE%86%E5%AD%97%E6%AF%8D">希伯來字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B9%B3%E5%81%87%E5%90%8D">平假名</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%A1%E7%B4%8D%E9%81%94%E6%96%87">卡納達文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%89%87%E5%81%87%E5%90%8D">片假名</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%AF%AE%E6%96%87%E5%AD%97">寮文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%8B%89%E4%B8%81%E5%AD%97%E6%AF%8D">拉丁字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%A6%AC%E6%8B%89%E9%9B%85%E6%8B%89%E5%A7%86%E6%96%87">馬拉雅拉姆文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A5%A7%E9%87%8C%E4%BA%9E%E6%96%87">奧里亞文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B3%B0%E7%B1%B3%E7%88%BE%E6%96%87">泰米爾文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B3%B0%E5%8D%A2%E5%9B%BA%E6%96%87">泰盧固文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B3%B0%E6%96%87%E5%AD%97">泰文字</a>與<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%97%8F%E6%96%87">藏文</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-10">9]</a>。</td>
</tr>
<tr>
<td align="center">1.0.1</td>
<td align="center">1992年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-201-60845-6">0-201-60845-6</a>（Vol. 2）</td>
<td align="center"></td>
<td align="center">25</td>
<td align="center">28,359</td>
<td>定義<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>最初的20,902個字[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-11">10]</a>。</td>
</tr>
<tr>
<td align="center">1.1</td>
<td align="center">1993年6月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646-1:1993</td>
<td align="center">24</td>
<td align="center">34,233</td>
<td>於原有2,350個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%AB%BA%E6%96%87">諺文</a>字母的基礎上新增4,306個諺文字母。移除<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%97%8F%E6%96%87">藏文</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-12">11]</a>。</td>
</tr>
<tr>
<td align="center">2.0</td>
<td align="center">1996年7月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-201-48345-9">0-201-48345-9</a></td>
<td align="center">ISO&#x2F;IEC 10646-1:1993與其第5－7修訂版</td>
<td align="center">25</td>
<td align="center">38,950</td>
<td>移除原有的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%AB%BA%E6%96%87">諺文</a>字母設定，於新的編碼範圍更換成11,172個新的諺文字母。<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%97%8F%E6%96%87">藏文</a>重新加入，但編碼位置更換。代理字元機制建立，並將第15與第16平面分配給私人使用區[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-13">12]</a>。</td>
</tr>
<tr>
<td align="center">2.1</td>
<td align="center">1998年5月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646-1:1993與其第5－7修訂版，以及第18修訂版中新增的2個字元</td>
<td align="center">25</td>
<td align="center">38,952</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%AD%90%E5%85%83%E7%AC%A6%E8%99%9F">歐元符號</a>與<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%AF%B9%E8%B1%A1%E6%9B%BF%E6%8D%A2%E5%AD%97%E7%AC%A6&action=edit&redlink=1">物件替換字元</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-14">13]</a>。</td>
</tr>
<tr>
<td align="center">3.0</td>
<td align="center">1999年9月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-201-61633-5">0-201-61633-5</a></td>
<td align="center">ISO&#x2F;IEC 10646-1:2000</td>
<td align="center">38</td>
<td align="center">49,259</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%88%87%E7%BD%97%E5%9F%BA%E6%96%87">切羅基文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%90%89%E8%8C%B2%E5%AD%97%E6%AF%8D">吉茲字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%AB%98%E6%A3%89%E5%AD%97%E6%AF%8D">高棉字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%92%99%E5%8F%A4%E5%AD%97%E6%AF%8D">蒙古字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BC%85%E6%96%87">緬文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%AD%90%E7%94%98%E5%AD%97%E6%AF%8D">歐甘字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%A2%E6%81%A9%E5%AD%97%E6%AF%8D">盧恩字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%83%A7%E4%BC%BD%E7%BE%85%E6%96%87">僧伽羅文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%95%98%E5%88%A9%E4%BA%9E%E5%AD%97%E6%AF%8D">敘利亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%AE%83%E6%8B%BF%E5%AD%97%E6%AF%8D">它拿字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8A%A0%E6%8B%BF%E5%A4%A7%E5%8E%9F%E4%BD%8F%E6%B0%91%E9%9F%B3%E7%AF%80%E6%96%87%E5%AD%97">加拿大原住民音節文字</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BD%9D%E6%96%87">彝文</a>，以及部分<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%9B%B2%E6%96%87">盲文</a>圖案。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-15">14]</a></td>
</tr>
<tr>
<td align="center">3.1</td>
<td align="center">2001年3月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646-1:2000ISO&#x2F;IEC 10646-2:2001</td>
<td align="center">41</td>
<td align="center">94,205</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%BE%B7%E7%91%9F%E9%9B%B7%E7%89%B9%E5%AD%97%E6%AF%8D&action=edit&redlink=1">德瑟雷特字母</a>（英語：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deseret_alphabet">Deseret alphabet</a>）、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%93%A5%E7%89%B9%E5%AD%97%E6%AF%8D">哥特字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E6%84%8F%E5%A4%A7%E5%88%A9%E5%AD%97%E6%AF%8D">古義大利字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%9F%B3%E6%A8%82%E7%AC%A6%E8%99%9F">音樂符號</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E9%9F%B3%E4%B9%90%E7%AC%A6%E5%8F%B7">拜占庭音樂符號</a>，追加了42711個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%A9%E7%BB%9F%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80B">CJK-B</a>）。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-16">15]</a></td>
</tr>
<tr>
<td align="center">3.2</td>
<td align="center">2002年3月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646-1:2000與其第1修訂版ISO&#x2F;IEC 10646-2:2001</td>
<td align="center">45</td>
<td align="center">95,221</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%8F%B2%E5%BE%8B%E5%AE%BE">菲律賓</a>文字<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B8%83%E9%94%A1%E6%96%87">布錫文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%93%88%E5%8A%AA%E8%AF%BA%E6%96%87&action=edit&redlink=1">哈努諾文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BB%96%E5%8A%A0%E7%A5%BF%E6%96%87">他加祿文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%A1%94%E6%A0%BC%E5%B7%B4%E5%A5%B4%E4%BA%9A%E6%96%87&action=edit&redlink=1">塔格巴奴亞文</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-17">16]</a></td>
</tr>
<tr>
<td align="center">4.0</td>
<td align="center">2003年4月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-321-18578-1">0-321-18578-1</a></td>
<td align="center">ISO&#x2F;IEC 10646:2003</td>
<td align="center">52</td>
<td align="center">96,447</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A1%9E%E6%B5%A6%E8%B7%AF%E6%96%AF%E9%9F%B3%E8%8A%82%E6%96%87%E5%AD%97">賽普勒斯音節文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9E%97%E5%B8%83%E5%AD%97%E6%AF%8D&action=edit&redlink=1">林布字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BA%BF%E5%BD%A2%E6%96%87%E5%AD%97B">線形文字B</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A5%A7%E6%96%AF%E6%9B%BC%E4%BA%9E%E5%AD%97%E6%AF%8D">奧斯曼亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%95%AD%E4%BC%AF%E7%B4%8D%E5%AD%97%E6%AF%8D">蕭伯納字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BE%B7%E5%AE%8F%E5%82%A3%E6%96%87">德宏傣文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B9%8C%E5%8A%A0%E9%87%8C%E7%89%B9%E5%AD%97%E6%AF%8D">烏加里特字母</a>以及<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%85%AD%E5%8D%81%E5%9B%9B%E5%8D%A6">六十四卦</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-18">17]</a></td>
</tr>
<tr>
<td align="center">4.1</td>
<td align="center">2005年3月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646:2003與其第1修訂版</td>
<td align="center">59</td>
<td align="center">97,720</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B8%83%E5%90%89%E6%96%87">布吉文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%A0%BC%E6%8B%89%E5%93%A5%E9%87%8C%E5%AD%97%E6%AF%8D">格拉哥里字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BD%89%E5%8D%A2%E6%96%87">佉盧文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%A5%BF%E5%8F%8C%E7%89%88%E7%BA%B3%E5%82%A3%E6%96%87">西雙版納傣文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8F%A4%E6%B3%A2%E6%96%AF%E6%96%87&action=edit&redlink=1">古波斯文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%94%A1%E5%B0%94%E8%B5%AB%E7%89%B9%E6%96%87&action=edit&redlink=1">錫爾赫特文</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%8F%90%E9%9D%9E%E7%B4%8D%E6%96%87">提非納文</a>。<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%A7%91%E6%99%AE%E7%89%B9%E5%AD%97%E6%AF%8D">科普特字母</a>從<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B8%8C%E8%85%8A%E6%96%87">希臘文</a>區段分離。新增了<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8F%A4%E5%B8%8C%E8%85%8A%E9%9F%B3%E4%B9%90%E7%AC%A6%E5%8F%B7&action=edit&redlink=1">古希臘音樂符號</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-19">18]</a></td>
</tr>
<tr>
<td align="center">5.0</td>
<td align="center">2006年7月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/0-321-48091-0">0-321-48091-0</a></td>
<td align="center">ISO&#x2F;IEC 10646:2003與其第1、2修訂版，以及第3修訂版中新增的4個字元</td>
<td align="center">64</td>
<td align="center">99,089</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B7%B4%E5%8E%98%E6%96%87">峇里文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%A5%94%E5%BD%A2%E6%96%87%E5%AD%97">楔形文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%A5%BF%E9%9D%9E%E4%B9%A6%E9%9D%A2%E6%96%87%E5%AD%97">西非書面文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%85%AB%E6%80%9D%E5%B7%B4%E6%96%87">八思巴文</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%85%93%E5%B0%BC%E5%9F%BA%E5%AD%97%E6%AF%8D">腓尼基字母</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-20">19]</a></td>
</tr>
<tr>
<td align="center">5.1</td>
<td align="center">2008年4月</td>
<td align="center"></td>
<td align="center">ISO&#x2F;IEC 10646:2003與其第1－4修訂版</td>
<td align="center">75</td>
<td align="center">100,713</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8D%A1%E5%88%A9%E4%BA%9A%E6%96%87&action=edit&redlink=1">卡利亞文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%A0%E5%A9%86%E5%AD%97%E6%AF%8D">占婆字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%85%8B%E8%80%B6%E9%BB%8E%E6%96%87&action=edit&redlink=1">克耶黎文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%92%E5%B7%B4%E6%96%87">絨巴文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%88%A9%E8%A5%BF%E4%BA%9A%E6%96%87&action=edit&redlink=1">利西亞文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%90%95%E5%BA%95%E4%BA%9A%E6%96%87&action=edit&redlink=1">呂底亞文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%A1%91%E5%A1%94%E5%88%A9%E6%96%87&action=edit&redlink=1">桑塔利文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%8B%89%E8%AE%A9%E6%96%87&action=edit&redlink=1">拉讓文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%B4%A2%E6%8B%89%E4%BB%80%E7%89%B9%E6%8B%89%E6%96%87&action=edit&redlink=1">索拉什特拉文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B7%BD%E4%BB%96%E6%96%87&action=edit&redlink=1">巽他文</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%93%A6%E4%BC%8A%E6%96%87&action=edit&redlink=1">瓦伊文</a>。同時增加了<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%96%90%E6%96%AF%E6%89%98%E6%96%AF%E5%9C%93%E7%9B%A4">斐斯托斯圓盤</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%BA%BB%E5%B0%86">麻將</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A4%9A%E7%B1%B3%E8%AF%BA%E9%AA%A8%E7%89%8C">多米諾骨牌</a>符號。對<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BC%85%E7%94%B8%E6%96%87">緬甸文</a>做了重要的補充，追加了手抄縮寫的額外字母，追加了<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A4%A7%E5%AF%AB%E1%BA%9E">大寫ẞ</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-21">20]</a></td>
</tr>
<tr>
<td align="center">5.2</td>
<td align="center">2009年10月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-00-9">978-1-936213-00-9</a></td>
<td align="center">ISO&#x2F;IEC 10646:2003與其第1－6修訂版</td>
<td align="center">90</td>
<td align="center">107,361</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%98%BF%E7%BB%B4%E6%96%AF%E9%99%80%E6%96%87&action=edit&redlink=1">阿維斯陀文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B7%B4%E5%A7%86%E7%A9%86%E6%96%87%E5%AD%97">巴姆穆文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9F%83%E5%8F%8A%E8%B1%A1%E5%BD%A2%E6%96%87%E5%AD%97">埃及象形文字</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8A%A0%E6%B1%80%E7%B4%8D%E7%AC%A6%E8%99%9F%E8%A1%A8">加汀納符號表</a>，涵蓋1071個符號）、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BA%9E%E6%8B%89%E5%A7%86%E6%96%87">亞拉姆文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B7%B4%E6%8B%89%E7%BB%B4%E7%A2%91%E9%93%AD%E4%BD%93&action=edit&redlink=1">巴拉維碑銘體</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B8%95%E6%8F%90%E4%BA%9A%E7%A2%91%E9%93%AD%E4%BD%93&action=edit&redlink=1">帕提亞碑銘體</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%88%AA%E5%93%87%E6%96%87">爪哇文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%87%B1%E6%8F%90%E6%96%87">凱提文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%80%81%E5%82%88%E5%83%B3%E6%96%87">老傈僳文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9B%BC%E5%B0%BC%E6%99%AE%E5%B0%94%E6%96%87&action=edit&redlink=1">曼尼普爾文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%97%E9%98%BF%E6%8B%89%E4%BC%AF%E5%AD%97%E6%AF%8D">南阿拉伯字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E7%AA%81%E5%8E%A5%E6%96%87">古突厥文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%92%92%E7%8E%9B%E5%88%A9%E4%BA%9A%E5%AD%97%E6%AF%8D&action=edit&redlink=1">撒瑪利亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%80%81%E5%82%A3%E6%96%87">老傣文</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%82%A3%E9%BB%AF%E8%AA%9E">傣越文</a>。追加4,149個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%A9%E7%BB%9F%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80C">CJK-C</a>），同時擴充了<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8F%A4%E9%9F%A9%E6%96%87&action=edit&redlink=1">古韓文</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%90%A0%E9%99%80%E6%A2%B5%E6%96%87">吠陀梵文</a>的字元。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-22">21]</a></td>
</tr>
<tr>
<td align="center">6.0</td>
<td align="center">2010年10月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-01-6">978-1-936213-01-6</a></td>
<td align="center">ISO&#x2F;IEC 10646:2010與<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%B0%E5%BA%A6%E5%8D%A2%E6%AF%94%E7%AC%A6%E5%8F%B7">印度盧比符號</a></td>
<td align="center">93</td>
<td align="center">109,449</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B7%B4%E5%A1%94%E5%85%8B%E5%AD%97%E6%AF%8D&action=edit&redlink=1">巴塔克字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A9%86%E7%BD%97%E7%B1%B3%E6%96%87%E5%AD%97">婆羅米文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9B%BC%E8%BE%BE%E5%AD%97%E6%AF%8D&action=edit&redlink=1">曼達字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BA%B8%E7%89%8C">紙牌</a>符號、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BA%A4%E9%80%9A%E6%A0%87%E5%BF%97">交通標誌</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9C%B0%E5%9B%BE">地圖</a>符號、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%82%BC%E9%87%91%E6%9C%AF%E7%AC%A6%E5%8F%B7">鍊金術符號</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%A2%9C%E6%96%87%E5%AD%97">顏文字</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%98%E6%96%87%E5%AD%97">繪文字</a>。追加222個額外的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%A9%E7%BB%9F%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80D">CJK-D</a>）。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-23">22]</a></td>
</tr>
<tr>
<td align="center">6.1</td>
<td align="center">2012年1月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-02-3">978-1-936213-02-3</a></td>
<td align="center">ISO&#x2F;IEC 10646:2012</td>
<td align="center">100</td>
<td align="center">110,181</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9F%A5%E5%85%8B%E9%A9%AC%E5%AD%97%E6%AF%8D&action=edit&redlink=1">查克馬字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%BA%A6%E7%BD%97%E5%9F%83%E6%96%87">麥羅埃文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%BA%A6%E7%BD%97%E5%9F%83%E8%B1%A1%E5%BD%A2%E6%96%87%E5%AD%97&action=edit&redlink=1">麥羅埃象形文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%9F%8F%E6%A0%BC%E7%90%86%E8%8B%97%E6%96%87">柏格理苗文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A4%8F%E6%8B%89%E9%81%94%E6%96%87">夏拉達文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B4%A2%E6%8B%89%E5%83%A7%E5%B9%B3%E6%96%87%E5%AD%97">索拉僧平文字</a>和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%B3%B0%E5%85%8B%E9%87%8C%E6%96%87&action=edit&redlink=1">泰克里文</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-24">23]</a></td>
</tr>
<tr>
<td align="center">6.2</td>
<td align="center">2012年9月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-07-8">978-1-936213-07-8</a></td>
<td align="center">ISO&#x2F;IEC 10646:2012與<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9C%9F%E8%80%B3%E5%85%B6%E9%87%8C%E6%8B%89%E7%AC%A6%E5%8F%B7">土耳其里拉符號</a></td>
<td align="center">100</td>
<td align="center">110,182</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9C%9F%E8%80%B3%E5%85%B6%E9%87%8C%E6%8B%89%E7%AC%A6%E5%8F%B7">土耳其里拉符號</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-25">24]</a>。</td>
</tr>
<tr>
<td align="center">6.3</td>
<td align="center">2013年9月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-08-5">978-1-936213-08-5</a></td>
<td align="center">ISO&#x2F;IEC 10646:2012與6個字元</td>
<td align="center">100</td>
<td align="center">110,187</td>
<td>5個雙向排版符號。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-26">25]</a></td>
</tr>
<tr>
<td align="center">7.0</td>
<td align="center">2014年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-09-2">978-1-936213-09-2</a></td>
<td align="center">ISO&#x2F;IEC 10646:2012與其第1、2修訂版，以及<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BF%84%E7%BE%85%E6%96%AF%E7%9B%A7%E5%B8%83">俄羅斯盧布</a>符號</td>
<td align="center">123</td>
<td align="center">113,021</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B7%B4%E8%90%A8%E5%AD%97%E6%AF%8D&action=edit&redlink=1">巴薩字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%AB%98%E5%8A%A0%E7%B4%A2%E9%98%BF%E5%B0%94%E5%B7%B4%E5%B0%BC%E4%BA%9A%E5%AD%97%E6%AF%8D&action=edit&redlink=1">高加索阿爾巴尼亞字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9D%9C%E6%99%AE%E9%9B%B7%E5%9A%B4%E9%80%9F%E8%A8%98&action=edit&redlink=1">杜普雷嚴速記</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%88%B1%E5%B0%94%E5%B7%B4%E6%A1%91%E5%AD%97%E6%AF%8D&action=edit&redlink=1">愛爾巴桑字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E5%85%B0%E5%A1%94%E6%96%87">古蘭塔文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8F%AF%E5%90%89%E6%96%87&action=edit&redlink=1">可吉文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%BA%93%E8%BE%BE%E7%93%A6%E8%BF%AA%E6%96%87&action=edit&redlink=1">庫達瓦迪文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BA%BF%E5%BD%A2%E6%96%87%E5%AD%97A">線形文字A</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%A9%AC%E5%93%88%E4%BD%B3%E5%B0%BC%E6%96%87&action=edit&redlink=1">馬哈佳尼文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%91%A9%E5%B0%BC%E6%95%99%E5%AD%97%E6%AF%8D">摩尼教字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%97%A8%E5%BE%97%E6%96%87%E5%AD%97&action=edit&redlink=1">門得文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E8%8E%AB%E8%BF%AA%E5%AD%97%E6%AF%8D&action=edit&redlink=1">莫迪字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%BB%98%E6%96%87&action=edit&redlink=1">默文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B4%8D%E5%B7%B4%E6%B3%B0%E5%AD%97%E6%AF%8D">納巴泰字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8F%A4%E5%8C%97%E9%98%BF%E6%8B%89%E4%BC%AF%E6%96%87&action=edit&redlink=1">古北阿拉伯文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E5%BD%BC%E7%88%BE%E5%A7%86%E6%96%87">古彼爾姆文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%9D%A8%E6%9D%BE%E5%BD%95%E8%8B%97%E6%96%87">楊松錄苗文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B8%95%E7%B1%B3%E6%8B%89%E6%96%87%E5%AD%97&action=edit&redlink=1">帕米拉文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E8%A2%8D%E6%B8%85%E8%B1%AA%E6%96%87&action=edit&redlink=1">袍清豪文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E8%AF%97%E7%AF%87%E5%B7%B4%E5%88%97%E7%BB%B4%E6%96%87&action=edit&redlink=1">詩篇巴列維文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%82%89%E6%9B%87%E6%96%87%E5%AD%97">悉曇文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BA%95%E7%BD%97%E4%BB%86%E5%A4%9A%E6%96%87">底羅仆多文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%93%A6%E5%85%B0%E9%BD%90%E5%9C%B0%E6%96%87&action=edit&redlink=1">瓦蘭齊地文</a>以及<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Dingbat">裝飾符號</a>。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-27">26]</a></td>
</tr>
<tr>
<td align="center">8.0</td>
<td align="center">2015年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-10-8">978-1-936213-10-8</a></td>
<td align="center">ISO&#x2F;IEC 10646:2014與其第1修訂版，以及<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%96%AC%E6%B2%BB%E4%BA%9E%E6%8B%89%E9%87%8C">喬治亞拉里</a>符號、9個中日韓統一表意文字與41個表情符號[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-28">27]</a></td>
<td align="center">129</td>
<td align="center">120,737</td>
<td>增加<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%98%BF%E6%B4%AA%E5%A7%86%E6%96%87">阿洪姆文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%AE%89%E7%BA%B3%E6%89%98%E5%88%A9%E4%BA%9A%E8%B1%A1%E5%BD%A2%E6%96%87%E5%AD%97&action=edit&redlink=1">安納托利亞象形文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%93%88%E5%9D%A6%E6%96%87&action=edit&redlink=1">哈坦文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%A9%86%E5%B0%94%E5%A1%94%E5%B0%BC%E6%96%87&action=edit&redlink=1">穆爾塔尼文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E5%8C%88%E7%89%99%E5%88%A9%E5%AD%97%E6%AF%8D">古匈牙利字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%96%A9%E9%A0%93%E6%89%8B%E8%AA%9E%E8%AD%9C%E5%AF%AB">薩頓手語譜寫</a>、5,771個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%A9%E7%BB%9F%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>字元（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80E">CJK-E</a>）、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%88%87%E7%BD%97%E5%9F%BA%E6%96%87">切羅基文</a>小寫字母，以及五種<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%98%E6%96%87%E5%AD%97">繪文字</a><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%86%9A%E8%89%B2">膚色</a>修改字元。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-29">28]</a></td>
</tr>
<tr>
<td align="center">9.0</td>
<td align="center">2016年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-13-9">978-1-936213-13-9</a></td>
<td align="center">ISO&#x2F;IEC 10646:2014與其第1、2修訂版，阿德拉姆字母、尼泊爾紐瓦字母、日本電視符號和74個繪文字表情與符號。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-30">29]</a></td>
<td align="center">135</td>
<td align="center">128,237</td>
<td>新增<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E9%98%BF%E5%BE%B7%E6%8B%89%E5%A7%86%E5%AD%97%E6%AF%8D">阿德拉姆字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%AF%94%E5%A5%87%E8%88%92%E5%A5%87%E6%96%87&action=edit&redlink=1">比奇舒奇文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%B1%A1%E9%9B%84%E6%96%87">象雄文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B0%BC%E6%B3%8A%E5%B0%94%E7%BA%BD%E7%93%A6%E5%AD%97%E6%AF%8D&action=edit&redlink=1">尼泊爾紐瓦字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%AC%A7%E5%A1%9E%E5%A5%87%E5%AD%97%E6%AF%8D&action=edit&redlink=1">歐塞奇字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%A5%BF%E5%A4%8F%E6%96%87">西夏文</a>以及74個繪文字[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-31">30]</a></td>
</tr>
<tr>
<td align="center">10.0</td>
<td align="center">2017年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-16-0">978-1-936213-16-0</a></td>
<td align="center">ISO&#x2F;IEC 10646:2017，新增56個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%98%E6%96%87%E5%AD%97">繪文字</a>符號、385個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%AE%8A%E9%AB%94%E5%81%87%E5%90%8D">變體假名</a>字元，和3個札那巴札爾字元[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-Unicode10.0-32">31]</a></td>
<td align="center">139</td>
<td align="center">136,755</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%92%99%E5%8F%A4%E6%96%87%E5%AD%97">札那巴札爾</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B4%A2%E6%B0%B8%E5%B8%83%E6%96%87%E5%AD%97">索永布文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E9%A9%AC%E8%90%A8%E6%8B%89%E5%A7%86%E8%B4%A1%E5%BE%B7%E6%96%87%E5%AD%97&action=edit&redlink=1">馬薩拉姆貢德文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A5%B3%E4%B9%A6">女書</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%AE%8A%E9%AB%94%E5%81%87%E5%90%8D">變體假名</a>（非標準<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%B9%B3%E5%81%87%E5%90%8D">平假名</a>）、7,494個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80F">CJK-F</a>）與56個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B9%AA%E6%96%87%E5%AD%97">繪文字</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-33">32]</a></td>
</tr>
<tr>
<td align="center">11.0</td>
<td align="center">2018年6月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-19-1">978-1-936213-19-1</a></td>
<td align="center">ISO&#x2F;IEC 10646:2017與其第1修訂版，新增145個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%98%E6%96%87%E5%AD%97">繪文字</a>符號、5個急用漢字，<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Copyleft">copyleft</a>符號、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E5%9B%BD%E8%B1%A1%E6%A3%8B">中國象棋</a>符號等[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-Unicode11.0-34">33]</a></td>
<td align="center">146</td>
<td align="center">137,374</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%A4%9A%E6%A0%BC%E6%8B%89%E6%96%87&action=edit&redlink=1">多格拉文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%96%AC%E6%B2%BB%E4%BA%9E%E6%96%87">喬治亞文</a>騎士體大寫字母、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E8%B4%A1%E8%B4%BE%E6%8B%89%E8%B4%A1%E5%BE%B7%E6%96%87&action=edit&redlink=1">貢賈拉貢德文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%93%88%E4%B9%83%E6%96%90%E7%BE%85%E8%88%88%E4%BA%9E%E6%96%87%E5%AD%97">哈乃斐羅興亞文字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%9C%9B%E5%8A%A0%E9%94%A1%E6%96%87&action=edit&redlink=1">望加錫文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%A2%85%E5%BE%B7%E6%B3%95%E4%BC%8A%E5%BE%B7%E6%9E%97%E6%96%87&action=edit&redlink=1">梅德法伊德林文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%80%81%E7%B2%9F%E7%89%B9%E5%AD%97%E6%AF%8D">老粟特字母</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B2%9F%E7%89%B9%E5%AD%97%E6%AF%8D">粟特字母</a>以及145個繪文字[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-35">34]</a></td>
</tr>
<tr>
<td align="center">12.0</td>
<td align="center">2019年3月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-22-1">978-1-936213-22-1</a></td>
<td align="center">ISO&#x2F;IEC 10646:2017與其第1、2修訂版，新增61個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%BB%98%E6%96%87%E5%AD%97">繪文字</a>符號、一些方言<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%8B%97%E6%96%87">苗文</a>字元、古日文用小型<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%97%A5%E6%96%87%E5%81%87%E5%90%8D">日文假名</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B3%B0%E7%B1%B3%E7%88%BE%E6%96%87">泰米爾文</a>的符號、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9C%A3%E4%B9%A6%E4%BD%93">聖書體</a>控制字元等[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-Unicode12.0-36">35]</a></td>
<td align="center">150</td>
<td align="center">137,928</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9F%83%E5%88%A9%E9%82%81%E6%96%87">埃利邁文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8D%97%E8%BF%AA%E5%9F%8E%E6%96%87&action=edit&redlink=1">南迪城文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%89%B5%E4%B8%96%E7%B4%80%E8%8B%97%E6%96%87">創世紀苗文</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%96%87%E4%B9%94%E6%96%87&action=edit&redlink=1">文喬文</a>以及61個繪文字[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-37">36]</a></td>
</tr>
<tr>
<td align="center">12.1</td>
<td align="center">2019年5月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-25-2">978-1-936213-25-2</a></td>
<td align="center"></td>
<td align="center">150</td>
<td align="center">137,929</td>
<td>只在U+32FF新增了一個字元，即日本新年號<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%BB%A4%E5%92%8C">令和</a>的合字。[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-38">37]</a></td>
</tr>
<tr>
<td align="center">13.0</td>
<td align="center">2020年3月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-26-9">978-1-936213-26-9</a></td>
<td align="center">ISO&#x2F;IEC 10646:2020[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-39">38]</a></td>
<td align="center">154</td>
<td align="center">143,924</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%8A%B1%E5%89%8C%E5%AD%90%E6%A8%A1%E8%AF%AD">花剌子模語</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%BF%AA%E7%BB%B4%E8%A5%BF%E8%AF%AD">迪維西語</a>的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%B3%B6%E5%AD%97%E6%AF%8D&action=edit&redlink=1">島字母</a>（英語：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dhives_akuru">Dhives akuru</a>）、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A5%91%E4%B8%B9%E5%B0%8F%E5%AD%97">契丹小字</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BA%93%E5%B0%94%E5%BE%B7%E8%AF%AD%E5%AD%97%E6%AF%8D">庫德語字母</a>的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%BA%93%E5%B0%94%E5%BE%B7%E8%AF%AD%E5%AD%97%E6%AF%8D#%E9%9B%85%E8%8C%B2%E8%BF%AA%E6%96%87">雅茲迪文</a>、4969個中日韓統一表意文字（4939個位於<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%93%E7%B5%B1%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97%E6%93%B4%E5%B1%95%E5%8D%80G">擴充區G</a>（<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/CJK-G">CJK-G</a>））、書寫<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E8%B1%AA%E8%90%A8%E8%AF%AD">豪薩語</a>用的阿拉伯附加字母、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%B2%83%E6%B4%9B%E5%A4%AB%E8%AA%9E">沃洛夫語</a>、其他非洲語言、在巴基斯坦書寫<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%8D%B0%E5%BE%B7%E7%A7%91%E8%AA%9E&action=edit&redlink=1">印德科語</a>（英語：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hindko">Hindko</a>）和<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%97%81%E9%81%AE%E6%99%AE%E8%AA%9E">旁遮普語</a>的補充字元、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B2%B5%E8%AA%9E">粵語</a>用的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B2%B5%E8%AA%9E%E6%B3%A8%E9%9F%B3%E7%AC%A6%E8%99%9F">注音符號</a>、<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%85%B1%E4%BA%AB%E5%89%B5%E6%84%8F">創用CC</a>授權符號、1970年代和1980年代電訊用圖符、55個<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%B9%AA%E6%96%87%E5%AD%97">繪文字</a>[<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode#cite_note-40">39]</a></td>
</tr>
<tr>
<td align="center">14.0</td>
<td align="center">2021年9月</td>
<td align="center"><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%BD%E9%99%85%E6%A0%87%E5%87%86%E4%B9%A6%E5%8F%B7">ISBN</a> <a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/Special:%E7%BD%91%E7%BB%9C%E4%B9%A6%E6%BA%90/978-1-936213-29-0">978-1-936213-29-0</a></td>
<td align="center"></td>
<td align="center">159</td>
<td align="center">144,697</td>
<td><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%89%98%E6%89%98%E6%96%87&action=edit&redlink=1">托托文</a>，用於在<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8D%B0%E5%BA%A6%E4%B8%9C%E5%8C%97%E9%83%A8">印度東北部</a>書寫<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E6%89%98%E6%89%98%E8%AF%AD&action=edit&redlink=1">托托語</a><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%A1%9E%E6%99%AE%E5%8B%92%E6%96%AF-%E7%B1%B3%E8%AB%BE%E6%96%AF%E6%96%87%E5%AD%97&action=edit&redlink=1">塞普勒斯-米諾斯文字</a>，一種未破譯的歷史文字，主要用於<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%A1%9E%E6%B5%A6%E8%B7%AF%E6%96%AF%E5%B2%9B">賽普勒斯島</a><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E7%B6%AD%E6%96%AF%E5%BA%AB%E5%A5%87%E6%96%87&action=edit&redlink=1">維斯庫奇文</a>，一種用於書寫阿爾巴尼亞語的歷史文字，正在經歷現代復興<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%9B%9E%E9%B9%98%E5%AD%97%E6%AF%8D">回鶻字母</a>，一種歷史上在中亞和其他地方用於書寫<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E7%AA%81%E5%8E%A5%E8%AF%AD%E6%97%8F">突厥語</a>、漢語、蒙古語、藏語和阿拉伯語的文字唐薩文，一種現代文字，用於書寫在印度和緬甸使用的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/w/index.php?title=%E5%94%90%E8%96%A9%E8%AF%AD&action=edit&redlink=1">唐薩語</a>位於第一輔助平面的拉丁文擴充區段（擴展F和G）增加了許多擴充IPA字母 ，和許多用於拉丁語及阿拉伯文字的補充字母，這些字母用於非洲和伊朗、巴基斯坦、馬來西亞、印度尼西亞、爪哇和波士尼亞書寫語言，以及書寫<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E6%95%AC%E8%AA%9E">敬語</a>，以及為《<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E5%8F%A4%E5%85%B0%E7%BB%8F">古蘭經</a>》使用的補充。其它的一些字元添加支援北美和菲律賓、印度和蒙古的語言的文字追加9個額外的<a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/wiki/%E4%B8%AD%E6%97%A5%E9%9F%A9%E7%BB%9F%E4%B8%80%E8%A1%A8%E6%84%8F%E6%96%87%E5%AD%97">中日韓統一表意文字</a>（基本多文種平面、第二輔助平面）。</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-tw/Unicode">參考連結：UNICODE 維基百科</a></p>
<h2 id="8-UTF-8"><a href="#8-UTF-8" class="headerlink" title="8. UTF-8"></a>8. UTF-8</h2><p><strong>Unicode 解決的問題是將多國語言中的每一個文字符號都能夠對應到一組數字，但 Unicode 並沒有說明儲存這些數字的方式</strong>。</p>
<p><strong>UTF-8</strong>（<strong>8-bit Unicode Transformation Format</strong>）是一種針對<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode">Unicode</a>的可變長度<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97%E5%85%83%E7%B7%A8%E7%A2%BC">字元編碼</a>，也是一種<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%89%8D%E7%BC%80%E7%A0%81">字首碼</a>。它可以用一至四個位元組對Unicode字元集中的所有有效編碼點進行編碼，屬於<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode">Unicode</a>標準的一部分，最初由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%82%AF%C2%B7%E6%B1%A4%E6%99%AE%E9%80%8A">肯·湯普遜</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E7%BD%97%E5%B8%83%C2%B7%E6%B4%BE%E5%85%8B&action=edit&redlink=1">羅布·派克</a>提出。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-:0-2">2]</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-3">3]</a>由於較小值的編碼點一般使用頻率較高，直接使用Unicode編碼效率低下，大量浪費記憶體空間。UTF-8就是為了解決向下相容ASCII碼而設計，Unicode中前128個字元，使用與ASCII碼相同的二進位值的單個<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82">位元組</a>進行編碼，而且字面與ASCII碼的字面一一對應，這使得原來處理ASCII字元的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BB%9F%E9%AB%94">軟體</a>無須或只須做少部份修改，即可繼續使用。因此，它逐漸成為<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E9%83%B5%E4%BB%B6">電子郵件</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%A0%81">網頁</a>及其他<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%84%B2%E5%AD%98%E8%A3%9D%E7%BD%AE">儲存</a>或傳送文字優先採用的編碼方式。</p>
<p>自2009年以來，UTF-8一直是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%87%E7%BB%B4%E7%BD%91">全球資訊網</a>的最主要的編碼形式（對所有，而不僅是Unicode範圍內的編碼）（並由WHATWG宣布為強制性的「適用於所有事物(for all things)」，[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-mandatory-4">4]</a>截止到2019年11月， 在所有網頁中，UTF-8編碼應用率高達94.3%（其中一些僅是ASCII編碼，因為它是UTF-8的子集），而在排名最高的1000個網頁中占96％。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-5">5]</a> 第二熱門的多位元組編碼方式Shift JIS和GB 2312分別具有0.3％和0.2％的占有率。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-W3Techs-6">6]</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-BuiltWith-7">7]</a>[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-MarkDavis2012-1">1]</a>Internet郵件聯盟（ Internet Mail Consortium, IMC）建議所有電子郵件程式都能夠使用UTF-8展示和建立郵件，[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-IMC-8">8]</a> W3C建議UTF-8作為XML檔案和HTML檔案的預設編碼方式。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-html5charset-9">9]</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%9A%9B%E7%B6%B2%E8%B7%AF%E5%B7%A5%E7%A8%8B%E5%B7%A5%E4%BD%9C%E5%B0%8F%E7%B5%84">網際網路工程工作小組</a>（IETF）要求所有<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%9A%9B%E7%B6%B2%E8%B7%AF">網際網路</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE">協定</a>都必須支援UTF-8編碼[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-10">10]</a>。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E4%BA%92%E8%81%AF%E7%B6%B2%E9%83%B5%E4%BB%B6%E8%81%AF%E7%9B%9F&action=edit&redlink=1">網際網路郵件聯盟</a>（IMC）建議所有電子郵件軟體都支援UTF-8編碼。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8#cite_note-11">11]</a></p>
<p><img src="https://i.imgur.com/AY0WAQs.jpg" alt="img"></p>
<h3 id="8-1-編碼規則"><a href="#8-1-編碼規則" class="headerlink" title="8.1. 編碼規則"></a>8.1. 編碼規則</h3><p>UTF-8 的編碼規則很簡單，只有二條：</p>
<ol>
<li>對於單一位元組的文字符號，位元組的第一位設為 <code>0</code>，後面 7 位為這個符號的 Unicode 碼。因此<strong>對於英語字母，UTF-8 編碼和 ASCII 碼是相同的</strong>。</li>
<li>對於 <code>n</code> 位元組的文字符號（<code>n &gt; 1</code>），第一個位元組的前 <code>n</code> 位都設為 <code>1</code>，第 <code>n + 1</code> 位設為 <code>0</code>，後面位元組的前兩位一律設為 <code>10</code>。剩下的沒有提及的二進制位，全部為這個符號的 Unicode 碼。</li>
</ol>
<p><img src="https://i.imgur.com/D8KMmtD.png" alt="Imgur"></p>
<h4 id="8-1-1-範例一：A"><a href="#8-1-1-範例一：A" class="headerlink" title="8.1.1. 範例一：A"></a>8.1.1. 範例一：A</h4><p>舉例來說，英文字「A」的 Unicode 是 <code>U+0041</code>，也就是 (65)10，亦等同於 (0100 0001)2 因此根據上表顯示介於十六進制 <code>0000 0000</code> ~ <code>0000 007F</code> 範圍內，也就是屬於第一組。</p>
<p>所以「A」的 UTF-8 編碼只需要一個位元組，格式就是 <code>0xxxxxxx</code>。將「A」Unicode 的內容直接填入 x，即可得到「A」的 UTF-8 編碼為 <code>0100 0001</code>，轉換成 16 進制就是 (41)16。</p>
<h4 id="8-1-2-範例二：臺"><a href="#8-1-2-範例二：臺" class="headerlink" title="8.1.2. 範例二：臺"></a>8.1.2. 範例二：臺</h4><p>舉例來說，中文字「臺」的 Unicode 是 <code>U+81FA</code>，也就是 (33274)10，亦等同於 (1000 0001 1111 1010)2，因此根據上表顯示介於十六進制 <code>00000800</code> ~ <code>0000FFFF</code> 這個範圍內，也就是屬於第三組。</p>
<p>所以「臺」的 UTF-8 編碼需要三個位元組，格式就是 <code>1110xxxx 10xxxxxx 10xxxxxx</code>。然後從「臺」的最後一個二進制位數開始，依次由後往前添入格式中的 <code>x</code>，多出來的位數補 <code>0</code>。</p>
<p>於是便可得到「臺」的 UTF-8 編碼是 <code>11101000 10000111 10111010</code>，轉換成十六進制就是 (<code>E887BA</code>)16。</p>
<p><img src="https://i.imgur.com/TQl8qWp.png" alt="Imgur"></p>
<p><a target="_blank" rel="noopener" href="https://pjchender.dev/webdev/note-unicode/">參考連結：Unicode 字串編碼(encode, decode)</a></p>
<h2 id="9-UTF-8與BOM"><a href="#9-UTF-8與BOM" class="headerlink" title="9. UTF-8與BOM"></a>9. UTF-8與BOM</h2><p>BOM – Byte Order Mark，中文名譯作“字節順序標記”。在UCS 編碼中有一個叫做 “Zero Width No-Break Space” ，中文譯名作“零寬無間斷間隔”的字符，它的編碼是 FEFF。而 FFFE 在 UCS 中是不存在的字符，所以不應該出現在實際傳輸中。 UCS 規范建議我們在傳輸字節流前，先傳輸字符 “Zero Width No-Break Space”。這樣如果接收者收到 FEFF，就表明這個字節流是 Big-Endian 的；如果收到FFFE，就表明這個字節流是 Little- Endian 的。因此字符 “Zero Width No-Break Space” （“零寬無間斷間隔”）又被稱作 BOM。</p>
<p>BOM（byte order mark）是為 UTF-16 和 UTF-32 準備的，UTF-8 不需要 BOM 來表明字節順序，但可以用 BOM 來表明編碼方式。字符 “Zero Width No-Break Space” 的 UTF-8 編碼是 EF BB BF。所以如果接收者收到以 EF BB BF （十六進制）開頭的字節流，就知道這是 UTF-8編碼了。 Windows 就是使用 BOM 來標記文本文件的編碼方式的。微軟在 UTF-8 中使用 BOM 是因為這樣可以把 UTF-8 和 ASCII 等編碼明確區分開，但這樣的文件在 Windows 之外的操作系統裡會帶來問題。它產生的BUG包含但不僅限於：</p>
<ul>
<li>HTML空白行</li>
<li>div之間莫明的間隔</li>
<li>亂碼</li>
<li>Ssl出錯</li>
<li>編譯錯誤</li>
</ul>
<p>在Linux中的解決方案，在Linux中可以用vim很方便地檢測、去除BOM頭</p>
<p>檢測是否有BOM頭：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:set bomb?</span><br></pre></td></tr></table></figure>

<p>去除BOM頭：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set encoding=utf-8</span><br><span class="line">:set nobomb</span><br></pre></td></tr></table></figure>

<p>添加BOM頭也很簡單：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set encoding=utf-8</span><br><span class="line">:set bomb</span><br></pre></td></tr></table></figure>

<p>利用python去除文件中BOM的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">data = <span class="built_in">open</span>(<span class="string">&quot;Test.txt&quot;</span>).read()</span><br><span class="line"><span class="keyword">if</span> data[:<span class="number">3</span>] == codecs.BOM_UTF8:</span><br><span class="line">  data = data[<span class="number">3</span>:]</span><br><span class="line">  <span class="built_in">print</span>(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br></pre></td></tr></table></figure>



<h2 id="10-程序角度看unicode"><a href="#10-程序角度看unicode" class="headerlink" title="10. 程序角度看unicode"></a>10. 程序角度看unicode</h2><p>如果沒有一個統一的編碼可以讓程序來處理，那麼同樣的程序就需要維護不同的版本。 Unicode的出現就是為了解決不同語言間的問題，不同的編碼可以和Unicode進行轉換。</p>
<p><img src="https://i.imgur.com/J4XEgUv.png" alt="img"></p>
<p>在計算機內存中，統一使用Unicode編碼，當需要保存到硬盤或者需要傳輸的時候，就轉換為UTF-8編碼。用記事本編輯的時候，從文件讀取的UTF-8字符被轉換為Unicode字符到內存裡，編輯完成後，保存的時候再把Unicode轉換為UTF-8保存到文件：</p>
<p><img src="https://i.imgur.com/yApOhK7.png" alt="unicode.drawio"></p>
<h3 id="10-1-Python源代碼文件的執行過程"><a href="#10-1-Python源代碼文件的執行過程" class="headerlink" title="10.1. Python源代碼文件的執行過程"></a>10.1. Python源代碼文件的執行過程</h3><p>我們都知道，磁盤上的文件都是以二進制格式存放的，其中文本文件都是以某種特定編碼的字節形式存放的。對於程序源代碼文件的字符編碼是由編輯器指定的，比如我們使用Pycharm來編寫Python程序時會指定工程編碼和文件編碼為UTF-8，那麼Python代碼被保存到磁盤時就會被轉換為UTF-8編碼對應的字節（encode過程）後寫入磁盤。</p>
<p>當執行Python代碼文件中的代碼時，Python解釋器在讀取Python代碼文件中的字節串之後，需要將其轉換為Unicode字符串（decode過程）之後才執行後續操作。</p>
<p><img src="https://i.imgur.com/RQ2AylZ.png" alt="python_exec_encode_decode.drawio"></p>
<h3 id="10-2-python-編碼的unicode"><a href="#10-2-python-編碼的unicode" class="headerlink" title="10.2. python 編碼的unicode"></a>10.2. python 編碼的unicode</h3><p>Python3 裡的字串可以用兩個型別來表示：(1) <code>str</code>(2) <code>bytes</code>(其實 str 就是一般所謂的 unicode ，以下統稱為 <strong>unicode</strong> )</p>
<p>在 Python 的程式裡，會建議所有「內部」的商業邏輯操作都使用 unicode 來處理，只有在與「外界」溝通時，才需要轉換成 bytes。</p>
<p>這邊可以定義為「外界」的可以有下列幾個，在 Python3 裡的 function 參數都只吃 bytes 而且，傳 unicode 字串就會 exception</p>
<ol>
<li>File I&#x2F;O (read, write)</li>
<li>System I&#x2F;O (stdin, stdout, stderr)</li>
<li>Binary I&#x2F;O (http content)</li>
</ol>
<p>下面這段說明應該滿清楚的</p>
<ul>
<li>Use <code>.encode()</code> to convert <strong>human text</strong> to <strong>bytes</strong>.</li>
<li>Use <code>.decode()</code> to convert <strong>bytes</strong> to <strong>human text</strong>.</li>
</ul>
<p><img src="https://i.imgur.com/yBAR1GB.png" alt="img"></p>
<p>概念上來說，就是 Python Application 「內部」核心處理的部分都用以 Unicode 處理，「外界」的部分，不管是 Terminal 的 stdout &#x2F; stdin、HTTP content、File ，只要跟 I&#x2F;O 有關，都是以 bytes 來處理，進來一律 decode 成 unicode，出去一律 encode 成 bytes。</p>
<h2 id="11-MySQL-utf8與utf8mb4的差別"><a href="#11-MySQL-utf8與utf8mb4的差別" class="headerlink" title="11. MySQL utf8與utf8mb4的差別"></a>11. MySQL utf8與utf8mb4的差別</h2><h3 id="11-1-網站資料庫utf8編碼用得好好的，為什麼要多一個utf8mb4"><a href="#11-1-網站資料庫utf8編碼用得好好的，為什麼要多一個utf8mb4" class="headerlink" title="11.1. 網站資料庫utf8編碼用得好好的，為什麼要多一個utf8mb4?"></a>11.1. 網站資料庫utf8編碼用得好好的，為什麼要多一個utf8mb4?</h3><p>一般情況下，架設網站使用MySQL的utf8就夠用了，但隨著網路資訊的快速進步，需求越來越多元，有些特殊漢字或是常用的emoji(一種特殊的Unicode編碼，在ios跟安卓手機都會看過)，這其實都是需要使用四個位元組網頁上才能完整呈現，相對MySQL支援的utf8只有三個位元組，大部分的中文漢字雖然夠用，但是卻無法滿足到所有的字元，若是要使用特殊漢字或是表情符號，就無法使用MySQL的utf8字符集儲存，網站後台操作時會造成錯誤。</p>
<h3 id="11-2-UTF-8原本不就支援四個位元組嗎-為什在MySQL裡只能支援三個位元，還要多此一舉端出一個utf8mb4"><a href="#11-2-UTF-8原本不就支援四個位元組嗎-為什在MySQL裡只能支援三個位元，還要多此一舉端出一個utf8mb4" class="headerlink" title="11.2. UTF-8原本不就支援四個位元組嗎?為什在MySQL裡只能支援三個位元，還要多此一舉端出一個utf8mb4?"></a>11.2. UTF-8原本不就支援四個位元組嗎?為什在MySQL裡只能支援三個位元，還要多此一舉端出一個utf8mb4?</h3><p>是的，你所知道的UTF-8字符集是支援最多四個位元組沒有錯，但因為MySQL最初開發時，認為三個位元組就夠用了不需要支援到四個位元組，於是把utf8設定為最多支援三個位元組，並不是我們所熟知的UTF-8支援四位元組的字符集，可說是此MySQL utf8非彼UTF-8啊!!</p>
<p>這情況，導致在使用MySQL utf8編碼時使用到生僻字特殊漢字，或是表情符號時，會出錯誤插入失敗(因為只支援到三個位元組)，以為是編碼錯誤，找了老半天竟然是系統不支援字符的窘境。</p>
<p>這個漏洞，一直到2010年才得以修復，MySQL端出了一個叫做utf8mb4的字符集來在MySQL內部使用，後面的mb4意思是most bytes 4，表示支援最多四個位元組啦，這樣就可以順利插入生僻字或是Emoji表情符號了。有趣的是官方端出utf8mb4時(這才是真正的UTF-8字符集)就統一將原本的utf8改名為utf8mb3了，也許是容易分辨吧!</p>
<h3 id="11-3-那我如果想要從utf8轉換到utf8mb4會不會不相容，空間與速度的變化"><a href="#11-3-那我如果想要從utf8轉換到utf8mb4會不會不相容，空間與速度的變化" class="headerlink" title="11.3. 那我如果想要從utf8轉換到utf8mb4會不會不相容，空間與速度的變化?"></a>11.3. 那我如果想要從utf8轉換到utf8mb4會不會不相容，空間與速度的變化?</h3><p>utf8與utf8mb4差別是在後者多了一個位元組，但兩者都是相同的儲存特性、相同的編碼，所以網站在升級到utf8mb4時，是不用擔心字元轉換出現亂碼或資料遺失的問題，網頁可以正常顯示。</p>
<p>官方資料也有針對這項疑問作出解釋：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">For a BMP character, utf8mb4 and utf8mb3 have identical storage characteristics: same code values, same encoding, same length.</span><br></pre></td></tr></table></figure>

<p>也就是強調不用擔心轉換字符的問題，程式編碼等都是相同的。</p>
<h3 id="11-4-utf8mb4-unicode-ci-vs-utf8mb4-general-ci"><a href="#11-4-utf8mb4-unicode-ci-vs-utf8mb4-general-ci" class="headerlink" title="11.4. utf8mb4_unicode_ci vs utf8mb4_general_ci"></a>11.4. utf8mb4_unicode_ci vs utf8mb4_general_ci</h3><p>xxx_general_ci與xxx_unicode_ci 是一種連線校對的規則，這兩項的差別，也是很多人在操作時不知道如何選擇的地方，在這邊會詳細介紹他的功能和兩者的差別，幫助你選擇。</p>
<p>general版本比unicode來的快速，但是相對的準確率沒有unicode來的精準，會存在一些的錯誤，原因是因為Unicode支持擴展字符集，他的文字涵蓋率可說無論全球哪種文字，只要保存成Unicode編碼都可以正常解釋，但也因為編碼體積比較大，佔網站伺服器空間較多，所以速度會稍微慢一點；general不支持擴展字集，是比較古老的校對規則，準確率沒有這麼高但是速度也相對快速。</p>
<p><strong>這兩項連線校對規則最經典的不同就是發生在以下這個字元「ß」</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">若在utf8_general_ci 他會顯示為ß = s</span><br><span class="line">在utf8_unicode_ci 則會顯示為ß = ss</span><br></pre></td></tr></table></figure>

<p><strong>而在MySQL官方網站則將這現象做了一個總結方便使用者做選擇：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">utf8_general_ci also is satisfactory for both German and French, except that ß is equal to s, and not to ss. </span><br><span class="line">If this is acceptable for your application, you should use utf8_general_ci because it is faster. </span><br><span class="line">If this is not acceptable (for example, if you require German dictionary order), use utf8_unicode_ci because it is more accurate.</span><br></pre></td></tr></table></figure>

<p>當架設多國語言網站遇到德文與法文翻譯時，general可能會出現小錯誤，但官方認為若是一般使用可以選擇general版本，因為速度較快，建議若是有字典，需要正確率高的文字需求，則建議使用準確率極高的Unicode版本。</p>
<p>而前述都是舉例原本的utf8做解釋，若套用成utf8mb4_general_ci或是utf8mb_unicode_ci的連線校對也是跟utf8的舉例一樣的，只是就如同前面所說的，生僻字與特殊符號能否正確顯示的差別而已。</p>
<h3 id="11-5-重點整理"><a href="#11-5-重點整理" class="headerlink" title="11.5. 重點整理"></a>11.5. 重點整理</h3><ul>
<li>MySQL utf8無法顯示生僻字與Emoji表情符號，utf8mb4可以。</li>
<li>原本MySQL內的utf8不是一般的UTF-8，他只有三個位元組，utf8mb4才是四個位元組，是真正的UTF-8字符集。</li>
<li>utf8轉utf8mb4不會發生不相容的問題。</li>
<li>utf8mb4_unicode_ci 準確但比較慢utf8mb4_general_ci 速度快但相對不準確。</li>
</ul>
<h2 id="12-全字庫-中文標準交換碼"><a href="#12-全字庫-中文標準交換碼" class="headerlink" title="12. 全字庫 中文標準交換碼"></a>12. 全字庫 中文標準交換碼</h2><h3 id="如何輸入罕用字"><a href="#如何輸入罕用字" class="headerlink" title="如何輸入罕用字"></a>如何輸入罕用字</h3><p>本文將介紹如何輸入罕用字，讓它可以跨各種作業系統及各文件編輯器，放上了網頁也沒問題。</p>
<p>到CNS11643網站 <a target="_blank" rel="noopener" href="http://www.cns11643.gov.tw/">http://www.cns11643.gov.tw/</a>→ 依部首或注音查「字」→ 找出該字的 unicode→ 到 word 輸入 unicode→ 輸入完按「Alt+x」→ 複製該字</p>
<h3 id="如何造字"><a href="#如何造字" class="headerlink" title="如何造字"></a>如何造字</h3><p>詳細可以參考國立高雄大學這篇 <a target="_blank" rel="noopener" href="https://adm.nuk.edu.tw/nukword/document2.htm#Win10">造字集步驟</a></p>
<h2 id="13-參考資源"><a href="#13-參考資源" class="headerlink" title="13. 參考資源"></a>13. 參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://std.tn.edu.tw/sis/userfont/%E5%A6%82%E4%BD%95%E8%BC%B8%E5%85%A5%E7%BD%95%E7%94%A8%E5%AD%97.htm">如何輸入罕用字</a></li>
<li><a target="_blank" rel="noopener" href="https://adm.nuk.edu.tw/nukword/document2.htm#Win10">造字集步驟</a></li>
<li><a target="_blank" rel="noopener" href="https://adm.nuk.edu.tw/nukeudc/nukeudc.htm">罕字表</a></li>
<li><a target="_blank" rel="noopener" href="https://www.readfog.com/a/1638084002220969984">Unicode、UTF-8、UTF-16，終於懂了</a></li>
<li><a target="_blank" rel="noopener" href="http://www.chi2ko.com/tool/CJK.htm">字体编辑用中日韩汉字Unicode编码表</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cadch.com/modules/news/article.php?storyid=198">一次搞懂MySQL utf8與utf8mb4的差別，general與unicode到底怎麼用??看完不再霧煞煞包準你能懂!</a></li>
<li><a target="_blank" rel="noopener" href="https://home.unicode.org/">Unicode官網</a></li>
<li><a target="_blank" rel="noopener" href="https://www.emojiall.com/zh-hant/unicode-version-list">unicode版本</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10198444">c#難字處理</a></li>
<li><a target="_blank" rel="noopener" href="https://ignatius1895.pixnet.net/blog/post/68072357-%E5%AD%97%E5%85%83%E7%B7%A8%E7%A2%BC%E8%88%87%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88(%E4%B8%80)%EF%BC%9A%E5%89%8D%E8%A8%80">字元編碼與程式設計(一)：前言</a></li>
<li><a target="_blank" rel="noopener" href="https://blogger.tigernaxo.com/post/webtech/eudc/">[WebTech] 把電腦的難字造字檔用 FontForge 轉為字型放到網頁上使用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gushiciku.cn/pl/ggY5/zh-hk">ASCII、Unicode、GBK、UTF-8的愛恨糾葛</a></li>
<li><a target="_blank" rel="noopener" href="https://kknews.cc/zh-tw/code/e4eao2n.html">「底層原理」Unicode與UTF-8的區別</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f89eaa1eb5ee">刨根究底字符编码之七——ANSI编码与代码页(Code Page)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/cnhk1225/article/details/40822645">编码介绍 ASCII与Unicode, codepage, utf-8</a></li>
<li><a target="_blank" rel="noopener" href="https://www.biaodianfu.com/python-charset.html">字符编码问题及Python解决方案</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/gofreight_hq/python-diving-unicode-%E6%B7%B1%E5%85%A5%E6%B7%BA%E5%87%BA-8cdbee3fe81c">Python diving — Unicode 深入淺出</a></li>
<li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/175187">TTF里都有什么</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/03/05/2022-03-05%20Docker%20%E7%B3%BB%E5%88%97%20-%20(6)%20Docker%20compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/05/2022-03-05%20Docker%20%E7%B3%BB%E5%88%97%20-%20(6)%20Docker%20compose/" class="post-title-link" itemprop="url">docker 系列 - (6) Docker compose</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-03-05 17:14:00" itemprop="dateCreated datePublished" datetime="2022-03-05T17:14:00+08:00">2022-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-03-11 14:48:00" itemprop="dateModified" datetime="2022-03-11T14:48:00+08:00">2022-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>30 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Compose-簡介"><a href="#Compose-簡介" class="headerlink" title="Compose 簡介"></a>Compose 簡介</h2><p>一個環境的建置可以透過compose 方式來設計與配置。</p>
<p><img src="https://i.imgur.com/hVzonOL.png" alt="docker-compose-intro"></p>
<h2 id="基本語法結構"><a href="#基本語法結構" class="headerlink" title="基本語法結構"></a>基本語法結構</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span> <span class="comment">#compose 版本</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> <span class="comment"># 容器</span></span><br><span class="line">  <span class="attr">servicename:</span> <span class="comment"># 服務名字，這個名字也是内部 bridge網路可以使用的 DNS name </span></span><br><span class="line">    <span class="attr">image:</span> <span class="comment"># 鏡像的名字</span></span><br><span class="line">    <span class="attr">command:</span> <span class="comment"># 可選，如果設置，則會覆蓋默認鏡像裡的 CMD命令</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="comment"># 可選，相當於 docker run裡的 --env</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># 可選，相當於docker run裡的 -v</span></span><br><span class="line">    <span class="attr">networks:</span> <span class="comment"># 可選，相當於 docker run裡的 --network</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># 可選，相當於 docker run裡的 -p</span></span><br><span class="line">  <span class="attr">servicename2:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> <span class="comment"># 可選，相當於 docker volume create</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span> <span class="comment"># 可選，相當於 docker network create</span></span><br></pre></td></tr></table></figure>



<p>以 Python Flask + Redis练习：为例子，改造成一个docker-compose文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker image pull redis</span><br><span class="line">docker image build -t flask-demo .</span><br><span class="line"></span><br><span class="line"><span class="comment"># create network</span></span><br><span class="line">docker network create -d bridge demo-network</span><br><span class="line"></span><br><span class="line"><span class="comment"># create container</span></span><br><span class="line">docker container run -d --name redis-server --network demo-network redis</span><br><span class="line">docker container run -d --network demo-network --name flask-demo --<span class="built_in">env</span> REDIS_HOST=redis-server -p 5000:5000 flask-demo</span><br></pre></td></tr></table></figure>

<p>docker-compose.yml 文件如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-demo:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span> <span class="comment">#創建一個deom-network網路，不填寫參數預設建立bridge type網路</span></span><br></pre></td></tr></table></figure>



<h2 id="docker-compose命令行基本使用"><a href="#docker-compose命令行基本使用" class="headerlink" title="docker-compose命令行基本使用"></a>docker-compose命令行基本使用</h2><p>先將<code>docker-compose.yml</code>檔案放到上次練習的資料夾底下，並使用之前建立好的<code>flask-demo</code>鏡像檔。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/flask_redis_practice# tree</span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── Dockerfile</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-up"><a href="#docker-compose-up" class="headerlink" title="docker-compose up"></a>docker-compose up</h3><p>我們開始學習的第一個指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p>我們會看到container 名稱會以資料夾名稱 + 鏡像名稱 + 數字(flask_redis_practice_redis-server_1) ，這個是跟後續擴容有關的設計，當然我們也可以在compose 檔設定自己定義的名稱</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up</span><br><span class="line">Creating flask_redis_practice_flask-demo_1   ... done</span><br><span class="line">Creating flask_redis_practice_redis-server_1 ... done</span><br><span class="line">Attaching to flask_redis_practice_redis-server_1, flask_redis_practice_flask-demo_1</span><br><span class="line">redis-server_1  | 1:C 07 Mar 2022 02:41:20.371 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">redis-server_1  | 1:C 07 Mar 2022 02:41:20.371 # Redis version=6.2.6, bits=64, commit=00000000, modified=0, pid=1, just started</span><br><span class="line">redis-server_1  | 1:C 07 Mar 2022 02:41:20.371 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span><br><span class="line">redis-server_1  | 1:M 07 Mar 2022 02:41:20.372 * monotonic clock: POSIX clock_gettime</span><br><span class="line">redis-server_1  | 1:M 07 Mar 2022 02:41:20.372 * Running mode=standalone, port=6379.</span><br><span class="line">redis-server_1  | 1:M 07 Mar 2022 02:41:20.372 # Server initialized</span><br><span class="line">redis-server_1  | 1:M 07 Mar 2022 02:41:20.372 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br><span class="line">redis-server_1  | 1:M 07 Mar 2022 02:41:20.372 * Ready to accept connections</span><br><span class="line">flask-demo_1    |  * Serving Flask app &#x27;app.py&#x27; (lazy loading)</span><br><span class="line">flask-demo_1    |  * Environment: production</span><br><span class="line">flask-demo_1    |    WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">flask-demo_1    |    Use a production WSGI server instead.</span><br><span class="line">flask-demo_1    |  * Debug mode: off</span><br><span class="line">flask-demo_1    |  * Running on all addresses.</span><br><span class="line">flask-demo_1    |    WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">flask-demo_1    |  * Running on http://172.19.0.2:5000/ (Press CTRL+C to quit)</span><br><span class="line">flask-demo_1    | 172.19.0.1 - - [07/Mar/2022 02:41:39] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">flask-demo_1    | 172.19.0.1 - - [07/Mar/2022 02:41:39] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">flask-demo_1    | 172.19.0.1 - - [07/Mar/2022 02:41:40] &quot;GET / HTTP/1.1&quot; 200 -</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose-up-d"><a href="#docker-compose-up-d" class="headerlink" title="docker-compose up -d"></a>docker-compose up -d</h3><p><code>ctrl + c</code>退出互動模式後，如果想讓環境運行在後台，可加參數 <code>-d</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>執行如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up -d</span><br><span class="line">Starting flask_redis_practice_redis-server_1 ... <span class="keyword">done</span></span><br><span class="line">Starting flask_redis_practice_flask-demo_1   ... <span class="keyword">done</span></span><br><span class="line">kite@host04:~/Desktop/flask_redis_practice$ </span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-logs"><a href="#docker-compose-logs" class="headerlink" title="docker-compose logs"></a>docker-compose logs</h3><p>這個模式下，如果還想看相關log我們可以使用<code>docker-compose logs</code> 或<code>docker-compose logs -f</code>持續動態查看。</p>
<h3 id="docker-compose-ps"><a href="#docker-compose-ps" class="headerlink" title="docker-compose ps"></a>docker-compose ps</h3><p>透過<code>docker-compose ps</code>查看運行的內容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose ps</span><br><span class="line">               Name                              Command               State                    Ports                  </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------</span><br><span class="line">flask_redis_practice_flask-demo_1     flask run -h 0.0.0.0             Up      0.0.0.0:8080-&gt;5000/tcp,:::8080-&gt;5000/tcp</span><br><span class="line">flask_redis_practice_redis-server_1   docker-entrypoint.sh redis ...   Up      6379/tcp      </span><br></pre></td></tr></table></figure>

<p><strong>注意：這個指定一定要在docker-compose檔案所在的資料夾執行才有效</strong></p>
<p>我們稍微看一下相關指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ docker-compose</span><br><span class="line">Options:</span><br><span class="line">  -f, --file FILE             Specify an alternate compose file</span><br><span class="line">                              (default: docker-compose.yml)</span><br><span class="line">  -p, --project-name NAME     Specify an alternate project name</span><br><span class="line">                              (default: directory name)</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果compose檔名稱要指定的話，加<code>-f</code>參數即可，跟dockerfile的概念一樣。另外也有看到一個 <code>project-name</code>這個就是我們剛剛說的container名稱會以資料夾名稱的命名方式，如果不喜歡也可以使用<code>-p</code>的指令方式指定。</p>
<h3 id="docker-compose-stop"><a href="#docker-compose-stop" class="headerlink" title="docker-compose stop"></a>docker-compose stop</h3><p>如果想要停止compose也是可以做到的，這個方式很聰明，可以一次性將整個環境的容器一起停止處理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure>

<p>如果去看docker container 、docker network 都會有compose 建立出來的容器與bridge</p>
<p>刪除沒有被使用的資源可以使用以下指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -f</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose-p"><a href="#docker-compose-p" class="headerlink" title="docker-compose -p"></a>docker-compose -p</h3><p>我們也可以自定義專案名稱</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose -p myproject up -d</span><br></pre></td></tr></table></figure>

<p>使用指令查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose -p myproject ps</span><br><span class="line">          Name                        Command               State                    Ports                  </span><br><span class="line">------------------------------------------------------------------------------------------------------------</span><br><span class="line">myproject_flask-demo_1     flask run -h 0.0.0.0             Up      0.0.0.0:8080-&gt;5000/tcp,:::8080-&gt;5000/tcp</span><br><span class="line">myproject_redis-server_1   docker-entrypoint.sh redis ...   Up      6379/tcp  </span><br></pre></td></tr></table></figure>

<p>通過<code>stop</code>指令再批次停止</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose -p myproject stop</span><br><span class="line">Stopping myproject_redis-server_1 ... done</span><br><span class="line">Stopping myproject_flask-demo_1   ... done</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-rm"><a href="#docker-compose-rm" class="headerlink" title="docker-compose-rm"></a>docker-compose-rm</h3><p>通過<code>rm</code>指令刪除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose -p myproject rm</span><br><span class="line">Going to remove myproject_redis-server_1, myproject_flask-demo_1</span><br><span class="line">Are you sure? [yN] y</span><br><span class="line">Removing myproject_redis-server_1 ... done</span><br><span class="line">Removing myproject_flask-demo_1   ... done</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-build"><a href="#docker-compose-build" class="headerlink" title="docker-compose build"></a>docker-compose build</h3><p>試著使用build方式來玩,，建立一個資料夾名稱為<code>flask_web</code>，將<code>app.py</code>、<code>Dockerfile</code>移至<code>flask_web</code>底下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ tree</span><br><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── flask_web</span><br><span class="line">    ├── app.py</span><br><span class="line">    └── Dockerfile</span><br></pre></td></tr></table></figure>

<p><code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=os.environ.get(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>), port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello Container World! I have been seen <span class="subst">&#123;redis.get(<span class="string">&#x27;hits&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span> times and my hostname is <span class="subst">&#123;socket.gethostname()&#125;</span>.\n&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>.<span class="number">5</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask redis &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> /src &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R flask:flask /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> flask</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> FLASK_APP=app.py REDIS_HOST=redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>修改<code>docker-compose.yml</code> 檔：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./flask_web</span></span><br><span class="line">    <span class="comment">#image: flask-demo:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span></span><br></pre></td></tr></table></figure>

<p>我們添加了<code>build: ./flask_web</code>，預設會抓這個資料夾底下的Dockerfile名稱進行build image</p>
<p>compose build 指令玩一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose build</span><br><span class="line">redis-server uses an image, skipping</span><br><span class="line">Building flask-demo</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/8 : FROM python:3.9.5-slim</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">c71955050276</span></span><br><span class="line">Step 2/8 : RUN pip install flask redis &amp;&amp;     groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp;     mkdir /src &amp;&amp;     chown -R ...</span><br><span class="line">...</span><br><span class="line">Successfully built 626b99e2547c</span><br><span class="line">Successfully tagged flask_redis_practice_flask-demo:latest</span><br><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker images </span><br></pre></td></tr></table></figure>

<p>看一下image 清單，我們會發現image名稱會以當時的資料夾名稱為前綴：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker images </span><br><span class="line">REPOSITORY                        TAG                IMAGE ID       CREATED          SIZE</span><br><span class="line">flask_redis_practice_flask-demo   latest             626b99e2547c   36 seconds ago   129MB</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-build-文件格式-add-image-name"><a href="#docker-compose-build-文件格式-add-image-name" class="headerlink" title="docker-compose build 文件格式 - add image name"></a>docker-compose build 文件格式 - add image name</h3><p>也可以在docker-compose文件中指定image名稱：</p>
<p><code>docker-compose.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./flask_web</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-kite:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span></span><br></pre></td></tr></table></figure>

<p>結果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker images </span><br><span class="line">REPOSITORY       TAG                IMAGE ID       CREATED          SIZE</span><br><span class="line">flask-kite       latest             33a0bf4d2428   11 seconds ago   129MB</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-build-文件格式-context、dockefile-name"><a href="#docker-compose-build-文件格式-context、dockefile-name" class="headerlink" title="docker-compose build 文件格式 - context、dockefile name"></a>docker-compose build 文件格式 - context、dockefile name</h3><p>先將<code>Dockerfile</code>名稱改為<code>Dockerfile.dev</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ tree</span><br><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── flask_web</span><br><span class="line">    ├── app.py</span><br><span class="line">    └── Dockerfile.dev</span><br></pre></td></tr></table></figure>

<p>在docker-compose文件中指定dockerfile檔案名稱：</p>
<p><code>docker-compose.dev</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./flask_web</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.dev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-kite:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span></span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-pull"><a href="#docker-compose-pull" class="headerlink" title="docker-compose pull"></a>docker-compose pull</h3><p>也可以使用docker-compose pull進行image build：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose pull</span><br><span class="line">Pulling flask-demo   ... done</span><br><span class="line">Pulling redis-server ... done</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-–help"><a href="#docker-compose-–help" class="headerlink" title="docker-compose –help"></a>docker-compose –help</h3><p>查找相關指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose --help</span><br><span class="line">Define and run multi-container applications with Docker.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  docker-compose [-f &lt;arg&gt;...] [--profile &lt;name&gt;...] [options] [--] [COMMAND] [ARGS...]</span><br><span class="line">  docker-compose -h|--help</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --file FILE             Specify an alternate compose file</span><br><span class="line">                              (default: docker-compose.yml)</span><br><span class="line">  -p, --project-name NAME     Specify an alternate project name</span><br><span class="line">                              (default: directory name)</span><br><span class="line">  --profile NAME              Specify a profile to enable</span><br><span class="line">  -c, --context NAME          Specify a context name</span><br><span class="line">  --verbose                   Show more output</span><br><span class="line">  --log-level LEVEL           Set log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)</span><br><span class="line">  --ansi (never|always|auto)  Control when to print ANSI control characters</span><br><span class="line">  --no-ansi                   Do not print ANSI control characters (DEPRECATED)</span><br><span class="line">  -v, --version               Print version and exit</span><br><span class="line">  -H, --host HOST             Daemon socket to connect to</span><br><span class="line"></span><br><span class="line">  --tls                       Use TLS; implied by --tlsverify</span><br><span class="line">  --tlscacert CA_PATH         Trust certs signed only by this CA</span><br><span class="line">  --tlscert CLIENT_CERT_PATH  Path to TLS certificate file</span><br><span class="line">  --tlskey TLS_KEY_PATH       Path to TLS key file</span><br><span class="line">  --tlsverify                 Use TLS and verify the remote</span><br><span class="line">  --skip-hostname-check       Don&#x27;t check the daemon&#x27;s hostname against the</span><br><span class="line">                              name specified in the client certificate</span><br><span class="line">  --project-directory PATH    Specify an alternate working directory</span><br><span class="line">                              (default: the path of the Compose file)</span><br><span class="line">  --compatibility             If set, Compose will attempt to convert keys</span><br><span class="line">                              in v3 files to their non-Swarm equivalent (DEPRECATED)</span><br><span class="line">  --env-file PATH             Specify an alternate environment file</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  build              Build or rebuild services</span><br><span class="line">  config             Validate and view the Compose file</span><br><span class="line">  create             Create services</span><br><span class="line">  down               Stop and remove resources</span><br><span class="line">  events             Receive real time events from containers</span><br><span class="line">  exec               Execute a command in a running container</span><br><span class="line">  help               Get help on a command</span><br><span class="line">  images             List images</span><br><span class="line">  kill               Kill containers</span><br><span class="line">  logs               View output from containers</span><br><span class="line">  pause              Pause services</span><br><span class="line">  port               Print the public port for a port binding</span><br><span class="line">  ps                 List containers</span><br><span class="line">  pull               Pull service images</span><br><span class="line">  push               Push service images</span><br><span class="line">  restart            Restart services</span><br><span class="line">  rm                 Remove stopped containers</span><br><span class="line">  run                Run a one-off command</span><br><span class="line">  scale              Set number of containers for a service</span><br><span class="line">  start              Start services</span><br><span class="line">  stop               Stop services</span><br><span class="line">  top                Display the running processes</span><br><span class="line">  unpause            Unpause services</span><br><span class="line">  up                 Create and start containers</span><br><span class="line">  version            Show version information and quit</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose build --help</span><br><span class="line">Build or rebuild services.</span><br><span class="line"></span><br><span class="line">Services are built once and then tagged as `project_service`,</span><br><span class="line">e.g. `composetest_db`. If you change a service&#x27;s `Dockerfile` or the</span><br><span class="line">contents of its build directory, you can run `docker-compose build` to rebuild it.</span><br><span class="line"></span><br><span class="line">Usage: build [options] [--build-arg key=val...] [--] [SERVICE...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    --build-arg key=val     Set build-time variables for services.</span><br><span class="line">    --compress              Compress the build context using gzip.</span><br><span class="line">    --force-rm              Always remove intermediate containers.</span><br><span class="line">    -m, --memory MEM        Set memory limit for the build container.</span><br><span class="line">    --no-cache              Do not use cache when building the image.</span><br><span class="line">    --no-rm                 Do not remove intermediate containers after a successful build.</span><br><span class="line">    --parallel              Build images in parallel.</span><br><span class="line">    --progress string       Set type of progress output (auto, plain, tty).</span><br><span class="line">    --pull                  Always attempt to pull a newer version of the image.</span><br><span class="line">    -q, --quiet             Don&#x27;t print anything to STDOUT</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose-build-d-–build"><a href="#docker-compose-build-d-–build" class="headerlink" title="docker compose build -d –build"></a>docker compose build -d –build</h3><p>試著修改<code>app.py</code>檔</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=os.environ.get(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>), port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello Container World!I&#x27;m kite. I have been seen <span class="subst">&#123;redis.get(<span class="string">&#x27;hits&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span> times and my hostname is <span class="subst">&#123;socket.gethostname()&#125;</span>.\n&quot;</span></span><br></pre></td></tr></table></figure>

<p>在運行的過程中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose ps</span><br><span class="line">               Name                              Command               State                    Ports                  </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------</span><br><span class="line">flask_redis_practice_flask-demo_1     flask run -h 0.0.0.0             Up      0.0.0.0:8080-&gt;5000/tcp,:::8080-&gt;5000/tcp</span><br><span class="line">flask_redis_practice_redis-server_1   docker-entrypoint.sh redis ...   Up      6379/tcp   </span><br></pre></td></tr></table></figure>

<p>使用<code>--build</code>指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose build -d --build</span><br></pre></td></tr></table></figure>

<p>這個指令會發現檔案有發生改變，就會決定重新build，並且會直接重啟與運行容器，不用經過compose stop、compose rm、compose build、 compose up 過程，非常方便，結果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up -d --build</span><br><span class="line">Building flask-demo</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/8 : FROM python:3.9.5-slim</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">c71955050276</span></span><br><span class="line">Step 2/8 : RUN pip install flask redis &amp;&amp;     groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp;     mkdir /src &amp;&amp;     chown -R flask:flask /src</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Using cache</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">bbf517f842c7</span></span><br><span class="line">Step 3/8 : USER flask</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Using cache</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">7b1d7b6407b8</span></span><br><span class="line">Step 4/8 : COPY app.py /src/app.py</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">47b63bef74ff</span></span><br><span class="line">Step 5/8 : WORKDIR /src</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 1da9b0391baf</span></span><br><span class="line">Removing intermediate container 1da9b0391baf</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">ccbca4bf8c09</span></span><br><span class="line">Step 6/8 : ENV FLASK_APP=app.py REDIS_HOST=redis</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 74c8fbb7fd95</span></span><br><span class="line">Removing intermediate container 74c8fbb7fd95</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">cc12a2e1af00</span></span><br><span class="line">Step 7/8 : EXPOSE 5000</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 201a42960e97</span></span><br><span class="line">Removing intermediate container 201a42960e97</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">3731d50ee226</span></span><br><span class="line">Step 8/8 : CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 3f4fea9f7156</span></span><br><span class="line">Removing intermediate container 3f4fea9f7156</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">df6ac55a1b2d</span></span><br><span class="line">Successfully built df6ac55a1b2d</span><br><span class="line">Successfully tagged flask-kite:latest</span><br><span class="line">flask_redis_practice_redis-server_1 is up-to-date</span><br><span class="line">Recreating flask_redis_practice_flask-demo_1 ... done</span><br><span class="line">kite@host04:~/Desktop/flask_redis_practice$ </span><br></pre></td></tr></table></figure>

<h3 id="docker-compose-d"><a href="#docker-compose-d" class="headerlink" title="docker compose -d"></a>docker compose -d</h3><p>目前comopose狀態：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose ps</span><br><span class="line">[sudo] password for kite: </span><br><span class="line">               Name                              Command               State                    Ports                  </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------</span><br><span class="line">flask_redis_practice_flask-demo_1     flask run -h 0.0.0.0             Up      0.0.0.0:8080-&gt;5000/tcp,:::8080-&gt;5000/tcp</span><br><span class="line">flask_redis_practice_redis-server_1   docker-entrypoint.sh redis ...   Up      6379/tcp    </span><br></pre></td></tr></table></figure>

<h4 id="add-image"><a href="#add-image" class="headerlink" title="add image"></a>add image</h4><p>我們添加一個busybox ，修改docker-compose檔</p>
<p><code>docker-compose.dev</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./flask_web</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.dev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-kite:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">  <span class="attr">busybox:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">sh</span> <span class="string">-c</span> <span class="string">&quot;while true;do sleep 3600; done&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span></span><br></pre></td></tr></table></figure>

<p>接著，我們再試著下<code>docker-compose up -d</code>，我們會發現有出現create busybox的訊息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up -d</span><br><span class="line">flask_redis_practice_flask-demo_1 is up-to-date</span><br><span class="line">flask_redis_practice_redis-server_1 is up-to-date</span><br><span class="line">Creating flask_redis_practice_busybox_1 ... done</span><br></pre></td></tr></table></figure>

<h4 id="remove-image"><a href="#remove-image" class="headerlink" title="remove image"></a>remove image</h4><p>再試著將剛剛的busybox移除 ，修改docker-compose檔</p>
<p><code>docker-compose.dev</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">flask-demo:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./flask_web</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.dev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flask-kite:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:5000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">demo-network</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">demo-network:</span></span><br></pre></td></tr></table></figure>

<p>再執行一次<code>docker-compose up -d</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up -d</span><br><span class="line">WARNING: Found orphan containers (flask_redis_practice_busybox_1) for this project. If you removed or renamed this service in your compose file, you can run this command with the --remove-orphans flag to clean it up.</span><br><span class="line">flask_redis_practice_flask-demo_1 is up-to-date</span><br><span class="line">flask_redis_practice_redis-server_1 is up-to-date</span><br></pre></td></tr></table></figure>

<p>會出現警告：</p>
<blockquote>
<p>WARNING: Found orphan containers (flask_redis_practice_busybox_1) for this project. If you removed or renamed this service in your compose file, you can run this command with the –remove-orphans flag to clean it up.</p>
</blockquote>
<p>照著指令操作，移除busybox的指令需要<code>--remove-orphans</code>，執行如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/flask_redis_practice$ sudo docker-compose up -d --remove-orphans</span><br><span class="line">Removing orphan container &quot;flask_redis_practice_busybox_1&quot;</span><br><span class="line">flask_redis_practice_flask-demo_1 is up-to-date</span><br><span class="line">flask_redis_practice_redis-server_1 is up-to-date</span><br><span class="line">kite@host04:~/Desktop/flask_redis_practice$ </span><br></pre></td></tr></table></figure>



<h4 id="container-配置文件修改"><a href="#container-配置文件修改" class="headerlink" title="container 配置文件修改"></a>container 配置文件修改</h4><p>通常container 配置文件(使用volume 掛載本地文件)修改之後，要重啟container。而在compose 可以透過<code>docker compose restart</code>指令重啟。</p>
<p>這個指令只是重啟，並不是重新創建喔。</p>
<h3 id="更新操作小總結"><a href="#更新操作小總結" class="headerlink" title="更新操作小總結"></a>更新操作小總結</h3><p>我們常在專案會時常更新，比如更新鏡像、配置文件、增加service、刪除service，最常用的有二種</p>
<ol>
<li><p>刪除未使用的service</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d --remove-orphans</span><br></pre></td></tr></table></figure>
</li>
<li><p>container 配置文件修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>image 進行修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -d --build</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="docker-compose網路-上"><a href="#docker-compose網路-上" class="headerlink" title="docker-compose網路(上)"></a>docker-compose網路(上)</h2><p>暫補</p>
<h2 id="docker-compose網路-下"><a href="#docker-compose網路-下" class="headerlink" title="docker-compose網路(下)"></a>docker-compose網路(下)</h2><p>暫補</p>
<p>各別指定network</p>
<p>network default</p>
<p>network subnet</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/03/03/2022-03-03%20Docker%20%E7%B3%BB%E5%88%97%20-%20(5)%20Docker%E7%9A%84%E7%B6%B2%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/03/2022-03-03%20Docker%20%E7%B3%BB%E5%88%97%20-%20(5)%20Docker%E7%9A%84%E7%B6%B2%E8%B7%AF/" class="post-title-link" itemprop="url">docker 系列 - (5) Docker的網路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2022-03-03 17:14:00 / 修改時間：15:02:07" itemprop="dateCreated datePublished" datetime="2022-03-03T17:14:00+08:00">2022-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>53 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="網路基礎知識回顧"><a href="#網路基礎知識回顧" class="headerlink" title="網路基礎知識回顧"></a>網路基礎知識回顧</h2><p><a target="_blank" rel="noopener" href="https://twitter.com/manekinekko">作者Wassim Chegham</a></p>
<p><img src="https://i.imgur.com/OA8lKw3.jpg" alt="圖片"></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Taq5TV1K4XU">Will保哥 初學者都該了解的HTTP通訊協定基礎</a></p>
<h2 id="網路常用命令"><a href="#網路常用命令" class="headerlink" title="網路常用命令"></a>網路常用命令</h2><h3 id="IP地址查詢"><a href="#IP地址查詢" class="headerlink" title="IP地址查詢"></a>IP地址查詢</h3><p>Windows</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig</span><br></pre></td></tr></table></figure>

<p>Linux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr 或 ip a</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ac:f4:ef brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s1</span><br><span class="line">    inet 192.168.152.137/24 brd 192.168.152.255 scope global dynamic noprefixroute ens33</span><br><span class="line">       valid_lft 1200sec preferred_lft 1200sec</span><br><span class="line">    inet6 fe80::c252:7221:a2a5:42d9/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:80:62:9c:23 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:80ff:fe62:9c23/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: veth58b174d@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether b6:1c:f6:19:ec:c8 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::b41c:f6ff:fe19:ecc8/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>lo</code>：localhost</p>
<p><code>ens33</code>：對外網路</p>
<p><code>docker0</code>：docker內部網路</p>
<p><code>veth</code>：docker內部容器</p>
<h3 id="測試網路連通性"><a href="#測試網路連通性" class="headerlink" title="測試網路連通性"></a>測試網路連通性</h3><h4 id="ping命令"><a href="#ping命令" class="headerlink" title="ping命令"></a>ping命令</h4><p>測試IP連通性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# ping 192.168.152.139</span><br><span class="line">PING 192.168.152.139 (192.168.152.139) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.152.139: icmp_seq=1 ttl=64 time=0.614 ms</span><br><span class="line">64 bytes from 192.168.152.139: icmp_seq=2 ttl=64 time=0.521 ms</span><br></pre></td></tr></table></figure>



<h3 id="測試端口連通性"><a href="#測試端口連通性" class="headerlink" title="測試端口連通性"></a>測試端口連通性</h3><h4 id="telnet命令"><a href="#telnet命令" class="headerlink" title="telnet命令"></a>telnet命令</h4><p>測試(port)連通性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# telnet www.google.com.tw 80</span><br><span class="line">Trying 142.251.43.3...</span><br><span class="line">Connected to www.google.com.tw.</span><br></pre></td></tr></table></figure>



<h3 id="測試路徑"><a href="#測試路徑" class="headerlink" title="測試路徑"></a>測試路徑</h3><h4 id="traceroute命令"><a href="#traceroute命令" class="headerlink" title="traceroute命令"></a>traceroute命令</h4><p>路徑探測跟蹤</p>
<ul>
<li><p>Linux</p>
<ul>
<li>tracepath</li>
</ul>
</li>
<li><p>Windows</p>
<ul>
<li>TRACERT.EXE</li>
</ul>
</li>
</ul>
<h3 id="測試web服務"><a href="#測試web服務" class="headerlink" title="測試web服務"></a>測試web服務</h3><h4 id="curl命令"><a href="#curl命令" class="headerlink" title="curl命令"></a>curl命令</h4><p>請求web服務的工具。它的名字就是客戶端(client)的URL工具的意思。</p>
<p>它的功能非常強大，如果熟練的話，完全可以取代Postman這一類的圖形界面工具。</p>
<p>可以參考 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2019/09/curl-reference.html">阮一峰 curl 的用法指南</a></p>
<h2 id="容器網路需要解決哪些問題？"><a href="#容器網路需要解決哪些問題？" class="headerlink" title="容器網路需要解決哪些問題？"></a>容器網路需要解決哪些問題？</h2><h3 id="第一個問題實驗"><a href="#第一個問題實驗" class="headerlink" title="第一個問題實驗"></a>第一個問題實驗</h3><p>首先先創建一個容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container run -d --rm --name box01 busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</span><br></pre></td></tr></table></figure>

<p>進入容器後，使用<code>ip a</code>，看到<code>etho0</code>開頭有一個ip為<code>172.17.0.2</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker exec -it box01 sh</span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<h3 id="第二個問題實驗"><a href="#第二個問題實驗" class="headerlink" title="第二個問題實驗"></a>第二個問題實驗</h3><p>退出容器後，在host使用ping觀查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.184 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.040 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.032 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="第三個問題實驗"><a href="#第三個問題實驗" class="headerlink" title="第三個問題實驗"></a>第三個問題實驗</h3><p>實驗待補</p>
<h3 id="第四個問題實驗"><a href="#第四個問題實驗" class="headerlink" title="第四個問題實驗"></a>第四個問題實驗</h3><p>再創第二個容器<code>box02</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container run -d --rm --name box02 busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</span><br></pre></td></tr></table></figure>

<p>查看容器IP，IP為<code>172.17.0.3</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container exec -it box02 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>



<p>在<code>box02</code>容器內去ping <code>box01</code>：</p>
<ul>
<li><p>box01</p>
<ul>
<li>IP 172.17.0.2</li>
</ul>
</li>
<li><p>box02</p>
<ul>
<li>IP 172.17.0.3</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container exec -it box02 ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.060 ms</span><br><span class="line">64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.066 ms</span><br></pre></td></tr></table></figure>



<h3 id="第五個問題實驗"><a href="#第五個問題實驗" class="headerlink" title="第五個問題實驗"></a>第五個問題實驗</h3><p>創建一個<code>web01</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container run -d -p 8080:80 --name web01 nginx</span><br></pre></td></tr></table></figure>

<p>查看一下<code>host04</code>IP：</p>
<p><code>192.168.152.137</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:ac:f4:ef brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp2s1</span><br><span class="line">    inet 192.168.152.137/24 brd 192.168.152.255 scope global dynamic noprefixroute ens33</span><br><span class="line">       valid_lft 1637sec preferred_lft 1637sec</span><br><span class="line">    inet6 fe80::c252:7221:a2a5:42d9/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:80:62:9c:23 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:80ff:fe62:9c23/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: veth2024750@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether f6:0a:2b:a1:86:df brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::f40a:2bff:fea1:86df/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: veth3872608@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 8e:84:3d:c0:57:7c brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::8c84:3dff:fec0:577c/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">19: vetha5bf5e2@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 7a:26:38:e8:03:8f brd ff:ff:ff:ff:ff:ff link-netnsid 2</span><br><span class="line">    inet6 fe80::7826:38ff:fee8:38f/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>我們利用<code>host05</code>使用<code>curl</code>來 對 <code>host04</code> IP <code>192.168.152.137:8080</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kite@host5:~/Desktop$ curl 192.168.152.137:8080</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>





<h3 id="第一個問題：為什麼容器內會獲取到172-17-0-2-的IP地址"><a href="#第一個問題：為什麼容器內會獲取到172-17-0-2-的IP地址" class="headerlink" title="第一個問題：為什麼容器內會獲取到172.17.0.2 的IP地址"></a>第一個問題：為什麼容器內會獲取到172.17.0.2 的IP地址</h3><h3 id="第二個問題：為什麼HOST可以PING成功容器？"><a href="#第二個問題：為什麼HOST可以PING成功容器？" class="headerlink" title="第二個問題：為什麼HOST可以PING成功容器？"></a>第二個問題：為什麼HOST可以PING成功容器？</h3><h3 id="第三個問題：為什麼容器可以PING外部網路成功？"><a href="#第三個問題：為什麼容器可以PING外部網路成功？" class="headerlink" title="第三個問題：為什麼容器可以PING外部網路成功？"></a>第三個問題：為什麼容器可以PING外部網路成功？</h3><h3 id="第四個問題：為什麼容器與容器之間可以互通？"><a href="#第四個問題：為什麼容器與容器之間可以互通？" class="headerlink" title="第四個問題：為什麼容器與容器之間可以互通？"></a>第四個問題：為什麼容器與容器之間可以互通？</h3><h3 id="第五個問題：PORT轉發是怎麼回事？"><a href="#第五個問題：PORT轉發是怎麼回事？" class="headerlink" title="第五個問題：PORT轉發是怎麼回事？"></a>第五個問題：PORT轉發是怎麼回事？</h3><h2 id="容器間通信之bridge網路"><a href="#容器間通信之bridge網路" class="headerlink" title="容器間通信之bridge網路"></a>容器間通信之bridge網路</h2><p>來教一個新指令<code>docker network ls</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">118c43b92cc6   bridge    bridge    local</span><br><span class="line">60cb3d796e6b   host      host      local</span><br><span class="line">c5b7b2fbb219   none      null      local</span><br></pre></td></tr></table></figure>

<p>這是目前的container網路相關配置，我們再使用<code>docker network inspect 118c</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network inspect 118</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;118c43b92cc662ecc4e86dc17d63fc599bcc3d0d39547715f92ab77c4fcc2b6c&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-02-24T11:01:57.933731418+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: null,</span><br><span class="line">            #Here</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        #Here</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;794e99f196278ea048b963bbac0845ad228a768ca9f787450d557b317f098f7e&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;web01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;df84f183d1fcd096c04e9f902000176b2bb25e7eb46e1c3a9e1c16b9d42c9642&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;cb69532a01df76e063aeaf5addaf921ff5e8f7fd273e6fa685b5e976c26e5355&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;box01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;1d6f5ea9838a274bed7bbb4df5ed66a4071119aec190414de7ca0d12f089dd14&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ef42984b47681f9f0d923dc85902e952a6a53adcc5d7f37cb2c4290711945e62&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;box02&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;3153006bfa4e61c83a9edf44cdf4d666557603c74ef1bcacd8fcac01c43eef10&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;</span><br><span class="line">            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span><br><span class="line">            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整理後，抽出幾個部分說明</p>
<p>Config</p>
<p>gateway為<code>172.17.0.1</code></p>
<pre><code>        &quot;Config&quot;: [
            &#123;
                &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,
                &quot;Gateway&quot;: &quot;172.17.0.1&quot;
            &#125;
</code></pre>
<p>Containers</p>
<p>這個bridge就扮演了switch的角色，container都接這個bridge上面，可以再參考下面的圖片。</p>
<p>因此有了這個<code>docker0</code>，就可以讓container彼此之間進行交互溝通。</p>
<p>並且container在預設建立時，沒有指令要使用哪個bridge，那默認就會使用<code>docker0</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">    &quot;794e99f196278ea048b963bbac0845ad228a768ca9f787450d557b317f098f7e&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;web01&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;df84f183d1fcd096c04e9f902000176b2bb25e7eb46e1c3a9e1c16b9d42c9642&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:04&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.17.0.4/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;cb69532a01df76e063aeaf5addaf921ff5e8f7fd273e6fa685b5e976c26e5355&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;box01&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;1d6f5ea9838a274bed7bbb4df5ed66a4071119aec190414de7ca0d12f089dd14&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ef42984b47681f9f0d923dc85902e952a6a53adcc5d7f37cb2c4290711945e62&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;box02&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;3153006bfa4e61c83a9edf44cdf4d666557603c74ef1bcacd8fcac01c43eef10&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/fLELTcL.png" alt="Untitled"></p>
<h2 id="容器對外通訊之bridge網路"><a href="#容器對外通訊之bridge網路" class="headerlink" title="容器對外通訊之bridge網路"></a>容器對外通訊之bridge網路</h2><p><img src="https://i.imgur.com/U5mek0P.png" alt="network.drawio"></p>
<p>可以先安裝<code> sudo apt-get install -y bridge-utils</code>，接著我們下指令，我們會看到docker0有3個<code>interfaces</code>以<code>veth</code>開頭，就如我們上面圖片一樣的示意圖。因為我們有3個container所以就會有3個interface。</p>
<p>假設我們再刪掉一個container，再重新下<code>brctl show</code>指令，也就會發現少一個喔。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.024280629c23	no		veth2024750</span><br><span class="line">							            veth3872608</span><br><span class="line">               							vetha5bf5e2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我們複習一下</p>
<ol>
<li>如果<code>box01</code> ping <code>web01</code>能成功，路線會經過<code>docker0</code>過去。</li>
<li>我們<code>box01</code>往外網ping能成功，路線一樣會經過<code>docker0</code>往外丟。(前提是host主機本身也能連外網，這樣才能ping成功)</li>
</ol>
<p>那<code>docker0</code>怎麼走出去的，實際還是要看路由，可以使用<code>ip route</code>來看一下，其中 <code>default via 192.168.152.55</code> 就是<code>eth0</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# ip route</span><br><span class="line">default via 192.168.152.55 dev ens33 proto dhcp metric 100 </span><br><span class="line">169.254.0.0/16 dev ens33 scope link metric 1000 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class="line">192.168.152.0/24 dev ens33 proto kernel scope link src 192.168.152.137 metric 100 </span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/ATlSu1Y.png" alt="network.drawio"></p>
<p>如果<code>box01</code>要出去到外網時，因為是pirvate ip，因此到外網前會再透過<code>NAT</code>轉為成<code>eth0</code>的IP地址，而實際怎麼轉換的規則可以使用<code>iptables --list -t nat</code>來查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# iptables --list -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DOCKER     all  --  anywhere            !localhost/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">MASQUERADE  all  --  172.17.0.0/16        anywhere            </span><br><span class="line">MASQUERADE  tcp  --  172.17.0.4           172.17.0.4           tcp dpt:http</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">RETURN     all  --  anywhere             anywhere            </span><br><span class="line">DNAT       tcp  --  anywhere             anywhere             tcp dpt:http-alt to:172.17.0.4:80</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>參考資料</p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Security_Guide/s1-firewall-ipt-fwd.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Security_Guide/s1-firewall-ipt-fwd.html</a></p>
<h2 id="網路知識補充NAT"><a href="#網路知識補充NAT" class="headerlink" title="網路知識補充NAT"></a>網路知識補充NAT</h2><p>NAT的技術在解決什麼問題？</p>
<blockquote>
<p>IP不足的問題</p>
</blockquote>
<p>網路上進行通信必須要一個獨一無二的IP才能進行傳輸。</p>
<p>舉例來說，在家裡的筆電、桌機、平板都給一個私有IP，透過路由器後，會再轉換成公有IP。回程的時候再透過路由器將公有IP轉換為對應內部的IP。</p>
<p>NAT translates：</p>
<ul>
<li>Private to public</li>
<li>Public to private</li>
</ul>
<h2 id="創建和使用自定義bridge-上"><a href="#創建和使用自定義bridge-上" class="headerlink" title="創建和使用自定義bridge(上)"></a>創建和使用自定義bridge(上)</h2><p><img src="https://i.imgur.com/gxUx2r9.png"></p>
<p><code>docker network create -d [類型] [名稱]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d bridge mybridge</span><br></pre></td></tr></table></figure>

<p>其中<code>-d</code> 指的就是driver，因為network類型有很多種，以此為例，我們創建一個<code>bridge</code>類型。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建bridge名為mybridge</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker network create -d bridge mybridge</span><br><span class="line">020d342bf4a11304f4509d44ff64df2555918b2ff4d6664878254faba753d489</span><br><span class="line">root@host04:/home/kite/Desktop# docker network ls</span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">118c43b92cc6   bridge     bridge    local</span><br><span class="line">60cb3d796e6b   host       host      local</span><br><span class="line">020d342bf4a1   mybridge   bridge    local</span><br><span class="line">c5b7b2fbb219   none       null      local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看mybridge 172.18.0.0 ，還記得嗎？剛剛默認的bridge 是172.17.0.0</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker network inspect mybridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mybridge&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;020d342bf4a11304f4509d44ff64df2555918b2ff4d6664878254faba753d489&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-03-01T15:19:52.641431288+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="如何添加指定的bridge在container上？"><a href="#如何添加指定的bridge在container上？" class="headerlink" title="如何添加指定的bridge在container上？"></a>如何添加指定的bridge在container上？</h3><p>補上<code>--network mybridge</code>，完成！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container run -d --rm --name box03 --network mybridge busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>來看一下container設定內容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container inspect box03</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;408dbc15598a60ec6f57dbfd7ae080cc9bceb318bf307a19303b757d8d9e3265&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-03-01T07:21:15.326172232Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/bin/sh&quot;,</span><br><span class="line">		...</span><br><span class="line">		...</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Bridge&quot;: &quot;&quot;,</span><br><span class="line">			...</span><br><span class="line">			...</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;mybridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: [</span><br><span class="line">                        &quot;408dbc15598a&quot;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;020d342bf4a11304f4509d44ff64df2555918b2ff4d6664878254faba753d489&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;c3acfbc43272a5c1c9c01a1ff3c05faa7925e8f3b86617d24cac3d620f74be48&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.18.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="在一個container可否有2個bridge？"><a href="#在一個container可否有2個bridge？" class="headerlink" title="在一個container可否有2個bridge？"></a>在一個container可否有2個bridge？</h3><p>可以喔。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect bridge box03</span><br></pre></td></tr></table></figure>

<p>查看一下container：</p>
<p>這個<code>box03</code>拿到了兩個ip，分別是<code>172.17.0.5</code>、<code>172.18.0.2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network connect bridge box03</span><br><span class="line">root@host04:/home/kite/Desktop# docker container inspect box03</span><br><span class="line">[</span><br><span class="line">	...</span><br><span class="line">	...</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">			...</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: &#123;&#125;,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: [],</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;118c43b92cc662ecc4e86dc17d63fc599bcc3d0d39547715f92ab77c4fcc2b6c&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;d15ea2680f6b23826c99995932b2ad178366ee3008cb1025fc7385133bd63b8e&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.5&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:05&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: &#123;&#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;mybridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: [</span><br><span class="line">                        &quot;408dbc15598a&quot;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;020d342bf4a11304f4509d44ff64df2555918b2ff4d6664878254faba753d489&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;c3acfbc43272a5c1c9c01a1ff3c05faa7925e8f3b86617d24cac3d620f74be48&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.18.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>進入到container裡面驗證，的確有兩個IP：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container exec -it box03 sh</span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">21: eth0@if22: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth1@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:11:00:05 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.5/16 brd 172.17.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="在bridge中移除掉container"><a href="#在bridge中移除掉container" class="headerlink" title="在bridge中移除掉container"></a>在bridge中移除掉container</h3><p>可以透過<code>docker network disconnect [bridge name] [container name]</code> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network disconnect bridge box03</span><br></pre></td></tr></table></figure>

<p>再重查一次，的確沒有<code>bridge</code>那一項：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container inspect box03</span><br><span class="line">[</span><br><span class="line">	...</span><br><span class="line">	...</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">			...</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;mybridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: [</span><br><span class="line">                        &quot;408dbc15598a&quot;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;020d342bf4a11304f4509d44ff64df2555918b2ff4d6664878254faba753d489&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;c3acfbc43272a5c1c9c01a1ff3c05faa7925e8f3b86617d24cac3d620f74be48&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.18.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h2 id="創建和使用自定義bridge-下"><a href="#創建和使用自定義bridge-下" class="headerlink" title="創建和使用自定義bridge(下)"></a>創建和使用自定義bridge(下)</h2><h3 id="自定義bridge好處"><a href="#自定義bridge好處" class="headerlink" title="自定義bridge好處"></a>自定義bridge好處</h3><p>container 使用自定義的bridge時，容器之間的互ping可以多一種選擇，就是直接使用container 名稱</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container exec -ti box04 ping 172.18.0.4</span><br><span class="line">PING 172.18.0.4 (172.18.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.4: seq=0 ttl=64 time=0.262 ms</span><br><span class="line">64 bytes from 172.18.0.4: seq=1 ttl=64 time=0.095 ms</span><br><span class="line"></span><br><span class="line">#這個方法我目前沒試成功，不過的確在教學中看老師是有成功的，目前懷疑是docker的版本問題</span><br><span class="line">root@host04:/home/kite/Desktop# docker container exec -ti box04 ping box05</span><br></pre></td></tr></table></figure>

<p>記錄問題：</p>
<p>目前在使用container 名稱互ping是失敗的，環境資訊先memo，後續找出確切問題</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:           20.10.7</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.13.8</span><br><span class="line"> Git commit:        20.10.7-0ubuntu5~20.04.2</span><br><span class="line"> Built:             Mon Nov  1 00:34:17 2021</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      true</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          20.10.7</span><br><span class="line">  API version:      1.41 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.13.8</span><br><span class="line">  Git commit:       20.10.7-0ubuntu5~20.04.2</span><br><span class="line">  Built:            Fri Oct 22 00:45:53 2021</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          1.5.5-0ubuntu3~20.04.1</span><br><span class="line">  GitCommit:        </span><br><span class="line"> runc:</span><br><span class="line">  Version:          1.0.1-0ubuntu2~20.04.1</span><br><span class="line">  GitCommit:        </span><br><span class="line"> docker-init:</span><br><span class="line">  Version:          0.19.0</span><br><span class="line">  GitCommit:        </span><br><span class="line">  </span><br><span class="line">root@host04:/home/kite/Desktop# lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 20.04.3 LTS</span><br><span class="line">Release:	20.04</span><br><span class="line">Codename:	focal</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="自己決定區段"><a href="#自己決定區段" class="headerlink" title="自己決定區段"></a>自己決定區段</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d bridge --gateway 172.200.0.1 --subnet 172.200.0.0/16</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個bridge 並自行設定gateway、subnet</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker network create -d bridge --gateway 172.200.0.1 --subnet 172.200.0.0/16 mydemo</span><br><span class="line">b9020c5774943e03e7ddfbf9506d16434a0058330e2e4798ddfa9ef37403e598</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">檢查network清單</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker network ls</span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">118c43b92cc6   bridge     bridge    local</span><br><span class="line">60cb3d796e6b   host       host      local</span><br><span class="line">020d342bf4a1   mybridge   bridge    local</span><br><span class="line">b9020c577494   mydemo     bridge    local</span><br><span class="line">c5b7b2fbb219   none       null      local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看mydemo詳細</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker network inspect mydemo</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mydemo&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;b9020c5774943e03e7ddfbf9506d16434a0058330e2e4798ddfa9ef37403e598&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-03-01T17:06:02.813440335+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.200.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.200.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="容器的端口轉發Port-Forwarding"><a href="#容器的端口轉發Port-Forwarding" class="headerlink" title="容器的端口轉發Port Forwarding"></a>容器的端口轉發Port Forwarding</h2><p>試著建立一個容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run -d -p 8080:80 --name web01 nginx</span><br></pre></td></tr></table></figure>

<p>我們使用<code>sudo iptables -t nat -nvxL</code></p>
<p>裡面有一條很重要的訊息<code> tcp dpt:8080 to:172.17.0.4:80</code> 也就是指host 8080 port 映射到 容器172.17.0.4:80 port。顯然很多docker network 的底層實際會用到iptable進行一些設定，好讓容器與host之間能有很好的互通效果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# sudo iptables -t nat -nvxL</span><br><span class="line">Chain PREROUTING (policy ACCEPT 13 packets, 1629 bytes)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">       4      312 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 12 packets, 1545 bytes)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 140 packets, 13111 bytes)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">       0        0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 141 packets, 13195 bytes)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">       0        0 MASQUERADE  all  --  *      !br-b9020c577494  172.200.0.0/16       0.0.0.0/0           </span><br><span class="line">       0        0 MASQUERADE  all  --  *      !br-020d342bf4a1  172.18.0.0/16        0.0.0.0/0           </span><br><span class="line">      27     1767 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           </span><br><span class="line">       0        0 MASQUERADE  tcp  --  *      *       172.17.0.4           172.17.0.4           tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">    pkts      bytes target     prot opt in     out     source               destination         </span><br><span class="line">       0        0 RETURN     all  --  br-b9020c577494 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">       0        0 RETURN     all  --  br-020d342bf4a1 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">       0        0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">       1       60 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.17.0.4:80</span><br></pre></td></tr></table></figure>



<h2 id="端口轉發和dockerfile"><a href="#端口轉發和dockerfile" class="headerlink" title="端口轉發和dockerfile"></a>端口轉發和dockerfile</h2><p><a target="_blank" rel="noopener" href="https://github.com/nginxinc/docker-nginx/blob/master/Dockerfile-alpine.template">https://github.com/nginxinc/docker-nginx/blob/master/Dockerfile-alpine.template</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:%%ALPINE_VERSION%%</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-entrypoint.sh /</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> 10-listen-on-ipv6-by-default.sh /docker-entrypoint.d</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> 20-envsubst-on-templates.sh /docker-entrypoint.d</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> 30-tune-worker-processes.sh /docker-entrypoint.d</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/docker-entrypoint.sh&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">STOPSIGNAL</span> SIGQUIT</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>我們可以看到在<code>nginx</code>的dockerfile中有一行 <code>EXPOSE 80</code> ，可以做到對外PORT的映射。</p>
<p>提問，那如果dockerfile 沒有這行<code>EXPOSE 80</code>，我們還能使用<code>docker container run -p </code>這樣的方式設定port嗎？答案是可以的。</p>
<p>dockefile這邊如果有明確使用<code>EXPOSE 80</code>，主要的精神在表達讓使用者知道有一個默認的對外port。</p>
<blockquote>
<p>The <code>EXPOSE</code> instruction does not actually publish the port. It functions as a type of documentation between the person who builds the image and the person who runs the container,about which ports are intended to be published.</p>
</blockquote>
<p><code>EXPOSE</code> 默認為<code>TCP</code> ，也可以具體明確定義：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span>/udp</span><br></pre></td></tr></table></figure>

<p>當然，也可以同使支持兩種協議，寫二行即可：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span>/tcp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span>/udp</span><br></pre></td></tr></table></figure>



<h2 id="HOST與None"><a href="#HOST與None" class="headerlink" title="HOST與None"></a>HOST與None</h2><h3 id="HOST"><a href="#HOST" class="headerlink" title="HOST"></a>HOST</h3><p>針對HOST詳細說明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network ls</span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">b22fdb790b7f   bridge     bridge    local</span><br><span class="line">60cb3d796e6b   host       host      local</span><br></pre></td></tr></table></figure>



<p>建立一個container 並使用<code>host</code>network：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container run -d --name web03 --network host nginx</span><br><span class="line">e1b6b611df2e79a4622359385b98e5a0c824af8a740d71a9ad2ecfcf14fac886</span><br></pre></td></tr></table></figure>

<p>列出container ps ，我們會發現<code>web03</code>port 是空白的。是因為我們剛剛使用的的是host 那組netwowrk，所以目前這個container是與host共用同一組network設定的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker container ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND    CREATED         STATUS                        PORTS   NAMES</span><br><span class="line">e1b6b611df2e   nginx     &quot;/docker-entrypoint.…&quot;   7 minutes ago   Up 7 minutes            web03</span><br><span class="line">f1a1469eac7f   nginx     &quot;/docker-entrypoint.…&quot;   2 hours ago     Up 7 minutes    80/tcp  web02</span><br></pre></td></tr></table></figure>

<p>使用<code>curl</code>查看一下，的確在host上的80 port 是映射到<code>web03</code> container ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# curl 127.0.0.1:80</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>我們可以思考一下，那這樣的使用<code>host netowrk</code>與使用<code>container -p 80:80</code>(沒填寫network 預設會選擇<code>docker0</code>，也就是<code>bridge network</code>)會有什麼差別？</p>
<p>其實用圖片來說，多了一個<code>docker0</code>，當中間層的轉發，效率上是有差一些的喔。(因為突然斷電…圖的設計稿不見了，懶得重畫…)想像一下，多了一個web03 然後不經過<code>docker0</code>,直接一條線對接<code>192.168.152.55 eth0</code>。</p>
<p><img src="https://i.imgur.com/gxUx2r9.png"></p>
<h3 id="NONE"><a href="#NONE" class="headerlink" title="NONE"></a>NONE</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop# docker network ls</span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">b22fdb790b7f   bridge     bridge    local</span><br><span class="line">60cb3d796e6b   host       host      local</span><br><span class="line">c5b7b2fbb219   none       null      local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個box01 使用network none</span></span><br><span class="line">root@host04:/home/kite/Desktop# docker container run -it --name box01 --network none busybox </span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有一些第三方開發特殊需求，只需要container容器，相關的網路配置由自己決定與設計。就會使用到 <code>none network</code></p>
<h2 id="網路命名空間"><a href="#網路命名空間" class="headerlink" title="網路命名空間"></a>網路命名空間</h2><p><img src="https://i.imgur.com/8O8nGDp.png" alt="docker-volume"></p>
<p><code>add-ns-to-br.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">bridge=$1</span><br><span class="line">namespace=$2</span><br><span class="line">addr=$3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">link</span>的兩頭</span></span><br><span class="line">vethA=veth-$namespace</span><br><span class="line">vethB=eth00</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個namespace空間</span></span><br><span class="line">sudo ip netns add $namespace</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個<span class="built_in">link</span>，兩頭一個是<span class="variable">$vethA</span>，另一個是<span class="variable">$vethB</span></span></span><br><span class="line">sudo ip link add $vethA type veth peer name $vethB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將<span class="variable">$vethB</span>放到這個namespace裡</span></span><br><span class="line">sudo ip link set $vethB netns $namespace</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">這個namespace空間中，針對<span class="variable">$vethB</span>頭賦與一個IP地址給它</span></span><br><span class="line">sudo ip netns exec $namespace ip addr add $addr dev $vethB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將<span class="variable">$vethB</span> 給up起來</span></span><br><span class="line">sudo ip netns exec $namespace ip link set $vethB up</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將<span class="variable">$vethA</span> 給up起來</span></span><br><span class="line">sudo ip link set $vethA up</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將<span class="variable">$vethA</span> 加到這個bridge上</span></span><br><span class="line">sudo brctl addif $bridge $vethA</span><br></pre></td></tr></table></figure>

<h3 id="腳本執行"><a href="#腳本執行" class="headerlink" title="腳本執行"></a>腳本執行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kite@host04:~/Desktop/namespace$ sh add-ns-to-br.sh mydocker0 ns1 172.16.1.1/16</span><br><span class="line">kite@host04:~/Desktop/namespace$ sh add-ns-to-br.sh mydocker0 ns1 172.16.1.2/16</span><br></pre></td></tr></table></figure>



<h3 id="驗證"><a href="#驗證" class="headerlink" title="驗證"></a>驗證</h3><p>我使用的是ubuntu 環境，去ping 另一個ip 沒有成功。有空再回來試試看，以下是視頻的實驗結果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host1 ~]$ sudo ip netns exec ns1 bash</span><br><span class="line">[root@docker-host1 vagrant]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">5: eth00@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether f2:59:19:34:73:70 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.16.1.1/16 scope global eth00</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f059:19ff:fe34:7370/64 scope link</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">[root@docker-host1 vagrant]# ping 172.16.1.2</span><br><span class="line">PING 172.16.1.2 (172.16.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.16.1.2: icmp_seq=1 ttl=64 time=0.029 ms</span><br><span class="line">64 bytes from 172.16.1.2: icmp_seq=2 ttl=64 time=0.080 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.16.1.2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1000ms</span><br><span class="line">rtt min/avg/max/mdev = 0.029/0.054/0.080/0.026 ms</span><br><span class="line">[root@docker-host1 vagrant]#</span><br></pre></td></tr></table></figure>





<h2 id="多容器應用部署練習"><a href="#多容器應用部署練習" class="headerlink" title="多容器應用部署練習"></a>多容器應用部署練習</h2><p>常見需求會將各個服務進行拆分各自容器之中。後續我們會再講<code>docker compose</code> ，透過配置文件定義容器之間的交互溝通與設定，搭建一個完整的環境。</p>
<p><img src="https://i.imgur.com/yxGUnHE.png" alt="image-20220303145950107"></p>
<h3 id="鏡像準備"><a href="#鏡像準備" class="headerlink" title="鏡像準備"></a>鏡像準備</h3><h4 id="REDIS"><a href="#REDIS" class="headerlink" title="REDIS"></a>REDIS</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/namespace# docker image pull redis</span><br></pre></td></tr></table></figure>

<h4 id="python-flask-web"><a href="#python-flask-web" class="headerlink" title="python flask web"></a>python flask web</h4><h5 id="資料夾結構"><a href="#資料夾結構" class="headerlink" title="資料夾結構"></a>資料夾結構</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/flask_redis_practice# tree </span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">└── Dockerfile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="程式準備"><a href="#程式準備" class="headerlink" title="程式準備"></a>程式準備</h5><p><code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=os.environ.get(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>), port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    redis.incr(<span class="string">&#x27;hits&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello Container World! I have been seen <span class="subst">&#123;redis.get(<span class="string">&#x27;hits&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span> times and my hostname is <span class="subst">&#123;socket.gethostname()&#125;</span>.\n&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="dockerfile準備"><a href="#dockerfile準備" class="headerlink" title="dockerfile準備"></a>dockerfile準備</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>.<span class="number">5</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask redis &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> /src &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R flask:flask /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> flask</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> FLASK_APP=app.py REDIS_HOST=redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h5 id="產生鏡像檔"><a href="#產生鏡像檔" class="headerlink" title="產生鏡像檔"></a>產生鏡像檔</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -t flask-demo .</span><br></pre></td></tr></table></figure>



<h3 id="建立bridge"><a href="#建立bridge" class="headerlink" title="建立bridge"></a>建立bridge</h3><p>建立名為<code>demo-network</code>的bridge</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/flask_redis_practice# docerk network create -d bridge demo-network</span><br></pre></td></tr></table></figure>



<h3 id="建立container"><a href="#建立container" class="headerlink" title="建立container"></a>建立container</h3><p>將<code>redis</code>、<code>python flask web</code> 創建時，加入至 <code>demo-network</code>中。</p>
<h4 id="REDIS-1"><a href="#REDIS-1" class="headerlink" title="REDIS"></a>REDIS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/flask_redis_practice# docker container run -d --name redis-server --network demo-network redis</span><br></pre></td></tr></table></figure>

<h4 id="python-flask-web-1"><a href="#python-flask-web-1" class="headerlink" title="python flask web"></a>python flask web</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@host04:/home/kite/Desktop/flask_redis_practice# docker container run -d --network demo-network --name flask-demo --env REDIS_HOST=redis-server -p 5000:5000 flask-demo</span><br></pre></td></tr></table></figure>



<h4 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h4><p>應該就會看到網頁刷新時，會一直+1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5000</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/tHoIkRm.png" alt="image-20220303145554786"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/24/2022-02-23%20Docker%20%E7%B3%BB%E5%88%97%20-%20(4)%20Dockerfile%E5%AE%B9%E5%99%A8%E7%9A%84%E5%84%B2%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/24/2022-02-23%20Docker%20%E7%B3%BB%E5%88%97%20-%20(4)%20Dockerfile%E5%AE%B9%E5%99%A8%E7%9A%84%E5%84%B2%E5%AD%98/" class="post-title-link" itemprop="url">docker 系列 - (4) Dockerfile容器的儲存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-02-24 17:14:00" itemprop="dateCreated datePublished" datetime="2022-02-24T17:14:00+08:00">2022-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-02-25 11:44:34" itemprop="dateModified" datetime="2022-02-25T11:44:34+08:00">2022-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>18 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="容器儲存介紹"><a href="#容器儲存介紹" class="headerlink" title="容器儲存介紹"></a>容器儲存介紹</h2><p>預設情況下，在運行中的容器裡創建的文件，被保存在一個可寫的容器層：</p>
<ul>
<li>如果容器被刪除了，則數據也沒有了</li>
<li>這個可寫的容器層是和特定的容器綁定的，也就是這些數據無法方便的和其它容器共享</li>
</ul>
<p>Docker主要提供了三種方式做數據的持久化</p>
<ul>
<li><p>Data Volume</p>
<ul>
<li>由Docker管理，(&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;linux)，持久化數據的最好方式</li>
</ul>
</li>
<li><p>Bind Mount</p>
<ul>
<li>由用戶指定存儲的數據具體mount在系統什麼位置</li>
</ul>
</li>
<li><p>tmpfs Mount</p>
<ul>
<li>這個比較少用到，暫時先不進行介紹</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/HS1l6Zs.png" alt="docker-volume"></p>
<h2 id="Data-Volume"><a href="#Data-Volume" class="headerlink" title="Data Volume"></a>Data Volume</h2><p>我們來探討如何進行數據的持久化。</p>
<ul>
<li>“一個運行中的docker image”</li>
<li>實質是複製image全在image最上層加上一層<code>read-write</code>的層(稱之為container layer，容器層)</li>
<li>基於同一個IMAGE可以創建多個container</li>
</ul>
<p><img src="https://i.imgur.com/9j4ef71.png" alt="img"></p>
<h3 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h3><p>準備一個Dockerfile和一個my-cron的文件</p>
<p><code>dockerfile-cron</code>檔</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add curl</span></span><br><span class="line"><span class="keyword">ENV</span> SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.<span class="number">1.12</span>/supercronic-linux-amd64 \</span><br><span class="line">    SUPERCRONIC=supercronic-linux-amd64 \</span><br><span class="line">    SUPERCRONIC_SHA1SUM=<span class="number">048</span>b95b48b708983effb2e5c935a1ef8483d9e3e</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSLO <span class="string">&quot;<span class="variable">$SUPERCRONIC_URL</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;SUPERCRONIC_SHA1SUM&#125;</span>  <span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> | <span class="built_in">sha1sum</span> -c - \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x <span class="string">&quot;<span class="variable">$SUPERCRONIC</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mv</span> <span class="string">&quot;<span class="variable">$SUPERCRONIC</span>&quot;</span> <span class="string">&quot;/usr/local/bin/<span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -s <span class="string">&quot;/usr/local/bin/<span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> /usr/local/bin/supercronic</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> my-cron /app/my-cron</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#volume 可以定義多個，這邊只定義一個</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN cron job</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/local/bin/supercronic&quot;</span>, <span class="string">&quot;/app/my-cron&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><code>my-cron</code>檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * * date &gt;&gt; /app/test.txt</span><br></pre></td></tr></table></figure>





<p>資料夾結構</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── dockerfile-cron</span><br><span class="line">├── my-cron</span><br></pre></td></tr></table></figure>



<h3 id="基本使用volume"><a href="#基本使用volume" class="headerlink" title="基本使用volume"></a>基本使用volume</h3><h4 id="搭建環境"><a href="#搭建環境" class="headerlink" title="搭建環境"></a>搭建環境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立dockefile-cron檔案，請自行完成腳本內容</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/genDockerImagesFolder$ touch dockerfile-cron</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立my-cron檔案，請自行完成腳本內容</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/genDockerImagesFolder$ touch my-cron</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立鏡像檔</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/genDockerImagesFolder$ sudo docker image build -f dockerfile-cron -t my-cron .</span><br><span class="line">Sending build context to Docker daemon  892.4kB</span><br><span class="line">Step 1/9 : FROM alpine:latest</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Successfully built a5105bc596ec</span><br><span class="line">Successfully tagged my-cron:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看鏡像檔清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker images</span><br><span class="line">REPOSITORY       TAG                IMAGE ID       CREATED          SIZE</span><br><span class="line">my-cron          latest             a6e1e40dd6bb   15 minutes ago   45MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動並創建容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker run -d my-cron</span><br><span class="line">97d956e771f6a833368d6ecc693aa79fb300eb04cfc0b435bc665652013401ec</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看容器清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container ps -a</span><br><span class="line">CONTAINER ID   IMAGE    COMMAND                  CREATED         STATUS       PORTS   NAMES</span><br><span class="line">97d956e771f6   my-cron  &quot;/usr/local/bin/supe…&quot;   5 seconds ago   Up 4 seconds         tender_mahavira</span><br></pre></td></tr></table></figure>

<h4 id="確認crontab執行狀況"><a href="#確認crontab執行狀況" class="headerlink" title="確認crontab執行狀況"></a>確認crontab執行狀況</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker exec -it 97d9 sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查詢檔案</span></span><br><span class="line">/app # ls</span><br><span class="line">my-cron   test.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看test.txt檔案</span></span><br><span class="line">/app # more test.txt</span><br><span class="line">Wed Feb 23 02:11:00 UTC 2022</span><br><span class="line">Wed Feb 23 02:12:00 UTC 2022</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">離開容器</span></span><br><span class="line">/app # exit</span><br></pre></td></tr></table></figure>

<h4 id="查看host檔案路徑-Mountpoint"><a href="#查看host檔案路徑-Mountpoint" class="headerlink" title="查看host檔案路徑(Mountpoint)"></a>查看host檔案路徑(Mountpoint)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看volume 清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看volume映射資料</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume inspect 05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2022-02-23T10:10:59+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用<span class="built_in">ls</span> 加 mountpoint值的路徑，可以發現在host上也有test.txt檔案</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# ls /var/lib/docker/volumes/05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5/_data</span><br><span class="line">my-cron  test.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用more查看host的test.txt檔案，資料與容器內部一致</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# more /var/lib/docker/volumes/05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5/_data/test.txt</span><br><span class="line">Wed Feb 23 02:11:00 UTC 2022</span><br><span class="line">Wed Feb 23 02:12:00 UTC 2022</span><br></pre></td></tr></table></figure>

<h4 id="驗證停止container後，host檔案是否仍存在"><a href="#驗證停止container後，host檔案是否仍存在" class="headerlink" title="驗證停止container後，host檔案是否仍存在"></a>驗證停止container後，host檔案是否仍存在</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container stop 97d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">驗證，就算停止容器host檔案還是存在的</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# more /var/lib/docker/volumes/05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5/_data/test.txt</span><br><span class="line">Wed Feb 23 02:11:00 UTC 2022</span><br><span class="line">Wed Feb 23 02:12:00 UTC 2022</span><br></pre></td></tr></table></figure>

<h4 id="發現再啟用新的容器-volume重建一個新的區域"><a href="#發現再啟用新的容器-volume重建一個新的區域" class="headerlink" title="發現再啟用新的容器,volume重建一個新的區域"></a>發現再啟用新的容器,volume重建一個新的區域</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再啟動一個新的container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d my-cron</span><br><span class="line">17f1ffa9999a697540fb4aa81a695b66d96b9f57ac05db6af8f9026da4bdb6a7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看volume清單，會發現多了一個b49bbb，代表這個容器使用了一個新的硬碟空間</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5</span><br><span class="line">local     b49bbb9e19dedb0bb36dc3b734ec354eb25e477212dbb5a5156416c63693a25d</span><br></pre></td></tr></table></figure>

<h4 id="如何接續上一個volume資料？"><a href="#如何接續上一個volume資料？" class="headerlink" title="如何接續上一個volume資料？"></a>如何接續上一個volume資料？</h4><p>如果container停止後，再繼續啟用一個新的container，我們想要接續上一個container的資料繼續記錄。如何做到呢？</p>
<p>首先，我們把之前實驗的資料進行清空的動作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看目前所有container包含停止的container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container ps -a</span><br><span class="line">CONTAINER ID   IMAGE    COMMAND                  ...</span><br><span class="line">17f1ffa9999a   my-cron  &quot;/usr/local/bin/supe…&quot;   ...</span><br><span class="line">97d956e771f6   my-cron  &quot;/usr/local/bin/supe…&quot;   ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">強制停止container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container rm -f 17f1 97d9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除所有volume，會詢問是否繼續</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume prune</span><br><span class="line">WARNING! This will remove all local volumes not used by at least one container.</span><br><span class="line">Are you sure you want to continue? [y/N] y</span><br><span class="line">Deleted Volumes:</span><br><span class="line">05b3074b5770b1a24b36493a3b1153a1070206d4600d19a1508714c9912dc5f5</span><br><span class="line">b49bbb9e19dedb0bb36dc3b734ec354eb25e477212dbb5a5156416c63693a25d</span><br><span class="line"></span><br><span class="line">Total reclaimed space: 1.402kB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看volume 都清空了</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br></pre></td></tr></table></figure>



<p>此項任務**<code>-v</code> 我是主角**：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run -d -v [自定義volume名稱]:[dockerfile內必須有的設定值] [image name]</span><br></pre></td></tr></table></figure>



<p>執行過程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用 -v 參數，也就是代表volume的意思 cron-data volume 名稱，而冒號(:) 後面的 /app 必須是在dockerfile有指名的volume</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d -v cron-data:/app my-cron</span><br><span class="line">6150f7169a578f27af13997ec8d8f9ca2610fa4c7aae0b97a57bef5bf9d845d6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看一下volume 就會看到以cron-data為名稱的volume</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     cron-data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看volume資料，mountpoint路徑就變簡潔了</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker volume inspect cron-data</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2022-02-23T11:24:59+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/cron-data/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;cron-data&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>進行驗證，是否有接續之前的資料</strong></p>
<p>我們會發現進入container後看<code>test.txt</code>文件內容，是有包含之前上一次container 的資料在裡面哦。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先刪除之前的container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container rm -f 6150</span><br><span class="line">6150</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次創建container</span> </span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d -v cron-data:/app my-cron</span><br><span class="line">f61223479947f23bb6750d25aa22427e3b8dbb92875af9d4c3dbac761703ea29</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入container</span> </span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker exec -it f6122 sh</span><br><span class="line">/app # ls</span><br><span class="line">my-cron   test.txt</span><br><span class="line">/app # more test.txt</span><br><span class="line">Wed Feb 23 03:25:00 UTC 2022</span><br><span class="line">Wed Feb 23 03:26:00 UTC 2022</span><br><span class="line">Wed Feb 23 03:27:00 UTC 2022</span><br><span class="line">Wed Feb 23 03:28:00 UTC 2022</span><br><span class="line">Wed Feb 23 03:29:00 UTC 2022</span><br><span class="line">Wed Feb 23 03:30:00 UTC 2022</span><br><span class="line">/app # exit</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>註記：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除所有鏡像</span></span><br><span class="line">docker system prune</span><br><span class="line"></span><br><span class="line">docker volume rm $(docker volume ls -qf dangling=true)</span><br></pre></td></tr></table></figure>



<p>網站推薦</p>
<p><a target="_blank" rel="noopener" href="https://crontab.guru/">crontab轉換</a></p>
<h2 id="數據持久化之Bind-Mount"><a href="#數據持久化之Bind-Mount" class="headerlink" title="數據持久化之Bind Mount"></a>數據持久化之Bind Mount</h2><p>複習一下在dockerfile裡面定義了<code>VOLUME</code>，如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add curl</span></span><br><span class="line"><span class="keyword">ENV</span> SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.<span class="number">1.12</span>/supercronic-linux-amd64 \</span><br><span class="line">    SUPERCRONIC=supercronic-linux-amd64 \</span><br><span class="line">    SUPERCRONIC_SHA1SUM=<span class="number">048</span>b95b48b708983effb2e5c935a1ef8483d9e3e</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSLO <span class="string">&quot;<span class="variable">$SUPERCRONIC_URL</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;SUPERCRONIC_SHA1SUM&#125;</span>  <span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> | <span class="built_in">sha1sum</span> -c - \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x <span class="string">&quot;<span class="variable">$SUPERCRONIC</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mv</span> <span class="string">&quot;<span class="variable">$SUPERCRONIC</span>&quot;</span> <span class="string">&quot;/usr/local/bin/<span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">ln</span> -s <span class="string">&quot;/usr/local/bin/<span class="variable">$&#123;SUPERCRONIC&#125;</span>&quot;</span> /usr/local/bin/supercronic</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> my-cron /app/my-cron</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#volume 可以定義多個，這邊只定義一個</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN cron job</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/local/bin/supercronic&quot;</span>, <span class="string">&quot;/app/my-cron&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>如果希望都是以參數方式定義<code>VOLUME</code>的話，在dockerfile的部分就可以不用去寫這段語法。</p>
<p>另外，windows 在使用volume時會有一些狀況。還記得windows的docker環境，其實是run在linux虛擬層裡。所以在使用<code>docker volume inspect</code>指令查閱<code>Mountpoint</code>的路徑是一個linux的路徑。但是在windows作業系統是摸不到這一層的。</p>
<p>因此，在windows環境使用<code>Bind Mount</code>方式好用一些。試著在windows運行，延用先前的<code>dockerfile-cron</code>檔案及<code>my-cron</code>腳本，玩玩看：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看目前的images</span></span><br><span class="line"><span class="built_in">PS</span> E:\dockerworkspace&gt; docker images</span><br><span class="line">REPOSITORY                       TAG           IMAGE ID       CREATED          SIZE</span><br><span class="line">my<span class="literal">-cron</span>                          latest        f356932e5078   <span class="number">22</span> seconds ago   <span class="number">24.8</span>MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#創建並運行容器,$&#123;pwd&#125; 指的是當前目錄</span></span><br><span class="line"><span class="built_in">PS</span> E:\dockerworkspace&gt; docker container run <span class="literal">-d</span> <span class="literal">-v</span> <span class="variable">$</span>&#123;<span class="built_in">pwd</span>&#125;:/app my<span class="literal">-cron</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#我們會看到在windows底下，排程時間到了就自動產生test.txt檔案</span></span><br><span class="line"><span class="built_in">PS</span> E:\dockerworkspace&gt; tree /f /a</span><br><span class="line">列出磁碟區 <span class="keyword">Data</span> 的資料夾 PATH</span><br><span class="line">磁碟區序號為 <span class="number">3</span>A21<span class="literal">-AA41</span></span><br><span class="line">E:.</span><br><span class="line">    Dockerfile</span><br><span class="line">    my<span class="literal">-cron</span></span><br><span class="line">    test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#輸出檔案內容</span></span><br><span class="line"><span class="built_in">PS</span> E:\dockerworkspace&gt; <span class="built_in">type</span> test.txt</span><br><span class="line">Wed Feb <span class="number">23</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">00</span> UTC <span class="number">2022</span></span><br><span class="line">Wed Feb <span class="number">23</span> <span class="number">08</span>:<span class="number">39</span>:<span class="number">00</span> UTC <span class="number">2022</span></span><br></pre></td></tr></table></figure>

<h2 id="Bind-Mount練習之docker開發環境"><a href="#Bind-Mount練習之docker開發環境" class="headerlink" title="Bind Mount練習之docker開發環境"></a>Bind Mount練習之docker開發環境</h2><p>host沒有編譯環境，希望透過container來 bind相同的資料區塊，用這個方式的確很輕鬆產生編譯後的檔案。</p>
<p>當前目錄指令說明</p>
<ul>
<li>linux<ul>
<li>$(pwd)</li>
</ul>
</li>
<li>windows<ul>
<li>${pwd}</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看目前目錄檔案，目前只有一個hello.c</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/bindMountArea# ls</span><br><span class="line">hello.c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建並運行container $(<span class="built_in">pwd</span>) 指的是當前目錄</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/bindMountArea# docker container run -it -v $(pwd):/app gcc:9.4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">已進入容器，查看列表</span></span><br><span class="line">root@e058f803400b:/# ls                 </span><br><span class="line">app  bin  boot	dev  etc  home	lib  lib64  media  mnt	opt  proc  root  run  sbin  srv  sys  tmp  usr	var</span><br><span class="line"></span><br><span class="line">root@e058f803400b:/# cd app</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看的確在/app資料夾底下有跟host一樣的hello.c檔案</span></span><br><span class="line">root@e058f803400b:/app# ls</span><br><span class="line">hello.c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進行編譯</span></span><br><span class="line">root@e058f803400b:/app# gcc -o hello hello.c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">編完譯後多出一個hello檔</span></span><br><span class="line">root@e058f803400b:/app# ls</span><br><span class="line">hello  hello.c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">小玩一下</span></span><br><span class="line">root@e058f803400b:/app# ./hello abc</span><br><span class="line">hello abc</span><br><span class="line"></span><br><span class="line">root@e058f803400b:/app# ./hello kite</span><br><span class="line">hello kite</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">退出容器</span></span><br><span class="line">root@e058f803400b:/app# exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在host的確也有hello檔案</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/bindMountArea# ls</span><br><span class="line">hello  hello.c</span><br></pre></td></tr></table></figure>

<h2 id="機器之間共享數據"><a href="#機器之間共享數據" class="headerlink" title="機器之間共享數據"></a>機器之間共享數據</h2><p>待補</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/22/2022-02-22%20Docker%20%E7%B3%BB%E5%88%97%20-%20(3)%20Dockerfile%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/22/2022-02-22%20Docker%20%E7%B3%BB%E5%88%97%20-%20(3)%20Dockerfile%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">docker 系列 - (3) Dockerfile完全指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-02-22 17:14:00" itemprop="dateCreated datePublished" datetime="2022-02-22T17:14:00+08:00">2022-02-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-02-23 09:06:50" itemprop="dateModified" datetime="2022-02-23T09:06:50+08:00">2022-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>37 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="如何選擇基礎鏡像-FROM"><a href="#如何選擇基礎鏡像-FROM" class="headerlink" title="如何選擇基礎鏡像(FROM)"></a>如何選擇基礎鏡像(FROM)</h2><h3 id="基本原則"><a href="#基本原則" class="headerlink" title="基本原則"></a>基本原則</h3><ul>
<li>官方鏡像優非官方的鏡像，如果沒有官方鏡像，則儘量選擇Dockerfile開源的</li>
<li>固定版本tag而不是每次都使用latest</li>
<li>儘量選擇體積小的鏡像</li>
</ul>
<p>準備一個<code>index.html</code>文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Docker<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>準備一個<code>Dockerfile</code>文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.21</span>.<span class="number">0</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> index.html /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker image ls</span><br><span class="line">REPOSITORY      TAG             IMAGE ID       CREATED          SIZE</span><br><span class="line">bitnami/nginx   1.18.0          dfe237636dde   28 minutes ago   89.3MB</span><br><span class="line">nginx           1.21.0-alpine   a6eb2a334a9f   2 days ago       22.6MB</span><br><span class="line">nginx           1.21.0          d1a364dc548d   2 days ago       133MB</span><br></pre></td></tr></table></figure>

<p><code>alpine</code> 這個版本是一個非常輕量的linux 系統，在nginx、python都會看得到這樣的組合</p>
<p><img src="https://i.imgur.com/9zhQmDo.png" alt="image-20220218151904995"></p>
<blockquote>
<p>A minimal Docker image based on Alpine Linux with a complete package index and only 5 MB in size!</p>
</blockquote>
<p><img src="https://i.imgur.com/Aet8fLy.png" alt="image-20220218152341367"></p>
<h2 id="通過RUN執行指令"><a href="#通過RUN執行指令" class="headerlink" title="通過RUN執行指令"></a>通過RUN執行指令</h2><p><code>RUN</code> 主要用於在image裡執行指令，比如安裝軟體、下載文件…等。</p>
<p>如果是了6個<code>RUN</code>就會建立出6個分層，通常不會這樣寫，而且體積也會比較大。</p>
<p>原指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get update</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get install wget</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>


<h3 id="Dockerfile-bad"><a href="#Dockerfile-bad" class="headerlink" title="Dockerfile.bad"></a>Dockerfile.bad</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<p>鏡像的大小和分層</p>
<p>我們可以看到下面的history 多了好多個RUN ，每一個RUN都有佔幾個MB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立鏡像檔 -f 參數可以指定dockerfile檔案</span></span><br><span class="line">docker image build -f Dockerfile.bad -t ipinfo-bad . </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">ls</span></span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">ipinfo       latest    97bb429363fb   4 minutes ago   138MB</span><br><span class="line">ubuntu       21.04     478aa0080b60   4 days ago      74.1MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">history</span> 97b</span></span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">97bb429363fb   4 minutes ago   RUN /bin/sh -c rm -rf ipinfo_2.0.1_linux_amd…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c mv ipinfo_2.0.1_linux_amd64 /…   9.36MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c tar zxf ipinfo_2.0.1_linux_am…   9.36MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c wget https://github.com/ipinf…   4.85MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c apt-get install -y wget # bui…   7.58MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c apt-get update # buildkit        33MB      buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo &#x27;do…   7B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c set -xe   &amp;&amp; echo &#x27;#!/bin/sh&#x27; &gt; /…   811B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c #(nop) ADD file:d6b6ba642344138dc…   74.1MB</span><br></pre></td></tr></table></figure>



<h3 id="Dockerfile-good"><a href="#Dockerfile-good" class="headerlink" title="Dockerfile.good"></a>Dockerfile.good</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y wget &amp;&amp; \</span><br><span class="line">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span><br><span class="line">    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>



<p>我們可以看到下面的結果，只有一筆RUN的分層</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">ls</span></span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">ipinfo-new   latest    fe551bc26b92   5 seconds ago    124MB</span><br><span class="line">ipinfo       latest    97bb429363fb   16 minutes ago   138MB</span><br><span class="line">ubuntu       21.04     478aa0080b60   4 days ago       74.1MB</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">history</span> fe5</span></span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">fe551bc26b92   16 seconds ago   RUN /bin/sh -c apt-get update &amp;&amp;     apt-get…   49.9MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo &#x27;do…   7B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c set -xe   &amp;&amp; echo &#x27;#!/bin/sh&#x27; &gt; /…   811B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c #(nop) ADD file:d6b6ba642344138dc…   74.1MB</span><br></pre></td></tr></table></figure>





<h2 id="文件複製和目錄操作-ADD-COPY-WORKDIR"><a href="#文件複製和目錄操作-ADD-COPY-WORKDIR" class="headerlink" title="文件複製和目錄操作(ADD,COPY,WORKDIR)"></a>文件複製和目錄操作(ADD,COPY,WORKDIR)</h2><p>往鏡像裡複製文件有兩種方式<code>COPY</code>、<code>ADD</code>。</p>
<h3 id="複製普通文件"><a href="#複製普通文件" class="headerlink" title="複製普通文件"></a>複製普通文件</h3><p><code>COPY</code>和<code>ADD</code>都可以把local的一個文件複製到鏡像裡，如果目標目錄不存在，則會自動建立</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">COPY hello.py /app/hello.py</span><br></pre></td></tr></table></figure>

<p>比如把本地的hello.py複製到&#x2F;app 目錄下，但app目錄不存在，所以會自動建立</p>
<h3 id="複製壓縮文件"><a href="#複製壓縮文件" class="headerlink" title="複製壓縮文件"></a>複製壓縮文件</h3><p><code>ADD</code>比較不一樣的地方是，如果複製的是一個gzip等壓縮文件時，<code>ADD</code>會幫助我們自動去解壓縮文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">ADD hello.tar.gz /app/</span><br></pre></td></tr></table></figure>

<h3 id="如何選擇"><a href="#如何選擇" class="headerlink" title="如何選擇"></a>如何選擇</h3><p>所有文件複製可以均使用<code>COPY</code>指令，僅在需要自動解壓縮的場合使用<code>ADD</code></p>
<h3 id="實驗記錄-COPY"><a href="#實驗記錄-COPY" class="headerlink" title="實驗記錄 COPY"></a>實驗記錄 COPY</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立tmp資料夾</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# mkdir tmp</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# cd tmp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建a文件</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# touch a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建b文件</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# touch b</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# cd ..</span><br></pre></td></tr></table></figure>

<p>修改<code>Dockerfile</code>檔案內容如下</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>.<span class="number">5</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> tmp/ /app/tmp/</span></span><br></pre></td></tr></table></figure>



<p>執行build動作，並進入到container查看是否有複製完整資料夾至<code>/app/tmp/</code>底下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打包成docker image</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker build -t docker-copy .</span><br><span class="line">Sending build context to Docker daemon  878.1kB</span><br><span class="line">Step 1/2 : FROM python:3.9.5-alpine3.13</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">46a196bf50ae</span></span><br><span class="line">Step 2/2 : COPY tmp/ /app/tmp/</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">54edba980fe5</span></span><br><span class="line">Successfully built 54edba980fe5</span><br><span class="line">Successfully tagged docker-copy:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行容器 並進入交互模式 結束後直接刪除container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm docker-copy sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切換目錄至tmp底下</span></span><br><span class="line">/ # cd app/tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看資料夾，的確有a、b兩個檔案，代表有複製到整個資料夾到container內部</span></span><br><span class="line">/app/tmp # ls</span><br><span class="line">a  b</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">離開container</span></span><br><span class="line">/app/tmp # exit</span><br></pre></td></tr></table></figure>



<h3 id="實驗記錄-ADD"><a href="#實驗記錄-ADD" class="headerlink" title="實驗記錄 ADD"></a>實驗記錄 ADD</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行tar指令壓縮資料夾</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# tar cvf copy.tar tmp</span><br><span class="line">tmp/</span><br><span class="line">tmp/b</span><br><span class="line">tmp/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# ls</span><br><span class="line">copy.tar  Dockerfile  hello  hello.c  hello.py  tmp</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerIm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先移除上一個剛產生的image</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image rm docker-copy</span><br><span class="line">Untagged: docker-copy:latest</span><br><span class="line">Deleted: sha256:54edba980fe511c2cfce44ce4e7615fd47171deea2a8cd668404b6f59545405c</span><br><span class="line">Deleted: sha256:6cff68147576a72f2121ea1da50b33ccc8328fc11683b668564baed2c3b7dbc6</span><br></pre></td></tr></table></figure>



<p>修改<code>Dockerfile</code>檔案內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">ADD copy.tar /app/</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再進行構建</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker build -t docker-copy .</span><br><span class="line">Sending build context to Docker daemon  888.8kB</span><br><span class="line">Step 1/2 : FROM python:3.9.5-alpine3.13</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">46a196bf50ae</span></span><br><span class="line">Step 2/2 : ADD copy.tar /app/</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">9f31129139ea</span></span><br><span class="line">Successfully built 9f31129139ea</span><br><span class="line">Successfully tagged docker-copy:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">運行容器並進入交互模式</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm docker-copy sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">移動到tmp資料夾</span></span><br><span class="line">/ # cd app/tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看清單，果然有自動unzip資料夾</span></span><br><span class="line">/app/tmp # ls</span><br><span class="line">a  b</span><br></pre></td></tr></table></figure>





<h2 id="構建參數和環境變數-ARG-VS-ENV"><a href="#構建參數和環境變數-ARG-VS-ENV" class="headerlink" title="構建參數和環境變數(ARG VS ENV)"></a>構建參數和環境變數(ARG VS ENV)</h2><p><code>ARG</code>和<code>ENV</code>是經常容易被混淆的兩個Dockerfile的語法，都可以用來設置一個”變數”。但實際上兩者有很多的不同。</p>
<p>比方說有一個腳本</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<h3 id="使用ENV"><a href="#使用ENV" class="headerlink" title="使用ENV"></a>使用ENV</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="使用ARG"><a href="#使用ARG" class="headerlink" title="使用ARG"></a>使用ARG</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ARG</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="區別"><a href="#區別" class="headerlink" title="區別"></a>區別</h3><p><img src="https://i.imgur.com/c1DIgDo.png" alt="docker-image"></p>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h4><ul>
<li><p>ARG的生命週期在build 鏡像的過程</p>
</li>
<li><p>run container 內並不會有這組變數名稱可以使用</p>
</li>
<li><p>可以藉由build 指令去指定賦與值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -f .\Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg VERSION=2.0.0 .</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><ul>
<li>ENV的生命週期包含在build鏡像與run container 之後，變數仍存在。</li>
</ul>
<h2 id="CMD容器啟動命令"><a href="#CMD容器啟動命令" class="headerlink" title="CMD容器啟動命令"></a>CMD容器啟動命令</h2><p>CMD可以用來設置容器啟動時預設會執行的命令。</p>
<p>我們的dockerfile檔如下</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<p>進行鏡像構建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -f dockerfile-ipinfo -t ipinfo .</span><br></pre></td></tr></table></figure>



<h3 id="容器啟動時預設執行的命令"><a href="#容器啟動時預設執行的命令" class="headerlink" title="容器啟動時預設執行的命令"></a>容器啟動時預設執行的命令</h3><p>啟動一個<code>ipinfo container</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動一個新容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker container run -it ipinfo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自動進入到容器內部了</span></span><br><span class="line">root@ecfe534f0f60:/# ls</span><br></pre></td></tr></table></figure>

<p>我們發現我們沒有在ipinfo 後面下command 為什麼會自動進入到shell模式呢？我們使用<code>docker image history ipinfo</code> 看一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看ipinfo</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image history ipinfo</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">f68f17d7369f   27 minutes ago   /bin/sh -c apt-get update &amp;&amp;     apt-get ins…   47MB      </span><br><span class="line">53a4d53f91b3   29 minutes ago   /bin/sh -c #(nop)  ENV VERSION=2.0.1            0B        </span><br><span class="line">7cc39f89fa58   2 weeks ago      /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop) ADD file:4cb90f4b06e581fee…   80MB   </span><br></pre></td></tr></table></figure>

<p>發現docker 的基礎鏡像中有<code>CMD[&quot;bash&quot;]</code>，所以就會變成預設是在這個模式下。</p>
<h3 id="如果docker-container-run啟動容器時指定了其它命令，則CMD命令會被忽略。"><a href="#如果docker-container-run啟動容器時指定了其它命令，則CMD命令會被忽略。" class="headerlink" title="如果docker container run啟動容器時指定了其它命令，則CMD命令會被忽略。"></a>如果docker container run啟動容器時指定了其它命令，則CMD命令會被忽略。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm ipinfo ipinfo 8.8.8.8</span><br><span class="line">Core</span><br><span class="line">- IP           8.8.8.8</span><br><span class="line">- Anycast      true</span><br><span class="line">- Hostname     dns.google</span><br><span class="line">- City         Mountain View</span><br><span class="line">- Region       California</span><br><span class="line">- Country      United States (US)</span><br><span class="line">- Location     37.4056,-122.0775</span><br><span class="line">- Organization AS15169 Google LLC</span><br><span class="line">- Postal       94043</span><br><span class="line">- Timezone     America/Los_Angeles</span><br></pre></td></tr></table></figure>



<h3 id="如果定義了多個CMD-只有最後一個會被執行。"><a href="#如果定義了多個CMD-只有最後一個會被執行。" class="headerlink" title="如果定義了多個CMD,只有最後一個會被執行。"></a>如果定義了多個CMD,只有最後一個會被執行。</h3><p>以下腳本為例，參考了ubuntu的鏡像，ubuntu本身內部就有使用其它CMD，這時我們如果在最後多加了一個CMD的指令。那優先權最大就會變成</p>
<p><code>CMD [&quot;ipinfo&quot;]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">ENV VERSION=2.0.1</span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y wget &amp;&amp; \</span><br><span class="line">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-$&#123;VERSION&#125;/ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    mv ipinfo_$&#123;VERSION&#125;_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span><br><span class="line">    rm -rf ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz</span><br><span class="line">CMD [&quot;ipinfo&quot;]</span><br></pre></td></tr></table></figure>


<p>迅速清理那些已經停止的container </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -f</span><br></pre></td></tr></table></figure>

<p>遽速清理沒有使用的image</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune -a</span><br></pre></td></tr></table></figure>

<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> []</span></span><br></pre></td></tr></table></figure>

<p>把<code>CMD[]</code>設為空之後，再重新build一個新的鏡像，這樣子在輸入<code>docker run --it ipinfo</code> 時，就不會通過，要求使用者一定要在後面再接一個參數，比如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建容器，出現錯誤提示</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it ipinfo </span><br><span class="line">docker: Error response from daemon: No command specified.</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">帶參數</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it ipinfo ipinfo 8.8.8.8</span><br><span class="line">Core</span><br><span class="line">- IP           8.8.8.8</span><br><span class="line">- Anycast      true</span><br><span class="line">- Hostname     dns.google</span><br><span class="line">- City         Mountain View</span><br><span class="line">- Region       California</span><br><span class="line">- Country      United States (US)</span><br><span class="line">- Location     37.4056,-122.0775</span><br><span class="line">- Organization AS15169 Google LLC</span><br><span class="line">- Postal       94043</span><br><span class="line">- Timezone     America/Los_Angeles</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="容器啟動命令ENTRYPOINT"><a href="#容器啟動命令ENTRYPOINT" class="headerlink" title="容器啟動命令ENTRYPOINT"></a>容器啟動命令ENTRYPOINT</h2><p>ENTRYPOINT也可以設置容器啟動時要執行的命令，但是和CMD是有區別的。</p>
<ul>
<li><code>CMD</code>設置的命令，可以在docker container run 時傳入其它命令，覆蓋掉<code>CMD</code>的命令，但是<code>ENTRYPOINT</code>所設置的命令是<strong>一定會被執行</strong>的。</li>
<li><code>ENTRYPOINT</code>和<code>CMD</code>可以聯合使用，<code>ENTRYPOINT</code>設置執行的命令，CMD傳遞參數</li>
</ul>
<h2 id="SHELL格式和EXEC格式"><a href="#SHELL格式和EXEC格式" class="headerlink" title="SHELL格式和EXEC格式"></a>SHELL格式和EXEC格式</h2><p><code>CMD</code>和<code>ENTRYPOINT</code>同時支持SHELL格式和EXEC格式。</p>
<h3 id="shell格式"><a href="#shell格式" class="headerlink" title="shell格式"></a>shell格式</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="exec格式"><a href="#exec格式" class="headerlink" title="exec格式"></a>exec格式</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<h3 id="注意事項舉例"><a href="#注意事項舉例" class="headerlink" title="注意事項舉例"></a>注意事項舉例</h3><p>比方說要print 出<strong>hello docker</strong></p>
<p>shell版本</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> NAME=docker</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello <span class="variable">$NAME</span>&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>我們試著改成exec格式，如下面這樣，其實是不行的喔。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> NAME=docker</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello <span class="variable">$NAME</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>具體方式要以shell腳本的方式去執行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">ENV NAME=docker</span><br><span class="line">CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;echo hello $NAME&quot;]</span><br></pre></td></tr></table></figure>



<h2 id="一起構建一個python-Flask鏡像"><a href="#一起構建一個python-Flask鏡像" class="headerlink" title="一起構建一個python Flask鏡像"></a>一起構建一個python Flask鏡像</h2><h3 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個資料夾名稱為pythonworkspace</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop$ mkdir pythonworkspace</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入pythonworkspace資料夾</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop$ cd pythonworkspace/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安裝python3-virtualenv套件</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ sudo apt install python3-virtualenv</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">python3-virtualenv is already the newest version (20.0.17-1ubuntu0.4).</span><br><span class="line">The following packages were automatically installed and are no longer required:</span><br><span class="line">  libc++1 libc++1-10 libc++abi1-10 libsss-nss-idmap0</span><br><span class="line">Use &#x27;sudo apt autoremove&#x27; to remove them.</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 36 not upgraded.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個獨立空間的python環境，名稱為flaskwebsite</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ python3 -m venv flaskwebsite</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行進入到flaskwebsite空間</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ source ./flaskwebsite/bin/activate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">發現前面就會帶(flaskwebsite)空間名稱囉，再用pip list看目前套件清單</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip list</span><br><span class="line">Package       Version</span><br><span class="line">------------- -------</span><br><span class="line">pip           20.0.2 </span><br><span class="line">pkg-resources 0.0.0  </span><br><span class="line">setuptools    44.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安裝flask套件</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip install Flask</span><br><span class="line"></span><br><span class="line">Collecting Flask</span><br><span class="line">  Downloading Flask-2.0.3-py3-none-any.whl (95 kB)</span><br><span class="line">     |████████████████████████████████| 95 kB 393 kB/s </span><br><span class="line">Collecting Jinja2&gt;=3.0</span><br><span class="line">  Downloading Jinja2-3.0.3-py3-none-any.whl (133 kB)</span><br><span class="line">     |████████████████████████████████| 133 kB 1.2 MB/s </span><br><span class="line">Collecting Werkzeug&gt;=2.0</span><br><span class="line">  Downloading Werkzeug-2.0.3-py3-none-any.whl (289 kB)</span><br><span class="line">     |████████████████████████████████| 289 kB 2.6 MB/s </span><br><span class="line">Collecting itsdangerous&gt;=2.0</span><br><span class="line">  Downloading itsdangerous-2.1.0-py3-none-any.whl (15 kB)</span><br><span class="line">Collecting click&gt;=7.1.2</span><br><span class="line">  Downloading click-8.0.4-py3-none-any.whl (97 kB)</span><br><span class="line">     |████████████████████████████████| 97 kB 3.4 MB/s </span><br><span class="line">Collecting MarkupSafe&gt;=2.0</span><br><span class="line">  Downloading MarkupSafe-2.1.0-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (25 kB)</span><br><span class="line">Installing collected packages: MarkupSafe, Jinja2, Werkzeug, itsdangerous, click, Flask</span><br><span class="line">Successfully installed Flask-2.0.3 Jinja2-3.0.3 MarkupSafe-2.1.0 Werkzeug-2.0.3 click-8.0.4 itsdangerous-2.1.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次確認套件清單</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip list</span><br><span class="line">Package       Version</span><br><span class="line">------------- -------</span><br><span class="line">click         8.0.4  </span><br><span class="line">Flask         2.0.3  </span><br><span class="line">itsdangerous  2.1.0  </span><br><span class="line">Jinja2        3.0.3  </span><br><span class="line">MarkupSafe    2.1.0  </span><br><span class="line">pip           20.0.2 </span><br><span class="line">pkg-resources 0.0.0  </span><br><span class="line">setuptools    44.0.0 </span><br><span class="line">Werkzeug      2.0.3  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行vscode 打開當前目錄</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$code . </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定環境變數，這步驟設定後，之後下flask run 會自動找這個設定值的內容</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ export FLASK_APP=app.py</span><br></pre></td></tr></table></figure>



<h3 id="腳本與程式碼"><a href="#腳本與程式碼" class="headerlink" title="腳本與程式碼"></a>腳本與程式碼</h3><p>網站程式碼：<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>鏡像構建腳本：<code>Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="comment">#將本機檔 app.py copy到image內部指定路徑</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行安裝flask套件指令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定預設工作目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定image內部環境變數</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#對外公開5000 port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行網站啟動指令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>透過dockerhub官網去尋找python的docker image檔，這次特別找輕量的python，可以在tag頁籤底下查詢<code>slim</code>關鍵字。</p>
<p><img src="https://i.imgur.com/8InDVzo.png" alt="image-20220222111053601"></p>
<h2 id="合理使用緩存技巧"><a href="#合理使用緩存技巧" class="headerlink" title="合理使用緩存技巧"></a>合理使用緩存技巧</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line">FROM python:slim</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將本機檔 app.py copy到image內部指定路徑 &lt;&lt; 我原本在這個位置，程式異動後重build，後面的步驟都會重新再來，不會找緩存</span></span><br><span class="line">COPY app.py /src/app.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行安裝flask套件指令</span></span><br><span class="line">RUN pip install flask</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定預設工作目錄</span></span><br><span class="line">WORKDIR /src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定image內部環境變數</span></span><br><span class="line">ENV FLASK=app.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">對外公開5000 port</span></span><br><span class="line">EXPOSE 5000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行網站啟動指令</span></span><br><span class="line">CMD [&quot;flask&quot;,&quot;run&quot;,&quot;-h&quot;,&quot;0.0.0.0&quot;]</span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="comment">#執行安裝flask套件指令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定預設工作目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定image內部環境變數</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#將本機檔 app.py copy到image內部指定路徑  &lt;&lt; 我換到這個位置，程式異後動後重build。前面那些指令就會預設去找緩存的資料囉</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#對外公開5000 port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行網站啟動指令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>在固定且不經常變動的指令放到最前面，常會變的比如<code>app.py</code>檔案的程式碼更新。就儘量放到最後面。</p>
<p>這樣在build的過程中，就可以使用到緩存的機制。</p>
<h2 id="dockerignore"><a href="#dockerignore" class="headerlink" title="dockerignore"></a>dockerignore</h2><p>我們可以透過<code>tree -L 1</code>來看一下結構目錄</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# tree -L 1</span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── flaskwebsite</span><br><span class="line">└── __pycache__</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我們發現其實<code>flaskwebsite資料夾</code>也包含在內，因此，指令<code>docker image build -t flask-demo .</code> 中的點也就是指當前路徑。</p>
<p>我們可以觀查在<code>Sending build context to Docker damon 11.12MB</code>這行顯示需要傳輸到<code>11.12MB</code>，但實際上我們的<code>app.py</code>程式碼才幾kb而已。原因就是因為包含了<code>flaskwebsite資料夾</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -t flask-demo .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon  11.12MB</span><br><span class="line">Step 1/7 : FROM python:slim</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">e4f3ae64bf20</span></span><br><span class="line">Step 2/7 : RUN pip install flask</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 2ad3e866c913</span></span><br></pre></td></tr></table></figure>

<p>我們來試著進行資料夾的排除，跟<code>.giteignore</code>概念一樣</p>
<p><code>.dockerignore</code>檔案</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./flaskwebsite</span><br></pre></td></tr></table></figure>

<p>這個檔案我們寫了一行<code>./flaskwebsite</code>，也就是請在build過程中忽略<code>flaskwebsite</code>資料夾。</p>
<p>資料結構加了一個檔案後如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# tree -L 1 -a</span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── .dockerignore</span><br><span class="line">├── flaskwebsite</span><br><span class="line">└── __pycache__</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>我們再重build一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -t flask-demo .</span><br><span class="line">Sending build context to Docker daemon  5.632kB</span><br></pre></td></tr></table></figure>

<p>就發現變成5.632kb囉</p>
<h2 id="dockerfile技術之多段構建"><a href="#dockerfile技術之多段構建" class="headerlink" title="dockerfile技術之多段構建"></a>dockerfile技術之多段構建</h2><p>有時候我們只需要一個可編譯的系統環境，也不必在host主機上安裝完整的編譯環境。就可以透過docker的環境來幫我們做到這件事情。但我們會發現可編譯程式的gcc鏡像檔(以編譯c語言為例)，容量是很擁腫的，有<code>1.44GB</code>以上。</p>
<p>查看鏡像大容量，<code>gcc</code>為<code>1.14GB</code>、 <code>hello-apline</code>為<code>6.55MB</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# docker images</span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">hello-apline     latest    aed1c277cad0   About a minute ago   6.55MB</span><br><span class="line">gcc              9.4       426442df2c0a   3 weeks ago          1.14GB</span><br><span class="line">alpine           3.13.5    6dbb9cc54074   10 months ago        5.61MB</span><br></pre></td></tr></table></figure>

<p>我們可以透過多段構建技巧，分段完成每一階段的任務。再最後階段再使用可執行c語言的鏡像檔幫我們build出小體積的鏡像檔。以下以這個為想法進行實驗與說明：</p>
<p>資料夾結構</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# tree</span><br><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── hello.c</span><br></pre></td></tr></table></figure>

<p><code>hello</code>檔</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello %s\n&quot;</span>, argv[argc - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>Dockerfile</code>檔</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 第一階段編譯</span></span><br><span class="line"><span class="comment">#拉取一個可編譯c語言的鏡像(image比較肥大)，別名為builder</span></span><br><span class="line"><span class="keyword">FROM</span> gcc:<span class="number">9.4</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment">#將檔案copy至內部容器之指定路徑</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hello.c /src/hello.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#預設當前目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行編輯 hello</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gcc --static -o hello hello.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二階段編譯(image比較輕量)</span></span><br><span class="line"><span class="comment">#拉取一個可執行c語言的鏡像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.13</span>.<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#從builder鏡像取出 src/hello 程式copy之當前鏡像容器內部</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /src/hello /src/hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#預設執行該指令碼</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/src/hello&quot;</span> ]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> []</span></span><br></pre></td></tr></table></figure>

<p>玩玩看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# docker container run  --rm -it hello-apline kite</span><br><span class="line">hello kite</span><br></pre></td></tr></table></figure>





<h2 id="dockerfile技巧之儘量使用非root用戶"><a href="#dockerfile技巧之儘量使用非root用戶" class="headerlink" title="dockerfile技巧之儘量使用非root用戶"></a>dockerfile技巧之儘量使用非root用戶</h2><p><code>dockerfile-root</code>檔</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<p><code>dockerfile-no-root</code>檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-slim</span><br><span class="line"></span><br><span class="line">RUN pip install flask &amp;&amp; \</span><br><span class="line">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \</span><br><span class="line">    mkdir /src &amp;&amp; \</span><br><span class="line">    chown -R flask:flask /src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用flask user帳號，避免使用root發生資安問題</span></span><br><span class="line">USER flask</span><br><span class="line"></span><br><span class="line">COPY app.py /src/app.py</span><br><span class="line"></span><br><span class="line">WORKDIR /src</span><br><span class="line">ENV FLASK_APP=app.py</span><br><span class="line"></span><br><span class="line">EXPOSE 5000</span><br><span class="line"></span><br><span class="line">CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">構建flask-no-root鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f dockerfile-no-root -t flask-no-root .</span><br><span class="line">Sending build context to Docker daemon   7.68kB</span><br><span class="line">Step 1/8 : FROM python:3.9.5-slim</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Successfully built b65dbef09eed</span><br><span class="line">Successfully tagged flask-no-root:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">構建flask-root鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f docker-root -t docker-root .</span><br><span class="line">unable to prepare context: unable to evaluate symlinks in Dockerfile path: lstat /home/kite/Desktop/pythonworkspace/docker-root: no such file or directory</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f dockerfile-root -t flask-root .</span><br><span class="line">Sending build context to Docker daemon   7.68kB</span><br><span class="line">Step 1/7 : FROM python:slim</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Successfully built 50a0190d1105</span><br><span class="line">Successfully tagged flask-root:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker images</span><br><span class="line">REPOSITORY       TAG          IMAGE ID       CREATED          SIZE</span><br><span class="line">flask-no-root    latest       b65dbef09eed   3 minutes ago    126MB</span><br><span class="line">flask-root       latest       50a0190d1105   2 hours ago      134MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建啟動flask-no-root</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d --rm --name flask-no-root flask-no-root</span><br><span class="line">8699d07e199436126092b6310ecf1a1fe7d68300b4a430d1209e94af1ff1073c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建啟動flask-root</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d --rm --name flask-root flask-root</span><br><span class="line">bb46a94bf7b5746ef0d3189fec59ae527531389955287c6df718cdb67c4a49a3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用container top 指令查看權限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#root權限的container</span></span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container top flask-root</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                54109               54086               0                   15:30               ?                   00:00:00            /usr/local/bin/python /usr/local/bin/flask run -h 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用container top 指令查看權限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#非root權限的container</span></span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container top flask-no-root</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">systemd+            54216               54196               0                   15:30               ?                   00:00:00            /usr/local/bin/python /usr/local/bin/flask run -h 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入到flask-root container容器內，以井字號開頭就說明是root權限</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker run -it flask-root sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入到flask-no-root container容器內，以錢字號開頭就說明是非root權限</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker run -it flask-no-root sh</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="小總結"><a href="#小總結" class="headerlink" title="小總結"></a>小總結</h2><p>dockerfile可以多參考相關連結</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">dockerfile reference</a></p>
<ul>
<li>官網的dockerfile reference docs</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/docker-library/official-images">docker-library&#x2F;official-images</a></p>
<ul>
<li>官網釋出的image，可以臨摹裡面的dockerfile寫法</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/18/2022-02-18%20Docker%20%E7%B3%BB%E5%88%97%20-%20(2)%20%E9%8F%A1%E5%83%8F%E7%9A%84%E5%89%B5%E5%BB%BA%E7%AE%A1%E7%90%86%E5%92%8C%E7%99%BC%E5%B8%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/18/2022-02-18%20Docker%20%E7%B3%BB%E5%88%97%20-%20(2)%20%E9%8F%A1%E5%83%8F%E7%9A%84%E5%89%B5%E5%BB%BA%E7%AE%A1%E7%90%86%E5%92%8C%E7%99%BC%E5%B8%83/" class="post-title-link" itemprop="url">docker 系列 - (2) 鏡像的創建管理和發布</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2022-02-18 13:47:00 / 修改時間：15:13:12" itemprop="dateCreated datePublished" datetime="2022-02-18T13:47:00+08:00">2022-02-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>31 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="鏡像的獲取方式"><a href="#鏡像的獲取方式" class="headerlink" title="鏡像的獲取方式"></a>鏡像的獲取方式</h2><ol>
<li><p>pull from <code>registry</code> (online ) 從registry拉取</p>
<ul>
<li><p>public(公有)</p>
</li>
<li><p>private(私有)</p>
<ul>
<li>自架類似dokcer hub 的伺服器</li>
</ul>
</li>
</ul>
</li>
<li><p>build from <code>Dockerfile</code> (online) 從dockerfile構建</p>
<ul>
<li>構建的過程需要上網，拉取基礎的images也可是自架的docker hub 伺服器</li>
</ul>
</li>
<li><p>load from <code>file</code>(offline)文件導入(離線)</p>
<ul>
<li>透過鏡像的<code>save</code>指令導出一個鏡像檔，可以通過usb等硬體裝置儲存攜帶，再插到另一台機器讀取，接著再利用<code>load</code>指令導入到docker裡。</li>
</ul>
</li>
</ol>
<p><img src="https://i.imgur.com/35wWMep.png" alt="docker-image"></p>
<h2 id="鏡像的registry介紹"><a href="#鏡像的registry介紹" class="headerlink" title="鏡像的registry介紹"></a>鏡像的registry介紹</h2><p>registry網站</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/">docker hub</a></li>
<li><a target="_blank" rel="noopener" href="https://quay.io/">Quay.io</a></li>
</ul>
<h2 id="鏡像的獲取和查看"><a href="#鏡像的獲取和查看" class="headerlink" title="鏡像的獲取和查看"></a>鏡像的獲取和查看</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取鏡像寫法</span></span><br><span class="line">docker image pull nginx </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">較舊寫法 不需要寫image</span></span><br><span class="line">docker pull nginx </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看本地的image 清單 以下兩個語法都可以</span></span><br><span class="line">docker image ls</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p>在nginx 後面如果沒有加上tag名稱時，會預設抓<code>latest</code>的tag進行拉取。</p>
<p>舉例來說，我們可以先從docker hub 找到你要的版本，以1.20.2為例：</p>
<p><img src="https://i.imgur.com/TR3XrgC.png" alt="image-20220216095102803"></p>
<p>接著我們在輸入指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker pull nginx:1.20.2</span><br><span class="line">1.20.2: Pulling from library/nginx</span><br><span class="line">5eb5b503b376: Pull complete </span><br><span class="line">cdfeb356c029: Pull complete </span><br><span class="line">d86da7454448: Pull complete </span><br><span class="line">7976249980ef: Pull complete </span><br><span class="line">8f66aa6726b2: Pull complete </span><br><span class="line">c004cabebe76: Pull complete </span><br><span class="line">Digest: sha256:02923d65cde08a49380ab3f3dd2f8f90aa51fa2bd358bd85f89345848f6e6623</span><br><span class="line">Status: Downloaded newer image for nginx:1.20.2</span><br><span class="line">docker.io/library/nginx:1.20.2</span><br><span class="line"></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker images</span><br><span class="line">REPOSITORY             TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx                  1.20.2    d6c9558ba445   2 weeks ago   141MB</span><br></pre></td></tr></table></figure>

<p>下<code>docker images</code>就會看到拉取了1.20.2 的鏡像。</p>
<p>我們用另一個示例來玩看看，首先，先到<code>quay</code>網站來查詢nginx，我們copy 指令<code>docker pull quay.io/bitnami/nginx</code>。針對這個指令的說明一下：</p>
<ul>
<li>第一個<code>quay.io</code>指的是registry 的網址</li>
<li>第二個<code>bitnami</code>是發行的組(group)或是擁有者(owner)，比如是一個用戶的id</li>
<li>第三個<code>nginx</code>是鏡像名稱</li>
</ul>
<p><img src="https://i.imgur.com/rV2MPWp.png" alt="image-20220216143013797"></p>
<p>執行完結果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker pull quay.io/bitnami/nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from bitnami/nginx</span><br><span class="line">a2b89359fa38: Pull complete </span><br><span class="line">eb3d3b400740: Pull complete </span><br><span class="line">46e8977b34c6: Pull complete </span><br><span class="line">ba19e4f3bb28: Pull complete </span><br><span class="line">b32f6ece772b: Pull complete </span><br><span class="line">93564c931307: Pull complete </span><br><span class="line">e5b3ce1bf203: Pull complete </span><br><span class="line">724a66987928: Pull complete </span><br><span class="line">e556e9ce9174: Pull complete </span><br><span class="line">61c0aa354bde: Pull complete </span><br><span class="line">c14227a7baae: Pull complete </span><br><span class="line">055df77435e3: Pull complete </span><br><span class="line">Digest: sha256:f9b149213fa98cee7750ede87bbec1109971c7a2cfa556c89b7d2cbf3697b213</span><br><span class="line">Status: Downloaded newer image for quay.io/bitnami/nginx:latest</span><br><span class="line">quay.io/bitnami/nginx:latest</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">quay.io/bitnami/nginx   latest    fef44885d7d3   15 hours ago   89.4MB</span><br><span class="line">nginx                   1.20.2    d6c9558ba445   2 weeks ago    141MB</span><br></pre></td></tr></table></figure>

<p>我們透過<code>docker image ls</code>看到的訊息是比較簡易的，如果要看完整詳細的docker訊息可以透過<code>docker image inspect [names] or [container id]</code></p>
<p>這個指定來看詳細內容，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect d6c</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        #這項是鏡像完整的id</span><br><span class="line">        &quot;Id&quot;: &quot;sha256:d6c9558ba4456741fc4ee304e1a75a561e1c8d92f5107a715b6224bb7844f507&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;nginx:1.20.2&quot;</span><br><span class="line">        ],</span><br><span class="line">        ... </span><br><span class="line">        #這項是鏡像的架構，比方說如果你是MAC 的M1晶片，可能就必須選用ARM架構，就選擇AMD64</span><br><span class="line">        &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">        #這項是鏡像的作業系統</span><br><span class="line">        &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">        ...</span><br><span class="line">        &quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">        #之前有講到docker是有分層的概念，也就是對應到這個，後續再詳細說明</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:7d0ebbe3f5d26c1b5ec4d5dbb6fe3205d7061f9735080b0162d550530328abd6&quot;,</span><br><span class="line">                &quot;sha256:f7d96e665ae1a81d81e18e2503b2341bec8491606ffa6e2b48480a8e741dfab7&quot;,</span><br><span class="line">                &quot;sha256:a64a30dea1c4b926a45abed0728327d079d2c5fa4a7b7e6aa2d06136783a27a2&quot;,</span><br><span class="line">                &quot;sha256:dc78c3d0e91713e0b45a209df1509fb96d4f6a4f3099f4dfbc9e9ae71b143e43&quot;,</span><br><span class="line">                &quot;sha256:8fa2ccbce0c21c1a0140ce0f2db6b92f92c16f9ff00e4c8a1daaea548799b698&quot;,</span><br><span class="line">                &quot;sha256:b1073b41766d15d7835ea97e5eaf7f2f8a06b7fd1549ecbc2c9697813ede853a&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>簡單說明幾個部分：</p>
<ul>
<li>ID<ul>
<li>鏡像的完整ID</li>
</ul>
</li>
<li>Architecture<ul>
<li>鏡像的架構，比方說如果你是MAC 的M1晶片，可能就必須選用ARM架構，就選擇AMD64</li>
</ul>
</li>
<li>Os<ul>
<li>鏡像的作業系統</li>
</ul>
</li>
<li>Layers<ul>
<li>之前有講到docker是有分層的概念，也就是對應到這個，後續再詳細說明</li>
</ul>
</li>
</ul>
<p>鏡像檔的刪除注意事項</p>
<p>透過以下的例子，我們發現其實要移除鏡像檔必須這個鏡像在沒有被container引用，並且就算已經停止的container 也必須移除，才有辦法完成鏡像檔的刪除動作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 列出目前的鏡像清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image ls</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">nginx                   latest    c316d5a335a5   2 weeks ago    142MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 啟動nginx</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker container run -d nginx</span><br><span class="line">7dc905570d71599e9712f2dd978f25ef987d351f15b85231e79a8f5099bfda2b</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 移除鏡像檔 發生錯誤</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image rm c3</span><br><span class="line">Error response from daemon: conflict: unable to delete c316d5a335a5 (cannot be forced) - image is being used by running container 7dc905570d71</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 停用container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker container stop 7dc9</span><br><span class="line">7dc9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 再次移除鏡像檔 發生錯誤</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image rm c3</span><br><span class="line">Error response from daemon: conflict: unable to delete c316d5a335a5 (must be forced) - image is being used by stopped container 7dc905570d71</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 移除container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker container rm 7dc9</span><br><span class="line">7dc9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 移除鏡像檔 完成</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image rm c3</span><br><span class="line">Untagged: nginx:latest</span><br><span class="line">Untagged: nginx@sha256:2834dc507516af02784808c5f48b7cbe38b8ed5d0f4837f16e78d00deb7e7767</span><br><span class="line">Deleted: sha256:c316d5a335a5cf324b0dc83b3da82d7608724769f6454f6d9a621f3ec2534a5a</span><br><span class="line">Deleted: sha256:67e568696593c33b4a15c9d81dc6f67499b8d973b88eb49b53d47bf4dbf4d187</span><br><span class="line">Deleted: sha256:0f8d4e3d979c540644f248b4206cf540978166b095223bdc950628dca2e8f3f1</span><br><span class="line">Deleted: sha256:5d75bfe8a7422476a495b27c8a1598d1206137631d350b8bdee13bc88f365282</span><br><span class="line">Deleted: sha256:8284a9e28c625b2826efdd6160ea1ff7f710881a4a2afe1ef58a5eb51d3f919e</span><br><span class="line">Deleted: sha256:89a1db9e1079b7574c1a707bc8c1fe04ff723bc71d4bca8bc48653e9a32186d2</span><br><span class="line">Deleted: sha256:7d0ebbe3f5d26c1b5ec4d5dbb6fe3205d7061f9735080b0162d550530328abd6</span><br></pre></td></tr></table></figure>

<h3 id="image-output-和image-load"><a href="#image-output-和image-load" class="headerlink" title="image output 和image load"></a>image output 和image load</h3><p>匯出指令，其中 <code>-o</code> 是<code>output</code>的縮寫</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image save quay.io/bitnami/nginx -o nginx.image</span><br></pre></td></tr></table></figure>

<p>匯入指令，其中 <code>-i</code>是 <code>input</code>的縮寫</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image load -i ./nginx.image </span><br></pre></td></tr></table></figure>

<h2 id="鏡像的導出和導入-offline"><a href="#鏡像的導出和導入-offline" class="headerlink" title="鏡像的導出和導入(offline)"></a>鏡像的導出和導入(offline)</h2><p>小實驗，動手下指令玩玩看，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匯出鏡像檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image save quay.io/bitnami/nginx -o nginx.image</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看當前路徑是否有剛剛匯出的鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# ll</span><br><span class="line">total 91340</span><br><span class="line">drwxr-xr-x  2 kite kite     4096  二  16 15:27 ./</span><br><span class="line">drwxr-xr-x 23 kite kite     4096  二  11 09:44 ../</span><br><span class="line">-rw-------  1 root root 93520384  二  16 15:27 nginx.image</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先刪除鏡像，為了後面測試load指定</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image rm quay.io/bitnami/nginx</span><br><span class="line">Untagged: quay.io/bitnami/nginx:latest</span><br><span class="line">Untagged: quay.io/bitnami/nginx@sha256:f9b149213fa98cee7750ede87bbec1109971c7a2cfa556c89b7d2cbf3697b213</span><br><span class="line">Deleted: sha256:fef44885d7d30571af3156ceaf232702d5b8f6771cda3ed724f8cc272e9c9829</span><br><span class="line">Deleted: sha256:a189c52fed386394dbb7ffb51c5c462ad2ba77c26c01d5c01e72b15e40db29c0</span><br><span class="line">Deleted: sha256:2f1c8bd99f51d77b4323230921f2ca86706e353cf2d775cf0b002e0e479f79e6</span><br><span class="line">Deleted: sha256:5c2ae43f5fa2f4dacbf202f3a363c3320eba7f78806e059bb0f893b925c46f53</span><br><span class="line">Deleted: sha256:0a946840cdb0258bf1b59a31680050dd60085769b79f3b44d7aa17ec069424f6</span><br><span class="line">Deleted: sha256:c5693486bf8d9e4a52a4925ff9f0c37861c3bb7646484f424b9a6b04b1b0eaf3</span><br><span class="line">Deleted: sha256:9efb4fc4677072eb2a7d83a8cf75aff78e35599aed05d4177b02bc557f878832</span><br><span class="line">Deleted: sha256:342797d9b97f8ca828cd8c7fc8081497627a0c249f1a808f7df8f66de8c48969</span><br><span class="line">Deleted: sha256:2b660bfea22ebf12cf21e46a323d73c68ef0094fc327d8ff1f7b9c5e6c8540e5</span><br><span class="line">Deleted: sha256:00251eb08c244921e37ee3e3f0e7b1f03d1f0d465f88c268372e6b1bbd3a29ad</span><br><span class="line">Deleted: sha256:305bbe3d88ac18f896068c246f07787570634b63bfbd47a2b9d65329b7d25558</span><br><span class="line">Deleted: sha256:a0fc422098a3de3df394bfcb3e085abd4fe28f58ef8b1d8f5a273529fbf5e65d</span><br><span class="line">Deleted: sha256:ae58f1561944087b459d2688dff7eda143f4d7512f05bf2b52f134fdfd2b8cd4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加載剛output的鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker image load -i ./nginx.image </span><br><span class="line">ae58f1561944: Loading layer [==================================================&gt;]   70.8MB/70.8MB</span><br><span class="line">2f6f61f3bbc9: Loading layer [==================================================&gt;]  81.92kB/81.92kB</span><br><span class="line">3bfda742b4b4: Loading layer [==================================================&gt;]  15.14MB/15.14MB</span><br><span class="line">6ed2fe854cdb: Loading layer [==================================================&gt;]  2.634MB/2.634MB</span><br><span class="line">dddc1a8d1029: Loading layer [==================================================&gt;]  2.374MB/2.374MB</span><br><span class="line">269fbc668e52: Loading layer [==================================================&gt;]  2.307MB/2.307MB</span><br><span class="line">c12665b38039: Loading layer [==================================================&gt;]  5.632kB/5.632kB</span><br><span class="line">52f2403acee0: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">260212c608b3: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">0eca2613dc76: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">29a9d19d38b2: Loading layer [==================================================&gt;]  60.42kB/60.42kB</span><br><span class="line">da0a9db5694c: Loading layer [==================================================&gt;]  60.93kB/60.93kB</span><br><span class="line">Loaded image: quay.io/bitnami/nginx:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看目前鏡像清單，成功的匯入囉</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">quay.io/bitnami/nginx   latest    fef44885d7d3   16 hours ago   89.4MB</span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile介紹"><a href="#Dockerfile介紹" class="headerlink" title="Dockerfile介紹"></a>Dockerfile介紹</h2><p>官網的dockerfile 說明</p>
<blockquote>
<p>Docker can build images automatically by reading the instructions from a <code>Dockerfile</code>. A Dockerfile is a <code>text</code> document that contains all the commands a user could call on the command line to assemble an image. Using docker build users can create an automated build that executes several command-line instructions in succession.</p>
</blockquote>
<ul>
<li>Dockerfile 是用於構建於docker鏡像的文件<ul>
<li>也可以說是一個構建的腳本</li>
</ul>
</li>
<li>Dockerfile 裡面包含了構建鏡像所需的”指令”</li>
<li>Dockerfile有其特定的語法規則</li>
</ul>
<h2 id="鏡像構建準備"><a href="#鏡像構建準備" class="headerlink" title="鏡像構建準備"></a>鏡像構建準備</h2><h3 id="舉例：執行一個python程式"><a href="#舉例：執行一個python程式" class="headerlink" title="舉例：執行一個python程式"></a>舉例：執行一個python程式</h3><p>假如我們要在一台ubuntu21.04上運行下面這個hello.py的python腳本</p>
<h4 id="python腳本"><a href="#python腳本" class="headerlink" title="python腳本"></a>python腳本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello docker,I&#x27;m kite&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>所以我們這個環境需要兩樣東西<code>ubuntu21.04</code>、<code>python</code>，並且執行<code>python3 hello.py</code>腳本。</p>
<h4 id="具體Dockerfile結構"><a href="#具體Dockerfile結構" class="headerlink" title="具體Dockerfile結構"></a>具體Dockerfile結構</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello.py /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;/hello.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><code>FROM</code>：抓一個我們需要的<code>ubuntu版本</code></p>
<p><code>RUN</code>：下指令安裝python</p>
<p><code>ADD</code>：加入hello.py 腳本至鏡像內的根目錄</p>
<p><code>CMD</code>：以python3 方式執行 路徑<code>/hello.py</code>程式</p>
<h4 id="執行流程"><a href="#執行流程" class="headerlink" title="執行流程"></a>執行流程</h4><ol>
<li><p>建立目錄</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir genDockerImagesFolder</span><br></pre></td></tr></table></figure>
</li>
<li><p>進入目錄</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd genDockerImagesFolder/</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立hello.py檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;print(&#x27;hello,docker&#x27;)&quot; &gt; hello.py</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立Dockerfile檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOT &gt;&gt; Dockerfile</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">FROM ubuntu:21.04</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">RUN apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">&gt;     DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ADD hello.py /</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">CMD [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;/hello.py&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOT</span></span><br></pre></td></tr></table></figure>

<p>說明：在build image檔時，必須在資料夾內有<code>Dockerfile</code>檔案，後續下build指令才會成功</p>
</li>
<li><p>確認資料夾檔案</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll</span><br></pre></td></tr></table></figure>
</li>
<li><p>build 鏡像檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指令格式</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker image build -t [imagename] [path]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">預設是lastest</span></span><br><span class="line">docker image build -t hello .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">給tag</span></span><br><span class="line">docker image build -t hello:1.0 .</span><br></pre></td></tr></table></figure>

<p>說明：</p>
<p><code>-t</code>：指的是tag</p>
<p><code>imagename</code>：hello</p>
<p><code>path</code>：<code>.</code>(當前路徑)</p>
</li>
</ol>
<p>具體語法說明可以參考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a>，以下是練習建image的指令過程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立目錄</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# mkdir genDockerImagesFolder</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入目錄</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# cd genDockerImagesFolder/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立hello.py檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# echo &quot;print(&#x27;hello,docker&#x27;)&quot; &gt; hello.py</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立Dockerfile檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# cat &lt;&lt;EOT &gt;&gt; Dockerfile</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">FROM ubuntu:21.04</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">RUN apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">&gt;     DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ADD hello.py /</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">CMD [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;/hello.py&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOT</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">確認資料夾檔案</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# ll</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 2 root root 4096  二  17 11:58 ./</span><br><span class="line">drwxr-xr-x 3 kite kite 4096  二  17 11:50 ../</span><br><span class="line">-rw-r--r-- 1 root root  198  二  17 11:58 Dockerfile</span><br><span class="line">-rw-r--r-- 1 root root   22  二  17 11:51 hello.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">build 鏡像檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image build -t hello .</span><br><span class="line"></span><br><span class="line">Step 1/4 : FROM ubuntu:21.04</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">7cc39f89fa58</span></span><br><span class="line">Step 2/4 : RUN apt-get update &amp;&amp;     DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y python3.9 </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Step 3/4 : ADD hello.py /</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">864392501c61</span></span><br><span class="line">Step 4/4 : CMD [&quot;python3&quot;, &quot;/hello.py&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 6ddb6041461e</span></span><br><span class="line">Removing intermediate container 6ddb6041461e</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">698fa0b38d79</span></span><br><span class="line">Successfully built 698fa0b38d79</span><br><span class="line">Successfully tagged hello:latest</span><br></pre></td></tr></table></figure>

<p>build 的過程需要一些時間，等到我們看到suceccfully之後，代表已經完成了，接著檢查看看下指令<code>docker images</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">hello                   latest    698fa0b38d79   15 minutes ago   206MB</span><br></pre></td></tr></table></figure>

<p>hello 鏡像檔就出現在清單中囉，如果要導出鏡像記得再看前面的部分進行操作即可。</p>
<p>試著用<code>it</code> 交互的相方運行hello 容器如下：&#96;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it hello</span><br><span class="line">hello,docker</span><br></pre></td></tr></table></figure>

<h2 id="鏡像分享"><a href="#鏡像分享" class="headerlink" title="鏡像分享"></a>鏡像分享</h2><ol>
<li><p>先註冊一個<code>Dockerhub</code>帳號</p>
</li>
<li><p>因為先前建立的鏡像沒有加上用戶名，所以可以通過以下兩個方式做準備</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重新build一個並加入<span class="built_in">id</span></span></span><br><span class="line">docker image build -t kitefree/hello .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">針對既有的hello鏡像 複製並新增一個</span></span><br><span class="line">docker image tag hello kitefree/hello:1.0</span><br></pre></td></tr></table></figure>

<p>執行登入指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure>

<p>登出為</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logout</span><br></pre></td></tr></table></figure>

<p>會要求輸入帳號密碼，登入完成後進行布署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image push kitefree/hello:1.0</span><br></pre></td></tr></table></figure>

<p>過程如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker login</span><br><span class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don&#x27;t have a Docker ID, head over to https://hub.docker.com to create one.</span><br><span class="line">Username: kitefree</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image push kitefree/hello:1.0</span><br><span class="line">The push refers to repository [docker.io/kitefree/hello]</span><br><span class="line">3948f6982f11: Pushed </span><br><span class="line">24ac8aef82f9: Pushed </span><br><span class="line">dca6a631e9bb: Mounted from library/ubuntu </span><br><span class="line">1.0: digest: sha256:8f7be9cd060a67593a089a4111b8c5a3127e324c49aeed0843f578a100eba2b6 size: 948</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著登入後台查看一下結果</p>
<p><img src="https://i.imgur.com/U7yXbV0.png" alt="image-20220218091548874"></p>
<p><img src="https://i.imgur.com/5a0sZqq.png" alt="image-20220218091724911"></p>
<p>我們試著pull鏡像檔下來，我們先把本地端的鏡像檔刪除。</p>
<p>拉取鏡像語法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kitefree/hello:1.0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除本地鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image rm kitefree/hello:1.0</span><br><span class="line">Untagged: kitefree/hello:1.0</span><br><span class="line">Untagged: kitefree/hello@sha256:8f7be9cd060a67593a089a4111b8c5a3127e324c49aeed0843f578a100eba2b6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker pull kitefree/hello:1.0</span><br><span class="line">1.0: Pulling from kitefree/hello</span><br><span class="line">Digest: sha256:8f7be9cd060a67593a089a4111b8c5a3127e324c49aeed0843f578a100eba2b6</span><br><span class="line">Status: Downloaded newer image for kitefree/hello:1.0</span><br><span class="line">docker.io/kitefree/hello:1.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">檢查本地鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">kitefree/hello          1.0       698fa0b38d79   17 hours ago   206MB</span><br></pre></td></tr></table></figure>

<h2 id="通過commit創建鏡像"><a href="#通過commit創建鏡像" class="headerlink" title="通過commit創建鏡像"></a>通過commit創建鏡像</h2><p>我們目標是進入容器內部直接修改文件，停用再啟用容器，我們會發現改的東西已經成功寫入到容器內部了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動一個nginx容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker run -d -p 8000:80 --name nginx01 nginx</span><br><span class="line">5544cc14e2af3ed16dc875a9bb9b3594066bc695f94272ce6f6794f4a66714a7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入容器內部</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker exec -it 554 sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改首頁文字</span></span><br><span class="line">echo &quot;hello,docker&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">離開容器</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker container stop 554</span><br><span class="line">554     </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟用容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker container start 554</span><br><span class="line">554</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看容器異動的差異</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker diff nginx01</span><br><span class="line">C /var</span><br><span class="line">C /var/cache</span><br><span class="line">C /var/cache/nginx</span><br><span class="line">A /var/cache/nginx/fastcgi_temp</span><br><span class="line">A /var/cache/nginx/proxy_temp</span><br><span class="line">A /var/cache/nginx/scgi_temp</span><br><span class="line">A /var/cache/nginx/uwsgi_temp</span><br><span class="line">A /var/cache/nginx/client_temp</span><br><span class="line">C /usr</span><br><span class="line">C /usr/share</span><br><span class="line">C /usr/share/nginx</span><br><span class="line">C /usr/share/nginx/html</span><br><span class="line">C /usr/share/nginx/html/index.html</span><br><span class="line">C /run</span><br><span class="line">A /run/nginx.pid</span><br><span class="line">C /etc</span><br><span class="line">C /etc/nginx</span><br><span class="line">C /etc/nginx/conf.d</span><br><span class="line">C /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以瀏覽器去查看webserver 的確在啟動後是有修改還是有效的。</p>
<p><img src="https://i.imgur.com/AuJjhzo.png" alt="image-20220218102300209"></p>
<p>接著，我們來玩玩看用commit 指令創建一個鏡像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定容器<span class="built_in">id</span> 554 進行commit 並創建名為 kitefree/nginx 儲存庫</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker commit 554 kitefree/nginx</span><br><span class="line">sha256:799b17a2576601b6db1431f9d5b901843470ad9180e9c99aa86c0d1a7aef4569</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看目前鏡像清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">kitefree/nginx          latest    799b17a25766   8 seconds ago   142MB</span><br><span class="line">nginx                   latest    c316d5a335a5   3 weeks ago     142MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動容器 並給port 8001</span> </span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop# docker run -d -p 8001:80 --name kite_nginx kitefree/nginx </span><br><span class="line">4416889d90c4dc29292cbbe3cc35184d240d491975a2367c800651329ddc5627</span><br></pre></td></tr></table></figure>

<p>在以瀏覽器方式查看，我們會看到一樣為<code>hello,docker</code>的網頁顯示訊息。</p>
<h2 id="聊聊scratch鏡像"><a href="#聊聊scratch鏡像" class="headerlink" title="聊聊scratch鏡像"></a>聊聊scratch鏡像</h2><p>是一個empty image ，無法通過docker pull 拉取鏡像，但是可以<code>FROM scratch</code> 構建鏡像。在工作上比較少用到scratch鏡像，所以簡單的玩一下</p>
<p>以下為測試的執行過程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個c語言的程式碼</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# cat &lt;&lt;EOT &gt;&gt;hello.c</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="comment">#include&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt; int main()</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    <span class="built_in">printf</span>(<span class="string">&quot;hello docker\n&quot;</span>);</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&#125;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOT</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行編譯產出hello檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# gcc --static -o hello hello.c</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# ls</span><br><span class="line">Dockerfile  hello  hello.c  hello.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">測試執行是否正常輸入字串</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# ./hello</span><br><span class="line">hello docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立dockerfile檔案</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# cat &lt;&lt;EOT &gt;&gt;Dockerfile</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">FROM scratch</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ADD hello /</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">CMD [<span class="string">&quot;/hello&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOT</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">構建鏡像檔</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker build -t kitefree/scratch .</span><br><span class="line">Sending build context to Docker daemon  876.5kB</span><br><span class="line">Step 1/3 : FROM scratch</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">Step 2/3 : ADD hello /</span></span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">f95110c6fba2</span></span><br><span class="line">Step 3/3 : CMD [&quot;/hello&quot;]</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 3a60c6a60ed1</span></span><br><span class="line">Removing intermediate container 3a60c6a60ed1</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">f39f26ad08a6</span></span><br><span class="line">Successfully built f39f26ad08a6</span><br><span class="line">Successfully tagged kitefree/scratch:latest</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker images</span><br><span class="line">REPOSITORY              TAG       IMAGE ID       CREATED             SIZE</span><br><span class="line">kitefree/scratch        latest    f39f26ad08a6   7 seconds ago       872kB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動容器執行 ，這邊多加了<span class="built_in">rm</span>參數是指執行完後會自動刪除容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm kitefree/scratch </span><br><span class="line">hello docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="拉取次數的計算"><a href="#拉取次數的計算" class="headerlink" title="拉取次數的計算"></a>拉取次數的計算</h2><p>如果是以匿名方式拉取，會以IP方式計算</p>
<p>如果是以帳號登入方式拉取，那計算方式就會計算在帳號上面。當在公司同一個網段時，如果都用帳號的部分去進行拉取，基本上比較不用擔心有次數上的問題。</p>
<p>拉取次數目前的使用狀況可以透過curl request 指令進行查詢</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/15/2022-02-14%20Docker%20%E7%B3%BB%E5%88%97%20-%20(1)%20%E5%AE%B9%E5%99%A8%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/15/2022-02-14%20Docker%20%E7%B3%BB%E5%88%97%20-%20(1)%20%E5%AE%B9%E5%99%A8%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" class="post-title-link" itemprop="url">docker 系列 - (1) 容器快速上手</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2022-02-15 16:47:00 / 修改時間：17:04:18" itemprop="dateCreated datePublished" datetime="2022-02-15T16:47:00+08:00">2022-02-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="docker命令行的基本使用"><a href="#docker命令行的基本使用" class="headerlink" title="docker命令行的基本使用"></a>docker命令行的基本使用</h2><p>docker + 管理的對象(比如容器、鏡像)  + 具體操作(比如創建、啟動、停止、刪除)</p>
<ul>
<li><code>docker image pull nginx</code> 拉取一个叫nginx的docker image鏡像</li>
<li><code>docker container stop web</code> 停止一个叫web的docker container容器</li>
</ul>
<h2 id="Image-vs-Container-鏡像-vs-容器"><a href="#Image-vs-Container-鏡像-vs-容器" class="headerlink" title="Image vs Container 鏡像 vs 容器"></a>Image vs Container 鏡像 vs 容器</h2><h3 id="image鏡像"><a href="#image鏡像" class="headerlink" title="image鏡像"></a>image鏡像</h3><ul>
<li>docker image 是一個 <code>read-only</code>文件</li>
<li>這個文件包含文件系統、源碼、庫文件、依賴、工具等一些運行application所需要的文件</li>
<li>可以理解成一個模板</li>
<li>docker image具有分層的概念</li>
</ul>
<h3 id="container容器"><a href="#container容器" class="headerlink" title="container容器"></a>container容器</h3><ul>
<li><p>“一個運行中的docker image”</p>
</li>
<li><p>實質是複製image全在image最上層加上一層<code>read-write</code>的層(稱之為&#96;container layer，容器層)</p>
</li>
<li><p>基於同一個image可以創建多個container</p>
<p><img src="https://i.imgur.com/NVZ3BEv.png" alt="docker-image-vs-container"></p>
</li>
</ul>
<h2 id="docker-image的獲取方式"><a href="#docker-image的獲取方式" class="headerlink" title="docker image的獲取方式"></a>docker image的獲取方式</h2><ul>
<li>自己製作</li>
<li>從registry拉取(比如docker hub)</li>
</ul>
<h2 id="容器的基本操作"><a href="#容器的基本操作" class="headerlink" title="容器的基本操作"></a>容器的基本操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker 版本</span></span><br><span class="line">dcoker version</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker 相關資訊，比如目前有幾個container、images、container運行狀態</span></span><br><span class="line">docker info</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">可以以看到列出了managment commands 、commands</span> </span><br><span class="line">docker</span><br><span class="line"></span><br><span class="line">Management Commands:</span><br><span class="line">  builder     Manage builds</span><br><span class="line">  buildx*     Docker Buildx (Docker Inc., v0.7.1)</span><br><span class="line">  compose*    Docker Compose (Docker Inc., v2.2.1)</span><br><span class="line">  config      Manage Docker configs</span><br><span class="line">  container   Manage containers</span><br><span class="line">  context     Manage contexts</span><br><span class="line">  image       Manage images</span><br><span class="line">  manifest    Manage Docker image manifests and manifest lists</span><br><span class="line">  network     Manage networks</span><br><span class="line">  node        Manage Swarm nodes</span><br><span class="line">  plugin      Manage plugins</span><br><span class="line">  scan*       Docker Scan (Docker Inc., 0.9.0)</span><br><span class="line">  secret      Manage Docker secrets</span><br><span class="line">  service     Manage services</span><br><span class="line">  stack       Manage Docker stacks</span><br><span class="line">  swarm       Manage Swarm</span><br><span class="line">  system      Manage Docker</span><br><span class="line">  trust       Manage trust on Docker images</span><br><span class="line">  volume      Manage volumes</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  attach      Attach local standard input, output, and error streams to a running container</span><br><span class="line">  build       Build an image from a Dockerfile</span><br><span class="line">  commit      Create a new image from a container&#x27;s changes</span><br><span class="line">  cp          Copy files/folders between a container and the local filesystem</span><br><span class="line">  create      Create a new container</span><br><span class="line">  diff        Inspect changes to files or directories on a container&#x27;s filesystem</span><br><span class="line">  events      Get real time events from the server</span><br><span class="line">  exec        Run a command in a running container</span><br><span class="line">  export      Export a container&#x27;s filesystem as a tar archive</span><br><span class="line">  history     Show the history of an image</span><br><span class="line">  images      List images</span><br><span class="line">  import      Import the contents from a tarball to create a filesystem image</span><br><span class="line">  info        Display system-wide information</span><br><span class="line">  inspect     Return low-level information on Docker objects</span><br><span class="line">  kill        Kill one or more running containers</span><br><span class="line">  load        Load an image from a tar archive or STDIN</span><br><span class="line">  login       Log in to a Docker registry</span><br><span class="line">  logout      Log out from a Docker registry</span><br><span class="line">  logs        Fetch the logs of a container</span><br><span class="line">  pause       Pause all processes within one or more containers</span><br><span class="line">  port        List port mappings or a specific mapping for the container</span><br><span class="line">  ps          List containers</span><br><span class="line">  pull        Pull an image or a repository from a registry</span><br><span class="line">  push        Push an image or a repository to a registry</span><br><span class="line">  rename      Rename a container</span><br><span class="line">  restart     Restart one or more containers</span><br><span class="line">  rm          Remove one or more containers</span><br><span class="line">  rmi         Remove one or more images</span><br><span class="line">  run         Run a command in a new container</span><br><span class="line">  save        Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">  search      Search the Docker Hub for images</span><br><span class="line">  start       Start one or more stopped containers</span><br><span class="line">  stats       Display a live stream of container(s) resource usage statistics</span><br><span class="line">  stop        Stop one or more running containers</span><br><span class="line">  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span><br><span class="line">  top         Display the running processes of a container</span><br><span class="line">  unpause     Unpause all processes within one or more containers</span><br><span class="line">  update      Update configuration of one or more containers</span><br><span class="line">  version     Show the Docker version information</span><br><span class="line">  wait        Block until one or more containers stop, then print their exit codes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">針對container 指令查看</span></span><br><span class="line">docker container --help</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">針對image 指令查看</span></span><br><span class="line">docker image --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出image</span></span><br><span class="line">docker image ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除image</span></span><br><span class="line">docker image rm docker/getting-started</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建container</span></span><br><span class="line">docker container run </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建container nginx ,本地沒有找到直接去找docker hub 下載 並直接運行，並且是前台運行的container</span></span><br><span class="line">docker container run nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出container ，ps 為較舊版本的命令 ，<span class="built_in">ls</span>、ps效果是一樣的</span></span><br><span class="line">docker container ls</span><br><span class="line">docker container ps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出container 包含stop的container</span></span><br><span class="line"></span><br><span class="line">docker container ps -a</span><br><span class="line">docker container ls -a</span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker run 省略container 是較舊的寫法</span></span><br><span class="line">docker container run nginx </span><br><span class="line">docker run nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止容器</span></span><br><span class="line">docker container stop [NAMES] or [Container id]</span><br><span class="line">docker stop [NAMES] or [Container id]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除容器</span></span><br><span class="line">docker container rm [NAMES] or [Container id]</span><br><span class="line">docker rm  [NAMES] or [Container id]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container run nginx</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">343fd4031609   nginx     &quot;/docker-entrypoint.…&quot;   6 seconds ago   Up 5 seconds   80/tcp    xenodochial_clarke</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container <span class="built_in">ls</span></span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">343fd4031609   nginx     &quot;/docker-entrypoint.…&quot;   14 seconds ago   Up 13 seconds   80/tcp    xenodochial_clarke</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container stop 34</span></span><br><span class="line">34</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container <span class="built_in">ls</span> -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">343fd4031609   nginx     &quot;/docker-entrypoint.…&quot;   29 seconds ago   Exited (0) 5 seconds ago              xenodochial_clarke</span><br><span class="line">d9095daa8bcf   nginx     &quot;/docker-entrypoint.…&quot;   28 minutes ago   Exited (0) 28 minutes ago             suspicious_shamir</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container <span class="built_in">rm</span> 34</span></span><br><span class="line">34</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container <span class="built_in">ls</span> -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">d9095daa8bcf   nginx     &quot;/docker-entrypoint.…&quot;   28 minutes ago   Exited (0) 28 minutes ago             suspicious_shamir</span><br><span class="line"><span class="meta prompt_">$</span></span><br></pre></td></tr></table></figure>





<h2 id="命令行小技巧之批次操作"><a href="#命令行小技巧之批次操作" class="headerlink" title="命令行小技巧之批次操作"></a>命令行小技巧之批次操作</h2><h3 id="批次停止"><a href="#批次停止" class="headerlink" title="批次停止"></a>批次停止</h3><p>先查詢目前的清單如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker container ps</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">cd3a825fedeb   nginx     &quot;/docker-entrypoint.…&quot;   7 seconds ago    Up 6 seconds    80/tcp    mystifying_leakey</span><br><span class="line">269494fe89fa   nginx     &quot;/docker-entrypoint.…&quot;   9 seconds ago    Up 8 seconds    80/tcp    funny_gauss</span><br><span class="line">34b68af9deef   nginx     &quot;/docker-entrypoint.…&quot;   12 seconds ago   Up 10 seconds   80/tcp    interesting_mahavira</span><br><span class="line">7513949674fc   nginx     &quot;/docker-entrypoint.…&quot;   13 seconds ago   Up 12 seconds   80/tcp    kind_nobel</span><br></pre></td></tr></table></figure>

<p>方法1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刪除多個container ，以下為例刪除4個container</span></span><br><span class="line">docker container stop af 87 c2 4c</span><br></pre></td></tr></table></figure>



<p>方法2</p>
<p>透過以下指令我們可以發現會出輸id清單</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">輸出 conainter <span class="built_in">id</span> list</span></span><br><span class="line">docker container ps -aq</span><br><span class="line"></span><br><span class="line">cd3a825fedeb</span><br><span class="line">269494fe89fa</span><br><span class="line">34b68af9deef</span><br><span class="line">7513949674fc</span><br></pre></td></tr></table></figure>

<p>接著利用以下方式批次停用container</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container stop $(docker container ps -qa)</span><br></pre></td></tr></table></figure>



<h3 id="批次刪除"><a href="#批次刪除" class="headerlink" title="批次刪除"></a>批次刪除</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">批次刪除</span></span><br><span class="line">docker container rm $(docker ps -aq)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">批次強制刪除</span></span><br><span class="line">docker container rm -f $(docker container ls -aq)</span><br></pre></td></tr></table></figure>

<p>補充說明：</p>
<ul>
<li>container 在運行的過程中是不行刪除的，除非先stop。</li>
</ul>
<p>另一個方法是強制刪除，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container rm 704 -f</span><br></pre></td></tr></table></figure>

<ul>
<li>可以快速對系統進行清理，删除停止的容器，不用的image，等等</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -a -f</span><br></pre></td></tr></table></figure>







<h2 id="容器的attached和detached模式"><a href="#容器的attached和detached模式" class="headerlink" title="容器的attached和detached模式"></a>容器的attached和detached模式</h2><h3 id="attached"><a href="#attached" class="headerlink" title="attached"></a>attached</h3><p>前台的執行我們稱之為attached ，輸入輸出的結果attached本地的輸入輸出，也會將ctrl + c 輸入(反應)至容器內部。</p>
<p>而windows 的attached 不是完整的attached，只有做到容器的輸出打印出來，無法接收ctrl + c 的輸入指令。(LINUX 是完整attach)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">前台模式執行docker</span></span><br><span class="line">docker container run -p 80:80 nginx</span><br></pre></td></tr></table></figure>

<p>指令說明：<code>-p 80:80</code> 對外port:容器port ，也就是對外的80 port 映射容器 80 port</p>
<h3 id="detached"><a href="#detached" class="headerlink" title="detached"></a>detached</h3><p>後台的執行我們稱之為detached </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">背景模式執行docker 以下二種都可以</span></span><br><span class="line">docker run --detach -p</span><br><span class="line">docker run -d -p</span><br></pre></td></tr></table></figure>

<p>我們發現這樣執行後，只有拿到container id的輸出，我們看不到nginx 的log 輸出囉</p>
<p>如果想要去attach這個容器，使用以下指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach [NAMES] or [Container id]</span><br></pre></td></tr></table></figure>

<p>我們會發現再去打開瀏覽器刷新一下頁面(<code>http://localhost:80</code>)，回過頭來看terminal就會看到nginx有輸出log 囉。</p>
<p><img src="https://i.imgur.com/DHpSx6M.png" alt="image-20220214133614727"></p>
<p>小結：我們比較常用的是detached 創建容器。</p>
<h2 id="容器的交互式模式"><a href="#容器的交互式模式" class="headerlink" title="容器的交互式模式"></a>容器的交互式模式</h2><h3 id="docker-container-logs-介紹"><a href="#docker-container-logs-介紹" class="headerlink" title="docker container logs 介紹"></a>docker container logs 介紹</h3><p>除了我們稍早講到的 <code>docker attch</code>指令方法得到相關log，也可以使用另外一個指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container logs [NAMES] or [Container id]</span><br></pre></td></tr></table></figure>

<p>這個指令是取得<code>/docker-entrypoint.sh</code>腳本輸出。</p>
<p><img src="https://i.imgur.com/Ag4rG8C.png" alt="image-20220214140333028"></p>
<p>如果我們需要即時出輸log的話可以透過以下指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container logs -f [NAMES] or [Container id]</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/fZVe3F9.png" alt="image-20220214140509765"></p>
<p>接著，再去打開瀏覽器刷新一下頁面(<code>http://localhost:80</code>)，回過頭來看terminal就會看即時的log輸出囉</p>
<p><img src="https://i.imgur.com/Myvxh17.png" alt="image-20220214140439035"></p>
<p><img src="https://i.imgur.com/HinfKfJ.png" alt="image-20220214140415333"></p>
<h3 id="創建容器時並進入交互式模式"><a href="#創建容器時並進入交互式模式" class="headerlink" title="創建容器時並進入交互式模式"></a>創建容器時並進入交互式模式</h3><p>透過以下指令可以進行交互模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run -it ubuntu sh</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/lyqVptM.png" alt="image-20220214140232538"></p>
<p>進入到了container 內部，當要離開container 時只要輸入<code>exit</code>指令就行了。</p>
<p>我們再去觀查<code>docker container ps -a</code> 會發現剛剛的ubuntu container 是停止的</p>
<p><img src="https://i.imgur.com/g8jcwYt.png" alt="image-20220214140127592"></p>
<h3 id="在一個已經運行的容器裡執行一個額外的command"><a href="#在一個已經運行的容器裡執行一個額外的command" class="headerlink" title="在一個已經運行的容器裡執行一個額外的command"></a>在一個已經運行的容器裡執行一個額外的command</h3><p>查看一下目前容器的狀態與ID</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/M3bXiWg.png" alt="image-20220214152023529"></p>
<p>執行以下指令進入到容器內部</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it [NAMES] or [Container id] sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">例子</span></span><br><span class="line">docker exec -it ae4 sh</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/FXtsQ6T.png" alt="image-20220214152108100"></p>
<h3 id="BusyBox-介紹"><a href="#BusyBox-介紹" class="headerlink" title="BusyBox 介紹"></a>BusyBox 介紹</h3><p><code>BusyBox</code>是一個集成了一百多個最常用linux命令和工具(如<code>cat</code>、<code>echo</code>、<code>grep</code>、<code>mount</code>‘、<code>telnet</code>等)的精簡工具箱，它只需要幾MB的大小，很方便進行個種快速驗證，被譽為”LINUX系統的瑞士軍刀”。</p>
<p><code>BusyBox</code>可運行於多款<code>POSIX</code>環境的操作系統中，如<code>LINUX</code>(包括<code>android</code>)、<code>Hurd</code>、<code>FreeBSD</code>等。</p>
<p><code>BusyBox</code> 鏡像雖然小巧，但包括了大量常見的 <code>Linux</code> 命令，讀者可以用它快速熟悉 <code>Linux</code> 命令。</p>
<h2 id="容器和虛擬機-Container-vs-VM"><a href="#容器和虛擬機-Container-vs-VM" class="headerlink" title="容器和虛擬機 Container vs VM"></a>容器和虛擬機 Container vs VM</h2><p><img src="https://i.imgur.com/5K8U5Ms.jpg" alt="docker-vs-vm"></p>
<h3 id="虛擬機"><a href="#虛擬機" class="headerlink" title="虛擬機"></a>虛擬機</h3><ul>
<li>要虛擬出完整的系統包含了作業系統<ul>
<li>需要Hypervisor支持，並且在這些軟件之上創建虛擬機<ul>
<li>vmware</li>
<li>virtual box</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><ul>
<li>運行在container engine之上的虛擬容器</li>
</ul>
<h3 id="容器不是Mini虛擬機"><a href="#容器不是Mini虛擬機" class="headerlink" title="容器不是Mini虛擬機"></a>容器不是Mini虛擬機</h3><ul>
<li>容器其實是進程 <ul>
<li>Container are just processes</li>
</ul>
</li>
<li>容器中的進程被限制了對CPU、記憶體等資源的訪問<ul>
<li>我們可以對容器進行一些限制，比方說CPU使用2核、記憶體只能使用1G。這概念在VM也是可以的。</li>
</ul>
</li>
<li>當進程停止後，容器就退出了。</li>
</ul>
<h3 id="證明容器即是process"><a href="#證明容器即是process" class="headerlink" title="證明容器即是process"></a>證明容器即是process</h3><p>首先使用 <code>docker ps</code> 找目前容器的id</p>
<p><img src="https://i.imgur.com/uxAyoP5.png" alt="image-20220215152923918"></p>
<p>我們會看到其實nginx 是執行一個 docker-entrypoint.sh 的一個腳本，這個腳本當然也就是自動啟用nginx的相關指令。</p>
<p>我們輸入 <code>docker container top [Names] or [Container id]</code> ，會顯示出這個容器裡面運行了哪些進程，下圖我們試著輸入<code>docker container top 6cb</code></p>
<p><img src="https://i.imgur.com/19MsVc1.png" alt="image-20220215153056159"></p>
<p>我們可以看到在CMD有一個主進程(master process) ，而PPID欄位指的是此進程的父進程是誰，比方說4576、4577 的父進程都是指向4516 ，而我們再去找PID為4516的，我們會發現也就是我們剛剛講是主進程的那筆。</p>
<p>接著，我們使用<code>ps aux |grep nginx</code> (我們的環境為ubuntu)，如下：</p>
<p><img src="https://i.imgur.com/p1NSgWQ.png" alt="image-20220215160459890"></p>
<p>在ubuntu 的進程裡，我們會發現 4516 這個id 也就是剛剛在container 裡面找到的master process，也就證明了，container 的確是一個進程。</p>
<h4 id="透過pstree工具來查看進程的依賴關係"><a href="#透過pstree工具來查看進程的依賴關係" class="headerlink" title="透過pstree工具來查看進程的依賴關係"></a>透過pstree工具來查看進程的依賴關係</h4><p>接著，我們使用<code>pstree -halps 4576</code>，如下：</p>
<p><img src="https://i.imgur.com/vCIbls6.png" alt="image-20220215160841953"></p>
<p>我們可以看到進程的依賴關係。其中<code>containerd-shim</code>就是一個創建並啟動nginx的那個進程，後面的id也就是啟動之後的id名稱</p>
<h3 id="container-內部進程跟host進程是對不上的，是怎麼回事？"><a href="#container-內部進程跟host進程是對不上的，是怎麼回事？" class="headerlink" title="container 內部進程跟host進程是對不上的，是怎麼回事？"></a>container 內部進程跟host進程是對不上的，是怎麼回事？</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在container 內的進程id 跟host 的進程id 剛好對上，但其實具體上container 並不是這個id，這個涉及到容器的命名空間原理、隔離等等觀念技術。後續會再講到。</span><br></pre></td></tr></table></figure>



<p><strong>簡單的示例</strong></p>
<p>我們啟動一個有多指令的容器<code>busybox</code>，並利用<code>docker container top dd4</code>查看進程資料。</p>
<p><img src="https://i.imgur.com/H7VV5qA.png" alt="image-20220215162233126"></p>
<p>另外下面這張圖是進入到容器內之後，下了<code>ps</code>指令，我們會發現跟上一張圖片對比的PID 是不一樣的。</p>
<p><img src="https://i.imgur.com/bUZLyjb.png" alt="image-20220215162430641"></p>
<h2 id="docker-container-run-背後發生了什麼？"><a href="#docker-container-run-背後發生了什麼？" class="headerlink" title="docker container run 背後發生了什麼？"></a>docker container run 背後發生了什麼？</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker container run -d --publish 80:80 --name webhost nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d 後台運行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--publish 也就是先前的 -p 80:80</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--name 給這個容器取名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx 後面可以再接執行的腳本名稱，如果沒有下，就會執行預設的腳本，後續會講到。</span></span><br></pre></td></tr></table></figure>





<ul>
<li>在本地查找是否有nginx這個image鏡像，但是沒有發現</li>
<li>去遠程的image registry查找nginx鏡像(預設的registry是docker hub)</li>
<li>下載最新版本的nginx鏡像(nginx:latest 預設)</li>
<li>基於nginx鏡像來創建一個新的容器，並且準備運行</li>
<li>docker enginer 分配給這個容器一個虛擬ip地址</li>
<li>在宿主機上打開80port 並把容器的80port轉發到宿主(host)機上</li>
<li>啟動容器，運行指定的命令(這裡是一個shell腳本去啟動nginx)</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/11/2022-02-11%20%E6%8A%BD%E7%8D%8E%E7%B3%BB%E7%B5%B1%E8%A8%AD%E8%A8%88%E5%88%86%E4%BA%AB%E5%BF%83%E5%BE%97%E7%AD%86%E8%A8%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/11/2022-02-11%20%E6%8A%BD%E7%8D%8E%E7%B3%BB%E7%B5%B1%E8%A8%AD%E8%A8%88%E5%88%86%E4%BA%AB%E5%BF%83%E5%BE%97%E7%AD%86%E8%A8%98/" class="post-title-link" itemprop="url">抽獎系統設計分享心得筆記</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2022-02-11 15:42:00 / 修改時間：16:29:33" itemprop="dateCreated datePublished" datetime="2022-02-11T15:42:00+08:00">2022-02-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B/" itemprop="url" rel="index"><span itemprop="name">系統架構</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>心得來自保哥的youtube影片 &gt;&gt; <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=e3DDXSMWr5w">那些年我們實作過的抽獎系統</a></p>
<h2 id="一、抽獎在業務跟系統扮演什麼角色"><a href="#一、抽獎在業務跟系統扮演什麼角色" class="headerlink" title="一、抽獎在業務跟系統扮演什麼角色"></a>一、抽獎在業務跟系統扮演什麼角色</h2><p>抽獎是一個常見的工具</p>
<p>拉新 dau 日活躍人數 月活躍人數</p>
<p>拉活 有帳號的人，但是太久沒有用</p>
<p>透過活動拉新、拉活。達到預期收益<br>pm、markting人員 模型要確定下來<br>行銷預算 + 函式  &#x3D; 預期收益</p>
<h2 id="二、機率設計"><a href="#二、機率設計" class="headerlink" title="二、機率設計"></a>二、機率設計</h2><h3 id="五個維度"><a href="#五個維度" class="headerlink" title="五個維度"></a>五個維度</h3><h4 id="抽獎活動的週期"><a href="#抽獎活動的週期" class="headerlink" title="抽獎活動的週期"></a>抽獎活動的週期</h4><p>確定、不確定<br>確定的：比如某兩個禮拜。<br>不確定的：比如每消費金額之後，小小抽。</p>
<h4 id="開獎方式"><a href="#開獎方式" class="headerlink" title="開獎方式"></a>開獎方式</h4><p>立即開獎、一段時間開獎<br>立即：馬上知道有沒有中獎</p>
<p>一段時間：一段時間公布，會需要有公證的操作或證人</p>
<h4 id="抽獎人數"><a href="#抽獎人數" class="headerlink" title="抽獎人數"></a>抽獎人數</h4><p>確定、不確定<br>確定：通常來說公司尾牙就是確定人數<br>不確定：街口的雙11活動，參加人就不是確定</p>
<h4 id="抽獎次數"><a href="#抽獎次數" class="headerlink" title="抽獎次數"></a>抽獎次數</h4><p>確定、不確定<br>確定：公司尾牙就是確定的<br>不確定：街口雙11或百貨公司活動就是不確定的。</p>
<h4 id="獎品數量"><a href="#獎品數量" class="headerlink" title="獎品數量"></a>獎品數量</h4><p>確定、不確定<br>確定：ps5 1台，就是確定<br>不確定：ubereats 新人首單 100元，就是不確定的</p>
<h3 id="獎項設計"><a href="#獎項設計" class="headerlink" title="獎項設計"></a>獎項設計</h3><p>0 ~ 0.5 中iphone ，隨機random<br>rand seed 常用 block chain hash</p>
<h4 id="大獎設計"><a href="#大獎設計" class="headerlink" title="大獎設計"></a>大獎設計</h4><p>10 台iphone 在1個禮拜內送完，但需要跟行銷討論想要的效果<br>有可能是每1最多抽到1台，在雙11當天活動高潮 就送5台之類。</p>
<h4 id="小獎設計"><a href="#小獎設計" class="headerlink" title="小獎設計"></a>小獎設計</h4><p>常見作法：機率獎品對照表</p>
<h2 id="三、業務風險的控管及系統的風險控制與注意事項"><a href="#三、業務風險的控管及系統的風險控制與注意事項" class="headerlink" title="三、業務風險的控管及系統的風險控制與注意事項"></a>三、業務風險的控管及系統的風險控制與注意事項</h2><ol>
<li><p>一定要限制抽獎次數 30次，怕有bug，這個次數可以很大，但不能是無限。</p>
</li>
<li><p>獎品送的狀況超出預期，需要有緊急狀況的計劃</p>
</li>
<li><p>限制次數</p>
<ol>
<li>業務層限制次數</li>
<li>在nginx module 限制來自某個ip的流量等等<br>業務層或網管層限制某個用戶id 做限流，防止用戶大量請求。</li>
</ol>
</li>
<li><p>攔截一些無效流量</p>
<p>無效流量的效果大神說很有感</p>
<p>比如momo幣 10點搶，10點01分進來1000個用戶，前面10個做完業務邏輯，後面990個可以都不做一些邏輯判斷，減輕系統的負擔，直接return。</p>
</li>
<li><p>前端的部分</p>
<p>按了請求之後馬上disable按鈕，10秒後再解開之類的</p>
</li>
<li><p>redis使用</p>
<p>如果做一個select update 或一個很大的trasaction 基本上系統就等著掛掉。流量尖鋒的資料庫壓力，超時原因都是各式各樣的資料庫鎖，很大呈度可以減少這個問題。</p>
<p>因此，要搶秒殺或福袋建議大家可以看redis 的<code>lua腳本</code>來實現扣減庫存的方案，把需要資料庫完成的強一致性減庫存操作轉換為redis 的記憶體操作<br>之後再透過某種方式再同步回資料庫，去實際做減庫存的工作。可以非常有效減緩系統壓力。</p>
<p>QPS說明</p>
<p>資料庫：QPS 20 左右<br>redis ：QPS 幾千沒問題</p>
</li>
</ol>
<h2 id="問題時間"><a href="#問題時間" class="headerlink" title="問題時間"></a>問題時間</h2><h3 id="Q1-資訊架構的錢怎麼預估"><a href="#Q1-資訊架構的錢怎麼預估" class="headerlink" title="Q1 資訊架構的錢怎麼預估"></a>Q1 資訊架構的錢怎麼預估</h3><p>可以先探討是在地端還是雲端。(我們電資(電商)不能上雲)</p>
<p>另外就是核心關鍵業務指標來評量，比方說<br>日活躍人數多少?( Daily Active User，DAU )<br>月活躍人數多少?<br>小活動的用戶活動參與度多少?<br>手機的nofication ，用戶點擊會是多少?(街口這項是滿高的)</p>
<p>街口案例(假設)：</p>
<p>假設日活10萬、月活30萬，大型活動 日活 拉到2~3倍。</p>
<p>以雙11為例，11整點 抓30萬 request 流量，鋒直流量可能再用反推maybe可能是需要1000qps</p>
<p>1000qps 再往下分解，可能需要5台、6台機器 可能在nginx 流量截取層需不需要做一些其它節點的配置</p>
<p>雙11時大概20幾分鐘不能work，原因是因為我們的防火牆被打爆了，流量最大，內部系統風平浪靜<br>ap節點 做到 stateless 水平擴容</p>
<h2 id="閒聊"><a href="#閒聊" class="headerlink" title="閒聊"></a>閒聊</h2><h3 id="壓測工具討論"><a href="#壓測工具討論" class="headerlink" title="壓測工具討論"></a>壓測工具討論</h3><ul>
<li>k6 javascript 寫script壓測工具 保哥推薦 ，底層是用go</li>
<li>jmeter</li>
</ul>
<p>壓測有分為單點壓測、情境壓測</p>
<p>cpu 超過90%沒意義，講師想糾正大家對於壓測的觀念，不是說壓測一定要把系統搞到爆才叫壓測。<br>cpu 50%、60% 就已經有點不穩定的感覺。</p>
<p>比如在cpu 20%、30% 使用率，已經有達標需求了，這樣也是壓測的很好結果。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/01/25/2022-01-25%20python%20%E8%99%9B%E6%93%AC%E7%92%B0%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/25/2022-01-25%20python%20%E8%99%9B%E6%93%AC%E7%92%B0%E5%A2%83/" class="post-title-link" itemprop="url">python 虛擬環境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2022-01-25 15:42:00 / 修改時間：16:04:02" itemprop="dateCreated datePublished" datetime="2022-01-25T15:42:00+08:00">2022-01-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>482</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在撰寫相關專案文件的時候，重跑一次專案的安裝流程，覺得很費時…剛好記得之前有看過<code>virtualenv</code>這套處擬環境套件，就來試試看啦~</p>
<h2 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h2><p>ubuntu</p>
<h2 id="第一步，安裝virtualenv"><a href="#第一步，安裝virtualenv" class="headerlink" title="第一步，安裝virtualenv"></a>第一步，安裝virtualenv</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-virtualenv</span><br></pre></td></tr></table></figure>



<h2 id="第二步，創建目錄"><a href="#第二步，創建目錄" class="headerlink" title="第二步，創建目錄"></a>第二步，創建目錄</h2><p>在<code>home/kite/</code> 底下建立 <code>python_workspace</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir python_workspace</span><br></pre></td></tr></table></figure>



<h2 id="第三步，建立虛擬環境"><a href="#第三步，建立虛擬環境" class="headerlink" title="第三步，建立虛擬環境"></a>第三步，建立虛擬環境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m venv ven03</span><br></pre></td></tr></table></figure>

<p>下完指令後，我們會看到生出了<code>venv03</code> 資料夾</p>
<p><img src="https://i.imgur.com/hkR40v7.png" alt="image-20220125155729454"></p>
<h2 id="第四步，進入虛擬環境"><a href="#第四步，進入虛擬環境" class="headerlink" title="第四步，進入虛擬環境"></a>第四步，進入虛擬環境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ./venv03/bin/activate</span><br></pre></td></tr></table></figure>

<p>下完指令後，我們會發現在最前面會多出(venv03) 文字，代表你目前使用的是這個代號的環境底下運行python，當你執行python時，相關路徑都會改指向這個資料夾底下的套件</p>
<p><img src="https://i.imgur.com/0QuClvC.png" alt="image-20220125155951712"></p>
<h2 id="第五步，確認目前的套件環境"><a href="#第五步，確認目前的套件環境" class="headerlink" title="第五步，確認目前的套件環境"></a>第五步，確認目前的套件環境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip list</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/KhqNR9E.png" alt="image-20220125160149542"></p>
<h2 id="如何匯出依賴套件清單"><a href="#如何匯出依賴套件清單" class="headerlink" title="如何匯出依賴套件清單"></a>如何匯出依賴套件清單</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure>



<h2 id="如何匯入依賴套件清單"><a href="#如何匯入依賴套件清單" class="headerlink" title="如何匯入依賴套件清單"></a>如何匯入依賴套件清單</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>



<h2 id="如何退出虛擬環境"><a href="#如何退出虛擬環境" class="headerlink" title="如何退出虛擬環境"></a>如何退出虛擬環境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kite</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">131</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">116</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kite</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="總字數">336k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">10:11</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
