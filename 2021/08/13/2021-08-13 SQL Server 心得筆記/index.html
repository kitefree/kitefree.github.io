<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kitefree.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Function字串相加方法112345678910111213drop function Concat_Name gocreate function Concat_Name(@cs varchar(1000))returns varchar(3000)asbegindeclare   @String varchar(8000)&#x3D;&#x27;&#x27;select @String&#x3D;@String">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server 心得筆記">
<meta property="og:url" content="https://kitefree.github.io/2021/08/13/2021-08-13%20SQL%20Server%20%E5%BF%83%E5%BE%97%E7%AD%86%E8%A8%98/index.html">
<meta property="og:site_name" content="地球人的修練">
<meta property="og:description" content="Function字串相加方法112345678910111213drop function Concat_Name gocreate function Concat_Name(@cs varchar(1000))returns varchar(3000)asbegindeclare   @String varchar(8000)&#x3D;&#x27;&#x27;select @String&#x3D;@String">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/koXqtla.png">
<meta property="og:image" content="https://i.imgur.com/ArX7CDh.png">
<meta property="og:image" content="https://i.imgur.com/Vav8q5R.png">
<meta property="og:image" content="https://i.imgur.com/It9Y6Ec.png">
<meta property="og:image" content="https://i.imgur.com/QPhMd95.png">
<meta property="og:image" content="https://i.imgur.com/7ZvKwVo.png">
<meta property="og:image" content="https://i.imgur.com/ud4j7dU.png">
<meta property="og:image" content="https://i.imgur.com/flMV4Ze.png">
<meta property="og:image" content="https://i.imgur.com/FwDGYTJ.png">
<meta property="og:image" content="https://i.imgur.com/SD2FU05.png">
<meta property="og:image" content="https://i.imgur.com/b6qLKHt.jpg">
<meta property="article:published_time" content="2021-08-13T13:14:00.000Z">
<meta property="article:modified_time" content="2021-09-19T01:19:33.051Z">
<meta property="article:author" content="kite">
<meta property="article:tag" content="SQL SERVER">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/koXqtla.png">

<link rel="canonical" href="https://kitefree.github.io/2021/08/13/2021-08-13%20SQL%20Server%20%E5%BF%83%E5%BE%97%E7%AD%86%E8%A8%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>SQL Server 心得筆記 | 地球人的修練</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球人的修練</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>網站地圖</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2021/08/13/2021-08-13%20SQL%20Server%20%E5%BF%83%E5%BE%97%E7%AD%86%E8%A8%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SQL Server 心得筆記
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2021-08-13 21:14:00" itemprop="dateCreated datePublished" datetime="2021-08-13T21:14:00+08:00">2021-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-09-19 09:19:33" itemprop="dateModified" datetime="2021-09-19T09:19:33+08:00">2021-09-19</time>
              </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>21 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h2><h3 id="字串相加方法1"><a href="#字串相加方法1" class="headerlink" title="字串相加方法1"></a>字串相加方法1</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> Concat_Name </span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> Concat_Name(<span class="variable">@cs</span> <span class="type">varchar</span>(<span class="number">1000</span>))</span><br><span class="line"><span class="keyword">returns</span> <span class="type">varchar</span>(<span class="number">3000</span>)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span>   <span class="variable">@String</span> <span class="type">varchar</span>(<span class="number">8000</span>)<span class="operator">=</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@String</span><span class="operator">=</span><span class="variable">@String</span> <span class="operator">+</span>name <span class="operator">+</span> <span class="string">&#x27;;&#x27;</span>  <span class="keyword">from</span> students <span class="keyword">where</span> class<span class="operator">=</span><span class="variable">@cs</span>	</span><br><span class="line"><span class="keyword">return</span> <span class="variable">@String</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">select</span> dbo.Concat_Name(<span class="string">&#x27;B&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/koXqtla.png" alt="image-20210809170549015"></p>
<p>![image-20210809170602581](E:\kite_project\SQLSERVER\SQL Server.assets\image-20210809170602581-16284999637694.png)</p>
<h3 id="字串相加方法2"><a href="#字串相加方法2" class="headerlink" title="字串相加方法2"></a>字串相加方法2</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> </span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">cast</span>(name <span class="keyword">AS</span> NVARCHAR ) <span class="operator">+</span> <span class="string">&#x27;,&#x27;</span> </span><br><span class="line">    <span class="keyword">from</span> students  	</span><br><span class="line">	<span class="keyword">where</span> class<span class="operator">=</span><span class="string">&#x27;A&#x27;</span>	<span class="comment">--把name一樣的加起來</span></span><br><span class="line">	<span class="keyword">FOR</span> XML PATH(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">) <span class="keyword">as</span> Concat_Name</span><br></pre></td></tr></table></figure>





<h2 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h2><h3 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h3><p>先創建LOG表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">as</span> op,<span class="operator">*</span> <span class="keyword">INTO</span> students_log <span class="keyword">FROM</span> students <span class="keyword">WHERE</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****** Object:  Trigger [dbo].[students_InsertTrigger]    Script Date: 2021/8/9 下午 05:36:40 ******/</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line">GO</span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> [dbo].[students_InsertTrigger] <span class="keyword">ON</span> [dbo].[students]</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">INSERT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@op</span> <span class="type">char</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@create_date</span> datetime;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@id</span> <span class="type">int</span>;	</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@student_name</span> nvarchar(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@age</span> <span class="type">int</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@cs</span> nvarchar(<span class="number">50</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">-- 取出新增紀錄</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">	<span class="variable">@create_date</span><span class="operator">=</span>[create_date],<span class="variable">@id</span><span class="operator">=</span>[id],<span class="variable">@student_name</span><span class="operator">=</span>[student_name],<span class="variable">@age</span><span class="operator">=</span>[age],<span class="variable">@cs</span><span class="operator">=</span>[class]</span><br><span class="line">    <span class="keyword">FROM</span> inserted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 存到 LOG 檔案內</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> [students_log]([op],[create_date],[id],[student_name],[age],[class])</span><br><span class="line">	<span class="keyword">VALUES</span>(<span class="string">&#x27;I&#x27;</span>,<span class="variable">@create_date</span>,<span class="variable">@id</span>,<span class="variable">@student_name</span>,<span class="variable">@age</span>,<span class="variable">@cs</span>);</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>



<p>test insert sql </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">INSERT</span> <span class="keyword">INTO</span> [students]([create_date],[id],[student_name],[age],[class])</span><br><span class="line"><span class="keyword">VALUES</span>(getdate(),<span class="number">15</span>,<span class="string">&#x27;aa&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;C&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> [dbo].[students_UpdateTrigger] <span class="keyword">ON</span> [dbo].[students]</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@op</span> <span class="type">char</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@create_date</span> datetime;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@id</span> <span class="type">int</span>;	</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@student_name</span> nvarchar(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@age</span> <span class="type">int</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> <span class="variable">@cs</span> nvarchar(<span class="number">50</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">-- 修改後</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">	<span class="variable">@create_date</span><span class="operator">=</span>[create_date],<span class="variable">@id</span><span class="operator">=</span>[id],<span class="variable">@student_name</span><span class="operator">=</span>[student_name],<span class="variable">@age</span><span class="operator">=</span>[age],<span class="variable">@cs</span><span class="operator">=</span>[class]</span><br><span class="line">    <span class="keyword">FROM</span> inserted;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 存到 LOG 檔案內</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> [students_log]([op],[create_date],[id],[student_name],[age],[class])</span><br><span class="line">	<span class="keyword">VALUES</span>(<span class="string">&#x27;U&#x27;</span>,<span class="variable">@create_date</span>,<span class="variable">@id</span>,<span class="variable">@student_name</span>,<span class="variable">@age</span>,<span class="variable">@cs</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">--修改前</span></span><br><span class="line">    <span class="keyword">SELECT</span> </span><br><span class="line">	<span class="variable">@create_date</span><span class="operator">=</span>[create_date],<span class="variable">@id</span><span class="operator">=</span>[id],<span class="variable">@student_name</span><span class="operator">=</span>[student_name],<span class="variable">@age</span><span class="operator">=</span>[age],<span class="variable">@cs</span><span class="operator">=</span>[class]</span><br><span class="line">    <span class="keyword">FROM</span> deleted;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 存到 LOG 檔案內</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> [students_log]([op],[create_date],[id],[student_name],[age],[class])</span><br><span class="line">	<span class="keyword">VALUES</span>(<span class="string">&#x27;D&#x27;</span>,<span class="variable">@create_date</span>,<span class="variable">@id</span>,<span class="variable">@student_name</span>,<span class="variable">@age</span>,<span class="variable">@cs</span>);</span><br><span class="line"></span><br><span class="line">GO</span><br></pre></td></tr></table></figure>



<p>test update sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> students <span class="keyword">set</span> student_name <span class="operator">=</span> <span class="string">&#x27;溜爺&#x27;</span> </span><br></pre></td></tr></table></figure>



<p><img src="https://i.imgur.com/ArX7CDh.png" alt="image-20210811105333032"></p>
<h2 id="Store-Procedure"><a href="#Store-Procedure" class="headerlink" title="Store Procedure"></a>Store Procedure</h2><p>優點</p>
<ol>
<li>預存程式可封裝，並隱藏複雜的商業邏輯。增加其隱蔽性, 安全性。</li>
</ol>
<p>可以將資料邏輯和商務規則 (Business Rule) 加以封裝，如此使用者就只能以開發人員和資料庫系統管理員預期的方式來存取資料及物件。</p>
<ol start="2">
<li><p>Stored Procedure 是已經編譯過的, 所以執行效率快</p>
</li>
<li><p>減少程式與資料庫的連結次數</p>
</li>
<li><p>預存程式可以回傳值，並可以接受參數。</p>
</li>
<li><p>預存程式無法使用 SELECT 指令來執行，因為它是子程式，與檢視表，資料表或使用者定義函式不同。</p>
</li>
<li><p>預存程式可以用在資料檢驗，強制實行商業邏輯等。</p>
</li>
<li><p>可以使用會驗證所有使用者輸入的參數化預存程序來防堵 SQL 插入式攻擊(SQL Injection)。 如果有使用動態 SQL，請務必將命令參數化，也絕對不要在查詢字串中直接包含參數值。</p>
</li>
<li><p>可以拒絕臨機操作 (Ad Hoc) 的查詢和資料修改作業。 如此可避免使用者因惡意或不慎而損毀資料，或執行會降低伺服器或網路效能的查詢。</p>
</li>
<li><p>可以處理程序程式碼中的錯誤，而不必將錯誤直接傳遞至用戶端應用程式。 如此可避免傳回可能助長探查攻擊的錯誤訊息。 請在伺服器上記錄及處理錯誤。</p>
</li>
<li><p>預存程序只需寫入一次，即可由許多應用程式存取。</p>
</li>
<li><p>用戶端應用程式不需要對基礎資料結構有任何了解。 您可以對預存程序程式碼進行變更，而不需變更用戶端應用程式，只要這些變更不會影響參數清單或傳回的資料型別即可。</p>
</li>
<li><p>預存程序可以將多項作業結合成單一的程序呼叫，藉此降低網路流量。</p>
</li>
</ol>
<p>缺點</p>
<ol>
<li><p>移植性差。預存程式，往往客製化於特定的資料庫上，因為支援的程式語言不同。當切換到其他廠商的資料庫系統時，需要重寫原有的預存程式。</p>
</li>
<li><p>對Server的負擔較大</p>
</li>
<li><p>預存程式的效能調校與撰寫，受限於各種資料庫系統。</p>
</li>
</ol>
<p><img src="https://i.imgur.com/Vav8q5R.png" alt="img"></p>
<p>假設四個不同應用系統都在Local端 所運行的這區塊程式功能都是做一樣的事情時<br>當一有功能調整<br>此時你會有需要對四個地方去做同樣調整<br>共需要做四次更改</p>
<p>這是違背開發上降低重複動作<br>設計觀念的</p>
<h2 id="常見用法"><a href="#常見用法" class="headerlink" title="常見用法"></a>常見用法</h2><h3 id="暫存表功能"><a href="#暫存表功能" class="headerlink" title="暫存表功能"></a>暫存表功能</h3><p>待寫</p>
<h3 id="查詢"><a href="#查詢" class="headerlink" title="查詢"></a>查詢</h3><h4 id="從子查詢結果寫入新表"><a href="#從子查詢結果寫入新表" class="headerlink" title="從子查詢結果寫入新表"></a>從子查詢結果寫入新表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">INTO</span> KITE </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ITEMS <span class="keyword">WHERE</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="comment">/* condition */</span></span><br><span class="line">) <span class="keyword">AS</span> A </span><br></pre></td></tr></table></figure>

<blockquote>
<p>資料表較大時，可以先取出某一部分進行查詢數據，效能比較快</p>
</blockquote>
<h4 id="以客戶資料為主table，查詢最後一筆交易產品線記錄"><a href="#以客戶資料為主table，查詢最後一筆交易產品線記錄" class="headerlink" title="以客戶資料為主table，查詢最後一筆交易產品線記錄"></a>以客戶資料為主table，查詢最後一筆交易產品線記錄</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> AA001 <span class="keyword">AS</span> 客戶代號</span><br><span class="line">,(<span class="keyword">SELECT</span> TOP <span class="number">1</span> PRODUCT_DATE <span class="keyword">FROM</span> ORDER_BOM <span class="keyword">WHERE</span> OD_AA001<span class="operator">=</span>AA001 <span class="keyword">ORDER</span> <span class="keyword">BY</span> PRODUCT_DATE <span class="keyword">DESC</span>) 最後一次交易日</span><br><span class="line"><span class="keyword">FROM</span> CRMAA</span><br><span class="line"><span class="keyword">WHERE</span> AA013 <span class="keyword">IN</span>(<span class="string">&#x27;台北&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>常見狀況以主表資料為主，再去撈取某一資訊，放在欄位上進行呈現</p>
<p>當然，如果有多個欄位，用一樣的語句結構，再多寫幾行子查詢</p>
</blockquote>
<h4 id="子表完成後，再進行第二次篩選"><a href="#子表完成後，再進行第二次篩選" class="headerlink" title="子表完成後，再進行第二次篩選"></a>子表完成後，再進行第二次篩選</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> A.<span class="operator">*</span></span><br><span class="line">,HC050 訂單合約起日,HC051  訂單合約迄日</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> AA001 <span class="keyword">AS</span> 客戶代號,AA002 <span class="keyword">AS</span> 客戶名稱,OD004 <span class="keyword">AS</span> 出貨日期,OD005 <span class="keyword">AS</span> 出貨單號</span><br><span class="line">    <span class="keyword">FROM</span> ORDER_BOM</span><br><span class="line">    <span class="keyword">JOIN</span> CRMAA <span class="keyword">ON</span> AA001<span class="operator">=</span>OD_AA001</span><br><span class="line">    <span class="keyword">WHERE</span> </span><br><span class="line">    <span class="number">1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> OD_AA001</span><br><span class="line">) <span class="keyword">AS</span> A </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> CRMHC <span class="keyword">ON</span> HC002 <span class="operator">=</span> REPLACE(出貨單號,<span class="string">&#x27;DS2-&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 出貨日期,客戶代號</span><br></pre></td></tr></table></figure>

<blockquote>
<p>縮限資料後，再進行第二次的篩選</p>
</blockquote>
<h4 id="子表完成後，進行第三次篩選"><a href="#子表完成後，進行第三次篩選" class="headerlink" title="子表完成後，進行第三次篩選"></a>子表完成後，進行第三次篩選</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> AR001,AR002,AR003,AR004,PE2.PE02,PE2.PE03,PE2.PE04 <span class="keyword">FROM</span> </span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> SERAR_KITE2</span><br><span class="line">	<span class="keyword">WHERE</span> RTRIM(AR001)<span class="operator">+</span>RTRIM(AR002)<span class="operator">+</span>RTRIM(AR003)<span class="operator">+</span>RTRIM(AR004) </span><br><span class="line">	<span class="keyword">IN</span></span><br><span class="line">	(</span><br><span class="line">	<span class="keyword">SELECT</span> RTRIM(AR001)<span class="operator">+</span>RTRIM(AR002)<span class="operator">+</span>RTRIM(AR003)<span class="operator">+</span>RTRIM(AR004) </span><br><span class="line">	<span class="keyword">FROM</span> SERAR_KITE2</span><br><span class="line">	<span class="keyword">GROUP</span>  <span class="keyword">BY</span> AR001,AR002,AR003,AR004 <span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(PE02) <span class="operator">&gt;</span><span class="number">1</span></span><br><span class="line">	) </span><br><span class="line">) <span class="keyword">AS</span> AR</span><br><span class="line"><span class="keyword">JOIN</span> DSCPE PE2 <span class="keyword">ON</span> AR.PE02<span class="operator">=</span>PE2.PE02 <span class="keyword">collate</span> database_default</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> AR001,AR002,AR003,AR004</span><br></pre></td></tr></table></figure>

<blockquote>
<p>同樣概念也可以包N層</p>
</blockquote>
<h4 id="縱向轉直向"><a href="#縱向轉直向" class="headerlink" title="縱向轉直向"></a>縱向轉直向</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">CASE</span> class <span class="keyword">WHEN</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">THEN</span> class <span class="keyword">END</span>) <span class="keyword">as</span> A_CLASS_CNT</span><br><span class="line">,<span class="built_in">COUNT</span>(<span class="keyword">CASE</span> class <span class="keyword">WHEN</span> <span class="string">&#x27;b&#x27;</span> <span class="keyword">THEN</span> class <span class="keyword">END</span>) <span class="keyword">as</span> B_CLASS_CNT</span><br><span class="line"><span class="keyword">FROM</span> students </span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/It9Y6Ec.png" alt="image-20210809163459420"></p>
<p><img src="https://i.imgur.com/QPhMd95.png" alt="image-20210809163528735"></p>
<blockquote>
<p>同一個表統計時，如果有COUNT需求，要轉向，是可以這樣寫的</p>
</blockquote>
<h4 id="相乘"><a href="#相乘" class="headerlink" title="相乘"></a>相乘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> student_name,subject_name </span><br><span class="line"><span class="keyword">FROM</span> students,subjects</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> student_name,subject_name</span><br></pre></td></tr></table></figure>



<p><img src="https://i.imgur.com/7ZvKwVo.png" alt="image-20210809171947986"></p>
<p><img src="https://i.imgur.com/ud4j7dU.png" alt="image-20210809172246152"></p>
<blockquote>
<p>自行想像需求</p>
</blockquote>
<h3 id="修改-1"><a href="#修改-1" class="headerlink" title="修改"></a>修改</h3><h4 id="參考table更新至目的table"><a href="#參考table更新至目的table" class="headerlink" title="參考table更新至目的table"></a>參考table更新至目的table</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> AR1 <span class="keyword">SET</span> AR1.AR005<span class="operator">=</span> AR2.PE02</span><br><span class="line"><span class="comment">--SELECT AR1.AR005,AR2.PE02</span></span><br><span class="line"><span class="keyword">FROM</span> SERAR_KITE AR1 <span class="keyword">JOIN</span> SERAR_KITE2 AR2 <span class="keyword">ON</span> AR1.AR001<span class="operator">=</span> AR2.AR001 <span class="keyword">AND</span> AR1.AR002<span class="operator">=</span>AR2.AR002 <span class="keyword">AND</span> AR1.AR003<span class="operator">=</span>AR2.AR003 <span class="keyword">AND</span> AR1.AR004<span class="operator">=</span>AR2.AR004</span><br><span class="line"><span class="keyword">WHERE</span> AR1.AR005 <span class="operator">!=</span>AR2.PE02</span><br></pre></td></tr></table></figure>



<h3 id="新增-1"><a href="#新增-1" class="headerlink" title="新增"></a>新增</h3><h4 id="批次新增資料，參考既有table，更新目的table"><a href="#批次新增資料，參考既有table，更新目的table" class="headerlink" title="批次新增資料，參考既有table，更新目的table"></a>批次新增資料，參考既有table，更新目的table</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--一般業務</span></span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@JOB_ID</span> <span class="keyword">AS</span> <span class="type">VARCHAR</span>(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@UID</span> <span class="keyword">AS</span> <span class="type">VARCHAR</span>(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@JOB_ID</span><span class="operator">=</span><span class="string">&#x27;001&#x27;</span> <span class="comment">--一般業務</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@UID</span><span class="operator">=</span><span class="string">&#x27;02944&#x27;</span>  <span class="comment">-- 參考工號</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ADMML (ML001,ML002,ML003,ML004,ML005,ML006,ML007,ML008,ML009,ML010)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> <span class="variable">@JOB_ID</span> <span class="keyword">AS</span> ML001,MG002 <span class="keyword">AS</span> ML002, MG003 <span class="keyword">AS</span> ML003,MG004 <span class="keyword">AS</span> ML004,MG005 <span class="keyword">AS</span> ML005,MG006 <span class="keyword">AS</span> ML006,MG007 <span class="keyword">AS</span> ML007,<span class="string">&#x27;&#x27;</span> <span class="keyword">AS</span> ML008,MG009 <span class="keyword">AS</span> ML009,MG010 <span class="keyword">AS</span> ML010</span><br><span class="line"><span class="keyword">FROM</span> ADMMG_ACP <span class="keyword">WHERE</span> MG001<span class="operator">=</span><span class="variable">@UID</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> MG002</span><br></pre></td></tr></table></figure>

<blockquote>
<p>批次新增資料，再利用參數方式去當條件</p>
</blockquote>
<h4 id="批次新增資眼，excel-來源匯入，更新目的table"><a href="#批次新增資眼，excel-來源匯入，更新目的table" class="headerlink" title="批次新增資眼，excel 來源匯入，更新目的table"></a>批次新增資眼，excel 來源匯入，更新目的table</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> CRMHG(HG001,HG005,HG002,HG032,HG033,HG024,HG021,HG007,HG010,HG012,HG026,HG008,HG011)</span><br><span class="line"><span class="keyword">SELECT</span> 客戶代號,姓名,<span class="string">&#x27;8888&#x27;</span>,職稱,職能別,郵區,公司地址,電話<span class="number">1</span>,電話<span class="number">1</span>_分機,行動電話,行動電話<span class="number">2</span>,電話<span class="number">2</span>,電話<span class="number">2</span>_分機</span><br><span class="line"><span class="keyword">FROM</span> [dbo].[工作表_kite] </span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">是否匯入<span class="operator">=</span><span class="string">&#x27;Y&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> (客戶代號 <span class="keyword">collate</span> database_default <span class="operator">+</span> 姓名 <span class="keyword">collate</span> database_default) <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> HG001<span class="operator">+</span>HG005 <span class="keyword">FROM</span> CRMHG)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>匯入EXCEL到SQLSERVER之後，要注意的是<code>定序</code>問題 </p>
</blockquote>
<h3 id="日期格式轉換"><a href="#日期格式轉換" class="headerlink" title="日期格式轉換"></a>日期格式轉換</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CONVERT</span>(<span class="type">VARCHAR</span>(<span class="number">12</span>),CRMCC.CREATE_DATE,<span class="number">112</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>常見YYYYMMDD格式</p>
</blockquote>
<h3 id="跨DB連線"><a href="#跨DB連線" class="headerlink" title="跨DB連線"></a>跨DB連線</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> OPENDATASOURCE(<span class="string">&#x27;SQLOLEDB&#x27;</span>,<span class="string">&#x27;Data Source = 10.40.40.232;User ID= xx; Password = xxx&#x27;</span>). db.table</span><br></pre></td></tr></table></figure>

<p>Link Server </p>
<p>待寫</p>
<h3 id="字元說明"><a href="#字元說明" class="headerlink" title="字元說明"></a>字元說明</h3><p>char(13) &#x3D; Enter</p>
<p>char(10) &#x3D; 折行</p>
<p>char(32) &#x3D; 空格</p>
<p>char(255) &#x3D; null</p>
<h2 id="維運相關"><a href="#維運相關" class="headerlink" title="維運相關"></a>維運相關</h2><p>sp_lock</p>
<p>sp_who</p>
<p>sp_who2</p>
<h3 id="效能語法"><a href="#效能語法" class="headerlink" title="效能語法"></a>效能語法</h3><h4 id="SQL-SERVER-2000"><a href="#SQL-SERVER-2000" class="headerlink" title="SQL SERVER 2000"></a>SQL SERVER 2000</h4><h5 id="列出最初導致一連串其它處理序被鎖住的起始源頭"><a href="#列出最初導致一連串其它處理序被鎖住的起始源頭" class="headerlink" title="列出最初導致一連串其它處理序被鎖住的起始源頭"></a>列出最初導致一連串其它處理序被鎖住的起始源頭</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">IF <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> master.dbo.sysprocesses <span class="keyword">WHERE</span> spid <span class="keyword">in</span> (<span class="keyword">SELECT</span> blocked <span class="keyword">FROM</span> master.dbo.sysprocesses))</span><br><span class="line"> <span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">SELECT</span> spid 處理序, status 狀態</span><br><span class="line">  , 登入帳號<span class="operator">=</span><span class="built_in">SUBSTRING</span>(SUSER_SNAME(sid), <span class="number">1</span>, <span class="number">30</span>)</span><br><span class="line">  , 使用者機器名稱<span class="operator">=</span><span class="built_in">SUBSTRING</span>(hostname, <span class="number">1</span>, <span class="number">12</span>)</span><br><span class="line">  , 是否鎖住<span class="operator">=</span><span class="keyword">CONVERT</span>(<span class="type">char</span>(<span class="number">3</span>), blocked)</span><br><span class="line">  , 資料庫名稱<span class="operator">=</span><span class="built_in">SUBSTRING</span>(DB_NAME(dbid), <span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  , cmd 命令, waittype 等待類型</span><br><span class="line">  <span class="keyword">FROM</span> master.dbo.sysprocesses</span><br><span class="line">  <span class="comment">--找出鎖住別(自己未被鎖住(blocked=0) 但在別的處理序中blocked欄位出現的值)</span></span><br><span class="line">  <span class="keyword">WHERE</span> spid <span class="keyword">IN</span> (<span class="keyword">SELECT</span> blocked <span class="keyword">FROM</span> master.dbo.sysprocesses)</span><br><span class="line">  <span class="keyword">AND</span> blocked <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line"> <span class="keyword">BEGIN</span></span><br><span class="line">   <span class="keyword">SELECT</span> <span class="string">&#x27;沒有處理序被鎖住&#x27;</span></span><br><span class="line"> <span class="keyword">END</span></span><br></pre></td></tr></table></figure>



<h4 id="SQL-SERVER-2008"><a href="#SQL-SERVER-2008" class="headerlink" title="SQL SERVER 2008"></a>SQL SERVER 2008</h4><h5 id="找出最耗用IO的語法"><a href="#找出最耗用IO的語法" class="headerlink" title="找出最耗用IO的語法"></a>找出最耗用IO的語法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="number">10</span></span><br><span class="line">total_logical_reads,</span><br><span class="line">total_logical_writes,</span><br><span class="line">execution_count,</span><br><span class="line">total_logical_reads<span class="operator">+</span>total_logical_writes <span class="keyword">AS</span> [IO_total],</span><br><span class="line">st.text <span class="keyword">AS</span> query_text,</span><br><span class="line">db_name(st.dbid) <span class="keyword">AS</span> database_name,</span><br><span class="line">st.objectid <span class="keyword">AS</span> object_id</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_query_stats qs</span><br><span class="line"><span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text(sql_handle) st</span><br><span class="line"><span class="keyword">WHERE</span> total_logical_reads<span class="operator">+</span>total_logical_writes<span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> [IO_total] <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>



<h5 id="列出目前最耗用CPU的前50個查詢"><a href="#列出目前最耗用CPU的前50個查詢" class="headerlink" title="列出目前最耗用CPU的前50個查詢"></a>列出目前最耗用CPU的前50個查詢</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  TOP <span class="number">50</span></span><br><span class="line">qs.total_worker_time <span class="operator">/</span> qs.execution_count <span class="keyword">AS</span>[Avg CPU <span class="type">Time</span>],</span><br><span class="line"><span class="built_in">SUBSTRING</span>(qt.text, qs.statement_start_offset <span class="operator">/</span> <span class="number">2</span>,</span><br><span class="line">(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> qs.statement_end_offset <span class="operator">=</span> <span class="number">-1</span> <span class="keyword">THEN</span> len(<span class="keyword">CONVERT</span> (NVARCHAR (MAX), qt.text)) <span class="operator">*</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">ELSE</span> qs.statement_end_offset <span class="keyword">END</span> <span class="operator">-</span> qs.statement_start_offset) <span class="operator">/</span> <span class="number">2</span>) <span class="keyword">AS</span> query_text,</span><br><span class="line">qt.dbid,</span><br><span class="line">qt.objectid</span><br><span class="line"><span class="keyword">FROM</span>     sys.dm_exec_query_stats <span class="keyword">AS</span> qs</span><br><span class="line"><span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text (qs.sql_handle) <span class="keyword">AS</span> qt</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> [Avg CPU <span class="type">Time</span>] <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>



<h5 id="列出目前最耗用Worker-Time的前50個查詢"><a href="#列出目前最耗用Worker-Time的前50個查詢" class="headerlink" title="列出目前最耗用Worker Time的前50個查詢"></a>列出目前最耗用Worker Time的前50個查詢</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   TOP <span class="number">50</span> <span class="built_in">sum</span>(qs.total_worker_time) <span class="keyword">AS</span> total_cpu_time,</span><br><span class="line"><span class="built_in">sum</span>(qs.execution_count) <span class="keyword">AS</span> total_execution_count,</span><br><span class="line"><span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> <span class="string">&#x27;#_statements&#x27;</span>,</span><br><span class="line">qt.dbid,</span><br><span class="line">qt.objectid,</span><br><span class="line">qs.sql_handle,</span><br><span class="line">qt.[text]</span><br><span class="line"><span class="keyword">FROM</span>     sys.dm_exec_query_stats <span class="keyword">AS</span> qs</span><br><span class="line"><span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text (qs.sql_handle) <span class="keyword">AS</span> qt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> qt.dbid, qt.objectid, qs.sql_handle, qt.[text]</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">sum</span>(qs.total_worker_time) <span class="keyword">DESC</span>, qs.sql_handle;</span><br></pre></td></tr></table></figure>



<h5 id="取得-SQL-Server-資料庫正在執行的-T-SQL-指令與詳細資訊"><a href="#取得-SQL-Server-資料庫正在執行的-T-SQL-指令與詳細資訊" class="headerlink" title="取得 SQL Server 資料庫正在執行的 T-SQL 指令與詳細資訊"></a>取得 SQL Server 資料庫正在執行的 T-SQL 指令與詳細資訊</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>      r.scheduler_id <span class="keyword">as</span> 排程器識別碼,</span><br><span class="line">            status         <span class="keyword">as</span> 要求的狀態,</span><br><span class="line">            r.session_id   <span class="keyword">as</span> SPID,</span><br><span class="line">            r.blocking_session_id <span class="keyword">as</span> BlkBy,</span><br><span class="line">            <span class="built_in">substring</span>(</span><br><span class="line">				ltrim(q.text),</span><br><span class="line">				r.statement_start_offset<span class="operator">/</span><span class="number">2</span><span class="operator">+</span><span class="number">1</span>,</span><br><span class="line">				(<span class="keyword">CASE</span></span><br><span class="line">                 <span class="keyword">WHEN</span> r.statement_end_offset <span class="operator">=</span> <span class="number">-1</span></span><br><span class="line">                 <span class="keyword">THEN</span> LEN(<span class="keyword">CONVERT</span>(nvarchar(MAX), q.text)) <span class="operator">*</span> <span class="number">2</span></span><br><span class="line">                 <span class="keyword">ELSE</span> r.statement_end_offset</span><br><span class="line">                 <span class="keyword">END</span> <span class="operator">-</span> r.statement_start_offset)<span class="operator">/</span><span class="number">2</span>)</span><br><span class="line">                 <span class="keyword">AS</span> [正在執行的 T<span class="operator">-</span><span class="keyword">SQL</span> 命令],</span><br><span class="line">            r.cpu_time      <span class="keyword">as</span> [CPU <span class="type">Time</span>(ms)],</span><br><span class="line">            r.start_time    <span class="keyword">as</span> [開始時間],</span><br><span class="line">            r.total_elapsed_time <span class="keyword">as</span> [執行總時間],</span><br><span class="line">            r.reads              <span class="keyword">as</span> [讀取數],</span><br><span class="line">            r.writes             <span class="keyword">as</span> [寫入數],</span><br><span class="line">            r.logical_reads      <span class="keyword">as</span> [邏輯讀取數],</span><br><span class="line">            <span class="comment">-- q.text, /* 完整的 T-SQL 指令碼 */</span></span><br><span class="line">            d.name               <span class="keyword">as</span> [資料庫名稱]</span><br><span class="line"><span class="keyword">FROM</span>        sys.dm_exec_requests r </span><br><span class="line">			<span class="keyword">CROSS</span> APPLY sys.dm_exec_sql_text(sql_handle) <span class="keyword">AS</span> q</span><br><span class="line">			<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.databases d <span class="keyword">ON</span> (r.database_id<span class="operator">=</span>d.database_id)</span><br><span class="line"><span class="keyword">WHERE</span>       r.session_id <span class="operator">&gt;</span> <span class="number">50</span> <span class="keyword">AND</span> r.session_id <span class="operator">&lt;&gt;</span> @<span class="variable">@SPID</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>    r.total_elapsed_time <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>



<h5 id="找出來因為封鎖-Blocked-Lock-造成的等待時間、被封鎖的連線等等之相關資訊。"><a href="#找出來因為封鎖-Blocked-Lock-造成的等待時間、被封鎖的連線等等之相關資訊。" class="headerlink" title="找出來因為封鎖(Blocked Lock)造成的等待時間、被封鎖的連線等等之相關資訊。"></a>找出來因為封鎖(Blocked Lock)造成的等待時間、被封鎖的連線等等之相關資訊。</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> session_id N<span class="string">&#x27;工作階段識別碼&#x27;</span>,status N<span class="string">&#x27;要求的狀態&#x27;</span>,</span><br><span class="line">command N<span class="string">&#x27;目前所處理命令的類型&#x27;</span>,blocking_session_id N<span class="string">&#x27;封鎖要求之工作階段的識別碼&#x27;</span> ,</span><br><span class="line">wait_type N<span class="string">&#x27;被封鎖的等候類型&#x27;</span>,wait_time N<span class="string">&#x27;等候的持續時間&#x27;</span>,</span><br><span class="line">wait_resource N<span class="string">&#x27;目前等候的資源&#x27;</span>,transaction_id N<span class="string">&#x27;要求執行所在交易的識別碼&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_requests</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>



<h3 id="踢掉所有用戶"><a href="#踢掉所有用戶" class="headerlink" title="踢掉所有用戶"></a>踢掉所有用戶</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use master</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE YourDatabase <span class="keyword">SET</span> SINGLE_USER <span class="keyword">WITH</span> <span class="keyword">ROLLBACK</span> IMMEDIATE </span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE YourDatabase <span class="keyword">SET</span> MULTI_USER</span><br></pre></td></tr></table></figure>



<h3 id="清LOG"><a href="#清LOG" class="headerlink" title="清LOG"></a>清LOG</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BACKUP LOG DSC_CRM_SP <span class="keyword">WITH</span> TRUNCATE_ONLY</span><br><span class="line">DBCC SHRINKFILE (<span class="string">&#x27;DSC_CRM_SP_Log&#x27;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">DBCC SHRINKFILE (<span class="string">&#x27;DSC_CRM_SP_Log&#x27;</span> ,<span class="number">0</span>,TRUNCATEONLY) </span><br><span class="line"></span><br><span class="line">USE DSC_CRM_TEST</span><br><span class="line">CHECKPOINT</span><br><span class="line">DBCC SHRINKFILE(<span class="number">2</span>, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">BACKUP LOG [DSC_CRM_TEST] <span class="keyword">WITH</span> TRUNCATE_ONLY;</span><br><span class="line">DBCC SHRINKFILE ([DSC_CRM_TEST_Log],<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE DSC_CRM_SP <span class="keyword">SET</span> RECOVERY SIMPLE <span class="keyword">WITH</span> NO_WAIT</span><br><span class="line">DBCC SHRINKFILE(DSC_CRM_SP_Log, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE DSC_CRM_SP <span class="keyword">SET</span> RECOVERY <span class="keyword">FULL</span> <span class="keyword">WITH</span> NO_WAIT</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">BACKUP LOG [Quiz] <span class="keyword">WITH</span> TRUNCATE_ONLY;</span><br><span class="line">DBCC SHRINKFILE ([Quiz_Log],<span class="number">500</span>);</span><br></pre></td></tr></table></figure>





<h3 id="查詢table使用空間"><a href="#查詢table使用空間" class="headerlink" title="查詢table使用空間"></a>查詢table使用空間</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">--http://msdn.microsoft.com/zh-tw/library/ms188414.aspx</span></span><br><span class="line"><span class="comment">--更新目前資料庫中之所有物件的頁面及 (或) 資料列計數</span></span><br><span class="line">DBCC UPDATEUSAGE(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">-- DB size.</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_spaceused</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Table row counts and sizes.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> #t </span><br><span class="line">( </span><br><span class="line">    [name] NVARCHAR(<span class="number">128</span>),</span><br><span class="line">    [<span class="keyword">rows</span>] <span class="type">CHAR</span>(<span class="number">11</span>),</span><br><span class="line">    reserved <span class="type">VARCHAR</span>(<span class="number">18</span>), </span><br><span class="line">    data <span class="type">VARCHAR</span>(<span class="number">18</span>), </span><br><span class="line">    index_size <span class="type">VARCHAR</span>(<span class="number">18</span>),</span><br><span class="line">    unused <span class="type">VARCHAR</span>(<span class="number">18</span>)</span><br><span class="line">) </span><br><span class="line"> </span><br><span class="line"><span class="comment">--把每個Table使用的資訊存到#t之中</span></span><br><span class="line"><span class="keyword">INSERT</span> #t <span class="keyword">EXEC</span> sys.sp_MSforeachtable <span class="string">&#x27;EXEC sp_spaceused &#x27;&#x27;?&#x27;&#x27;&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">--依使用空間較大的依序排列並顯示MB</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">, LTRIM(STR(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(reserved,LEN(reserved)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>)) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> reservedSize_M</span><br><span class="line">, LTRIM(STR(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(data,LEN(data)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>)) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> dataSize_M</span><br><span class="line">, LTRIM(STR(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(index_size,LEN(index_size)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>)) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> indexSize_M</span><br><span class="line"><span class="keyword">FROM</span> #t</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(data,LEN(data)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>)) <span class="keyword">DESC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 顯示總共筆數及總共使用資訊</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(<span class="built_in">CAST</span>([<span class="keyword">rows</span>] <span class="keyword">AS</span> <span class="type">int</span>)) <span class="keyword">AS</span> [<span class="keyword">rows</span>]</span><br><span class="line">, LTRIM(STR(<span class="built_in">SUM</span>(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(reserved,LEN(reserved)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>))) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> sumOfreservedSize_M</span><br><span class="line">, LTRIM(STR(<span class="built_in">SUM</span>(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(data,LEN(data)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>))) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> sumOfdataSize_M</span><br><span class="line">, LTRIM(STR(<span class="built_in">SUM</span>(<span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(index_size,LEN(index_size)<span class="number">-3</span>) <span class="keyword">AS</span> <span class="type">NUMERIC</span>(<span class="number">18</span>,<span class="number">0</span>))) <span class="operator">/</span> <span class="number">1024</span>, <span class="number">18</span>)) <span class="operator">+</span> <span class="string">&#x27;MB&#x27;</span> <span class="keyword">AS</span> sumOfindexSize_M</span><br><span class="line"><span class="keyword">FROM</span> #t</span><br><span class="line"> </span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> #t </span><br></pre></td></tr></table></figure>





<h2 id="複寫機制"><a href="#複寫機制" class="headerlink" title="複寫機制"></a>複寫機制</h2><h2 id="SQL-Profile"><a href="#SQL-Profile" class="headerlink" title="SQL Profile"></a>SQL Profile</h2><h2 id="效能ISSUE"><a href="#效能ISSUE" class="headerlink" title="效能ISSUE"></a>效能ISSUE</h2><h2 id="資料庫維護計劃"><a href="#資料庫維護計劃" class="headerlink" title="資料庫維護計劃"></a>資料庫維護計劃</h2><h2 id="SSDT"><a href="#SSDT" class="headerlink" title="SSDT"></a>SSDT</h2><h2 id="ETL"><a href="#ETL" class="headerlink" title="ETL"></a>ETL</h2><p><img src="https://i.imgur.com/flMV4Ze.png" alt="img"></p>
<p>ETL 真的沒啥好介紹的，概念真的太簡單好懂。</p>
<ul>
<li>Extract: 把資料從某個地方拿出來。</li>
<li>Transform: 將資料作轉換。</li>
<li>Load: 湊數的一步，把轉換完的資料丟到某個地方。</li>
</ul>
<p>ETL 之所以必要在於，原始資料通常不適合拿來直接使用的。原因在於：</p>
<ul>
<li>原始資料量太大：通常前端在收資料的時候，都會使用比較鬆散的事件格式，像是 JSON，也通常不會做壓縮。這樣在計算時需要消耗較多的資源，也會影響計算速度。所以通常在使用之前會做最基本的壓縮和格式最佳化。</li>
<li>資料不乾淨：通常資料前端收進來的時候，如果沒有處理好，會遇到很多奇怪的狀況，「Garbage in、garbase out」所以確保資料的品質非常重要。比較基本的像是格式、數值範圍，更複雜的一點包括欄位統計值甚至邏輯等等。</li>
<li>比較複雜的 Aggregation：資料是隨著事件進來，但是使用上可能會以每小時、每天為單位來進行分析或計算。如果每次畫報表都必須從最原始的資料開始算，會消耗大量計算資源，而且 SQL 或計算也會非常複雜，所以一般來說都會先將原始資料聚合成一些時間粒度稍微「粗」一點的資料，才會來做後續應用。</li>
</ul>
<p>以下從網路上找幾個應用範例：</p>
<h3 id="標準的清理資料流程"><a href="#標準的清理資料流程" class="headerlink" title="標準的清理資料流程"></a>標準的清理資料流程</h3><p><img src="https://i.imgur.com/FwDGYTJ.png" alt="img"></p>
<p>一般來說，資料在進入 Data Warehouse 前，都必須經過這幾個階段，才能供後續業務報表或是視覺化使用。算是基本起手式吧。</p>
<h3 id="在不同層（Layer）的資料之間作轉換"><a href="#在不同層（Layer）的資料之間作轉換" class="headerlink" title="在不同層（Layer）的資料之間作轉換"></a>在不同層（Layer）的資料之間作轉換</h3><p><img src="https://i.imgur.com/SD2FU05.png" alt="img"></p>
<p>資料傳送到後端後，會經過 ETL 放到 Staging 環境、再透過 ETL 放到 DW、再透過 ETL 整理到了 Data Mart 給 End User 使用。當原始資料越複雜、資料量越多，中間就更需要多層次的處理來確保資料品質以及使用上的效能。</p>
<h3 id="Streaming-ETL"><a href="#Streaming-ETL" class="headerlink" title="Streaming ETL"></a>Streaming ETL</h3><p><img src="https://i.imgur.com/b6qLKHt.jpg" alt="img"></p>
<p>當然除了 Batch ETL 外，Streaming ETL 也是有的。可以根據事件、或是 mini batch 的方式來處理原始資料，配合 Batch Process 來處理累積的資料。</p>
<p>總之 ETL 是個很廣泛的領域，不僅僅是「資料處理」四個字而已。還需要考量到軟硬體架構、商務邏輯、後續的使用才能設計最適合的 ETL 流程。</p>
<h2 id="參考連結"><a href="#參考連結" class="headerlink" title="參考連結"></a>參考連結</h2><p><a target="_blank" rel="noopener" href="https://medium.com/bryanyang0528/data-data-pipeline-101-%E4%BA%8C-stage-%E5%92%8C-job-287d0e9be9f2?source=your_stories_page---------------------------">Data Data Pipeline 101（三）—ETL</a></p>
<p><a target="_blank" rel="noopener" href="https://dotblogs.com.tw/mis2000lab/2014/06/12/sql-server-trigger">SQL ServerTrigger的簡單範例，以「訂單的流程系統」為例</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SQL-SERVER/" rel="tag"># SQL SERVER</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/13/2021-08-13%20Phaser%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E6%95%B4%E7%90%86/" rel="prev" title="Phaser 使用技巧整理">
      <i class="fa fa-chevron-left"></i> Phaser 使用技巧整理
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/17/2021-09-19%20PIXI%20JS%20%E8%B6%85%E4%BA%BA%E9%96%80%E5%AD%B8%E7%BF%92/" rel="next" title="PIXI JS 超人門學習">
      PIXI JS 超人門學習 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Function"><span class="nav-number">1.</span> <span class="nav-text">Function</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E4%B8%B2%E7%9B%B8%E5%8A%A0%E6%96%B9%E6%B3%951"><span class="nav-number">1.1.</span> <span class="nav-text">字串相加方法1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E4%B8%B2%E7%9B%B8%E5%8A%A0%E6%96%B9%E6%B3%952"><span class="nav-number">1.2.</span> <span class="nav-text">字串相加方法2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trigger"><span class="nav-number">2.</span> <span class="nav-text">Trigger</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E"><span class="nav-number">2.1.</span> <span class="nav-text">新增</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9"><span class="nav-number">2.2.</span> <span class="nav-text">修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Store-Procedure"><span class="nav-number">3.</span> <span class="nav-text">Store Procedure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A6%8B%E7%94%A8%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">常見用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9A%AB%E5%AD%98%E8%A1%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">4.1.</span> <span class="nav-text">暫存表功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%A9%A2"><span class="nav-number">4.2.</span> <span class="nav-text">查詢</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%9E%E5%AD%90%E6%9F%A5%E8%A9%A2%E7%B5%90%E6%9E%9C%E5%AF%AB%E5%85%A5%E6%96%B0%E8%A1%A8"><span class="nav-number">4.2.1.</span> <span class="nav-text">從子查詢結果寫入新表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A5%E5%AE%A2%E6%88%B6%E8%B3%87%E6%96%99%E7%82%BA%E4%B8%BBtable%EF%BC%8C%E6%9F%A5%E8%A9%A2%E6%9C%80%E5%BE%8C%E4%B8%80%E7%AD%86%E4%BA%A4%E6%98%93%E7%94%A2%E5%93%81%E7%B7%9A%E8%A8%98%E9%8C%84"><span class="nav-number">4.2.2.</span> <span class="nav-text">以客戶資料為主table，查詢最後一筆交易產品線記錄</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%90%E8%A1%A8%E5%AE%8C%E6%88%90%E5%BE%8C%EF%BC%8C%E5%86%8D%E9%80%B2%E8%A1%8C%E7%AC%AC%E4%BA%8C%E6%AC%A1%E7%AF%A9%E9%81%B8"><span class="nav-number">4.2.3.</span> <span class="nav-text">子表完成後，再進行第二次篩選</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%90%E8%A1%A8%E5%AE%8C%E6%88%90%E5%BE%8C%EF%BC%8C%E9%80%B2%E8%A1%8C%E7%AC%AC%E4%B8%89%E6%AC%A1%E7%AF%A9%E9%81%B8"><span class="nav-number">4.2.4.</span> <span class="nav-text">子表完成後，進行第三次篩選</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B8%B1%E5%90%91%E8%BD%89%E7%9B%B4%E5%90%91"><span class="nav-number">4.2.5.</span> <span class="nav-text">縱向轉直向</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E4%B9%98"><span class="nav-number">4.2.6.</span> <span class="nav-text">相乘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-1"><span class="nav-number">4.3.</span> <span class="nav-text">修改</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%83%E8%80%83table%E6%9B%B4%E6%96%B0%E8%87%B3%E7%9B%AE%E7%9A%84table"><span class="nav-number">4.3.1.</span> <span class="nav-text">參考table更新至目的table</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-1"><span class="nav-number">4.4.</span> <span class="nav-text">新增</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E6%AC%A1%E6%96%B0%E5%A2%9E%E8%B3%87%E6%96%99%EF%BC%8C%E5%8F%83%E8%80%83%E6%97%A2%E6%9C%89table%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%9B%AE%E7%9A%84table"><span class="nav-number">4.4.1.</span> <span class="nav-text">批次新增資料，參考既有table，更新目的table</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E6%AC%A1%E6%96%B0%E5%A2%9E%E8%B3%87%E7%9C%BC%EF%BC%8Cexcel-%E4%BE%86%E6%BA%90%E5%8C%AF%E5%85%A5%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%9B%AE%E7%9A%84table"><span class="nav-number">4.4.2.</span> <span class="nav-text">批次新增資眼，excel 來源匯入，更新目的table</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E8%BD%89%E6%8F%9B"><span class="nav-number">4.5.</span> <span class="nav-text">日期格式轉換</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8DB%E9%80%A3%E7%B7%9A"><span class="nav-number">4.6.</span> <span class="nav-text">跨DB連線</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E5%85%83%E8%AA%AA%E6%98%8E"><span class="nav-number">4.7.</span> <span class="nav-text">字元說明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B6%AD%E9%81%8B%E7%9B%B8%E9%97%9C"><span class="nav-number">5.</span> <span class="nav-text">維運相關</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%88%E8%83%BD%E8%AA%9E%E6%B3%95"><span class="nav-number">5.1.</span> <span class="nav-text">效能語法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-SERVER-2000"><span class="nav-number">5.1.1.</span> <span class="nav-text">SQL SERVER 2000</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%9C%80%E5%88%9D%E5%B0%8E%E8%87%B4%E4%B8%80%E9%80%A3%E4%B8%B2%E5%85%B6%E5%AE%83%E8%99%95%E7%90%86%E5%BA%8F%E8%A2%AB%E9%8E%96%E4%BD%8F%E7%9A%84%E8%B5%B7%E5%A7%8B%E6%BA%90%E9%A0%AD"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">列出最初導致一連串其它處理序被鎖住的起始源頭</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-SERVER-2008"><span class="nav-number">5.1.2.</span> <span class="nav-text">SQL SERVER 2008</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%BE%E5%87%BA%E6%9C%80%E8%80%97%E7%94%A8IO%E7%9A%84%E8%AA%9E%E6%B3%95"><span class="nav-number">5.1.2.1.</span> <span class="nav-text">找出最耗用IO的語法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E7%9B%AE%E5%89%8D%E6%9C%80%E8%80%97%E7%94%A8CPU%E7%9A%84%E5%89%8D50%E5%80%8B%E6%9F%A5%E8%A9%A2"><span class="nav-number">5.1.2.2.</span> <span class="nav-text">列出目前最耗用CPU的前50個查詢</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E7%9B%AE%E5%89%8D%E6%9C%80%E8%80%97%E7%94%A8Worker-Time%E7%9A%84%E5%89%8D50%E5%80%8B%E6%9F%A5%E8%A9%A2"><span class="nav-number">5.1.2.3.</span> <span class="nav-text">列出目前最耗用Worker Time的前50個查詢</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%96%E5%BE%97-SQL-Server-%E8%B3%87%E6%96%99%E5%BA%AB%E6%AD%A3%E5%9C%A8%E5%9F%B7%E8%A1%8C%E7%9A%84-T-SQL-%E6%8C%87%E4%BB%A4%E8%88%87%E8%A9%B3%E7%B4%B0%E8%B3%87%E8%A8%8A"><span class="nav-number">5.1.2.4.</span> <span class="nav-text">取得 SQL Server 資料庫正在執行的 T-SQL 指令與詳細資訊</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%BE%E5%87%BA%E4%BE%86%E5%9B%A0%E7%82%BA%E5%B0%81%E9%8E%96-Blocked-Lock-%E9%80%A0%E6%88%90%E7%9A%84%E7%AD%89%E5%BE%85%E6%99%82%E9%96%93%E3%80%81%E8%A2%AB%E5%B0%81%E9%8E%96%E7%9A%84%E9%80%A3%E7%B7%9A%E7%AD%89%E7%AD%89%E4%B9%8B%E7%9B%B8%E9%97%9C%E8%B3%87%E8%A8%8A%E3%80%82"><span class="nav-number">5.1.2.5.</span> <span class="nav-text">找出來因為封鎖(Blocked Lock)造成的等待時間、被封鎖的連線等等之相關資訊。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B8%A2%E6%8E%89%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B6"><span class="nav-number">5.2.</span> <span class="nav-text">踢掉所有用戶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85LOG"><span class="nav-number">5.3.</span> <span class="nav-text">清LOG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%A9%A2table%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%96%93"><span class="nav-number">5.4.</span> <span class="nav-text">查詢table使用空間</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A4%87%E5%AF%AB%E6%A9%9F%E5%88%B6"><span class="nav-number">6.</span> <span class="nav-text">複寫機制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL-Profile"><span class="nav-number">7.</span> <span class="nav-text">SQL Profile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E8%83%BDISSUE"><span class="nav-number">8.</span> <span class="nav-text">效能ISSUE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B3%87%E6%96%99%E5%BA%AB%E7%B6%AD%E8%AD%B7%E8%A8%88%E5%8A%83"><span class="nav-number">9.</span> <span class="nav-text">資料庫維護計劃</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SSDT"><span class="nav-number">10.</span> <span class="nav-text">SSDT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ETL"><span class="nav-number">11.</span> <span class="nav-text">ETL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%99%E6%BA%96%E7%9A%84%E6%B8%85%E7%90%86%E8%B3%87%E6%96%99%E6%B5%81%E7%A8%8B"><span class="nav-number">11.1.</span> <span class="nav-text">標準的清理資料流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%B1%A4%EF%BC%88Layer%EF%BC%89%E7%9A%84%E8%B3%87%E6%96%99%E4%B9%8B%E9%96%93%E4%BD%9C%E8%BD%89%E6%8F%9B"><span class="nav-number">11.2.</span> <span class="nav-text">在不同層（Layer）的資料之間作轉換</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Streaming-ETL"><span class="nav-number">11.3.</span> <span class="nav-text">Streaming ETL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E9%80%A3%E7%B5%90"><span class="nav-number">12.</span> <span class="nav-text">參考連結</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kite</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">131</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kite</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="總字數">354k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">10:44</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
