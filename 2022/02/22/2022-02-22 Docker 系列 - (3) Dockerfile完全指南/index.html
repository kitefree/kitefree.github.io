<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kitefree.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="如何選擇基礎鏡像(FROM)基本原則 官方鏡像優非官方的鏡像，如果沒有官方鏡像，則儘量選擇Dockerfile開源的 固定版本tag而不是每次都使用latest 儘量選擇體積小的鏡像  準備一個index.html文件 1&lt;h1&gt;Hello Docker&lt;&#x2F;h1&gt;  準備一個Dockerfile文件 12FROM nginx:1.21.0-alpineADD index.h">
<meta property="og:type" content="article">
<meta property="og:title" content="docker 系列 - (3) Dockerfile完全指南">
<meta property="og:url" content="https://kitefree.github.io/2022/02/22/2022-02-22%20Docker%20%E7%B3%BB%E5%88%97%20-%20(3)%20Dockerfile%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="地球人的修練">
<meta property="og:description" content="如何選擇基礎鏡像(FROM)基本原則 官方鏡像優非官方的鏡像，如果沒有官方鏡像，則儘量選擇Dockerfile開源的 固定版本tag而不是每次都使用latest 儘量選擇體積小的鏡像  準備一個index.html文件 1&lt;h1&gt;Hello Docker&lt;&#x2F;h1&gt;  準備一個Dockerfile文件 12FROM nginx:1.21.0-alpineADD index.h">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/9zhQmDo.png">
<meta property="og:image" content="https://i.imgur.com/Aet8fLy.png">
<meta property="og:image" content="https://i.imgur.com/c1DIgDo.png">
<meta property="og:image" content="https://i.imgur.com/8InDVzo.png">
<meta property="article:published_time" content="2022-02-22T09:14:00.000Z">
<meta property="article:modified_time" content="2022-02-23T01:06:50.339Z">
<meta property="article:author" content="kite">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/9zhQmDo.png">

<link rel="canonical" href="https://kitefree.github.io/2022/02/22/2022-02-22%20Docker%20%E7%B3%BB%E5%88%97%20-%20(3)%20Dockerfile%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>docker 系列 - (3) Dockerfile完全指南 | 地球人的修練</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球人的修練</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>網站地圖</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://kitefree.github.io/2022/02/22/2022-02-22%20Docker%20%E7%B3%BB%E5%88%97%20-%20(3)%20Dockerfile%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="kite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球人的修練">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          docker 系列 - (3) Dockerfile完全指南
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-02-22 17:14:00" itemprop="dateCreated datePublished" datetime="2022-02-22T17:14:00+08:00">2022-02-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-02-23 09:06:50" itemprop="dateModified" datetime="2022-02-23T09:06:50+08:00">2022-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>37 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="如何選擇基礎鏡像-FROM"><a href="#如何選擇基礎鏡像-FROM" class="headerlink" title="如何選擇基礎鏡像(FROM)"></a>如何選擇基礎鏡像(FROM)</h2><h3 id="基本原則"><a href="#基本原則" class="headerlink" title="基本原則"></a>基本原則</h3><ul>
<li>官方鏡像優非官方的鏡像，如果沒有官方鏡像，則儘量選擇Dockerfile開源的</li>
<li>固定版本tag而不是每次都使用latest</li>
<li>儘量選擇體積小的鏡像</li>
</ul>
<p>準備一個<code>index.html</code>文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Docker<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>準備一個<code>Dockerfile</code>文件</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.21</span>.<span class="number">0</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> index.html /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker image ls</span><br><span class="line">REPOSITORY      TAG             IMAGE ID       CREATED          SIZE</span><br><span class="line">bitnami/nginx   1.18.0          dfe237636dde   28 minutes ago   89.3MB</span><br><span class="line">nginx           1.21.0-alpine   a6eb2a334a9f   2 days ago       22.6MB</span><br><span class="line">nginx           1.21.0          d1a364dc548d   2 days ago       133MB</span><br></pre></td></tr></table></figure>

<p><code>alpine</code> 這個版本是一個非常輕量的linux 系統，在nginx、python都會看得到這樣的組合</p>
<p><img src="https://i.imgur.com/9zhQmDo.png" alt="image-20220218151904995"></p>
<blockquote>
<p>A minimal Docker image based on Alpine Linux with a complete package index and only 5 MB in size!</p>
</blockquote>
<p><img src="https://i.imgur.com/Aet8fLy.png" alt="image-20220218152341367"></p>
<h2 id="通過RUN執行指令"><a href="#通過RUN執行指令" class="headerlink" title="通過RUN執行指令"></a>通過RUN執行指令</h2><p><code>RUN</code> 主要用於在image裡執行指令，比如安裝軟體、下載文件…等。</p>
<p>如果是了6個<code>RUN</code>就會建立出6個分層，通常不會這樣寫，而且體積也會比較大。</p>
<p>原指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get update</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get install wget</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>


<h3 id="Dockerfile-bad"><a href="#Dockerfile-bad" class="headerlink" title="Dockerfile.bad"></a>Dockerfile.bad</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<p>鏡像的大小和分層</p>
<p>我們可以看到下面的history 多了好多個RUN ，每一個RUN都有佔幾個MB</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立鏡像檔 -f 參數可以指定dockerfile檔案</span></span><br><span class="line">docker image build -f Dockerfile.bad -t ipinfo-bad . </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">ls</span></span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">ipinfo       latest    97bb429363fb   4 minutes ago   138MB</span><br><span class="line">ubuntu       21.04     478aa0080b60   4 days ago      74.1MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">history</span> 97b</span></span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">97bb429363fb   4 minutes ago   RUN /bin/sh -c rm -rf ipinfo_2.0.1_linux_amd…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c mv ipinfo_2.0.1_linux_amd64 /…   9.36MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c tar zxf ipinfo_2.0.1_linux_am…   9.36MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c wget https://github.com/ipinf…   4.85MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c apt-get install -y wget # bui…   7.58MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c apt-get update # buildkit        33MB      buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo &#x27;do…   7B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c set -xe   &amp;&amp; echo &#x27;#!/bin/sh&#x27; &gt; /…   811B</span><br><span class="line">&lt;missing&gt;      4 days ago      /bin/sh -c #(nop) ADD file:d6b6ba642344138dc…   74.1MB</span><br></pre></td></tr></table></figure>



<h3 id="Dockerfile-good"><a href="#Dockerfile-good" class="headerlink" title="Dockerfile.good"></a>Dockerfile.good</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y wget &amp;&amp; \</span><br><span class="line">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span><br><span class="line">    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>



<p>我們可以看到下面的結果，只有一筆RUN的分層</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">ls</span></span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">ipinfo-new   latest    fe551bc26b92   5 seconds ago    124MB</span><br><span class="line">ipinfo       latest    97bb429363fb   16 minutes ago   138MB</span><br><span class="line">ubuntu       21.04     478aa0080b60   4 days ago       74.1MB</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker image <span class="built_in">history</span> fe5</span></span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">fe551bc26b92   16 seconds ago   RUN /bin/sh -c apt-get update &amp;&amp;     apt-get…   49.9MB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo &#x27;do…   7B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c set -xe   &amp;&amp; echo &#x27;#!/bin/sh&#x27; &gt; /…   811B</span><br><span class="line">&lt;missing&gt;      4 days ago       /bin/sh -c #(nop) ADD file:d6b6ba642344138dc…   74.1MB</span><br></pre></td></tr></table></figure>





<h2 id="文件複製和目錄操作-ADD-COPY-WORKDIR"><a href="#文件複製和目錄操作-ADD-COPY-WORKDIR" class="headerlink" title="文件複製和目錄操作(ADD,COPY,WORKDIR)"></a>文件複製和目錄操作(ADD,COPY,WORKDIR)</h2><p>往鏡像裡複製文件有兩種方式<code>COPY</code>、<code>ADD</code>。</p>
<h3 id="複製普通文件"><a href="#複製普通文件" class="headerlink" title="複製普通文件"></a>複製普通文件</h3><p><code>COPY</code>和<code>ADD</code>都可以把local的一個文件複製到鏡像裡，如果目標目錄不存在，則會自動建立</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">COPY hello.py /app/hello.py</span><br></pre></td></tr></table></figure>

<p>比如把本地的hello.py複製到&#x2F;app 目錄下，但app目錄不存在，所以會自動建立</p>
<h3 id="複製壓縮文件"><a href="#複製壓縮文件" class="headerlink" title="複製壓縮文件"></a>複製壓縮文件</h3><p><code>ADD</code>比較不一樣的地方是，如果複製的是一個gzip等壓縮文件時，<code>ADD</code>會幫助我們自動去解壓縮文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">ADD hello.tar.gz /app/</span><br></pre></td></tr></table></figure>

<h3 id="如何選擇"><a href="#如何選擇" class="headerlink" title="如何選擇"></a>如何選擇</h3><p>所有文件複製可以均使用<code>COPY</code>指令，僅在需要自動解壓縮的場合使用<code>ADD</code></p>
<h3 id="實驗記錄-COPY"><a href="#實驗記錄-COPY" class="headerlink" title="實驗記錄 COPY"></a>實驗記錄 COPY</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立tmp資料夾</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# mkdir tmp</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# cd tmp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建a文件</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# touch a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建b文件</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# touch b</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder/tmp# cd ..</span><br></pre></td></tr></table></figure>

<p>修改<code>Dockerfile</code>檔案內容如下</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>.<span class="number">5</span>-alpine3.<span class="number">13</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> tmp/ /app/tmp/</span></span><br></pre></td></tr></table></figure>



<p>執行build動作，並進入到container查看是否有複製完整資料夾至<code>/app/tmp/</code>底下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打包成docker image</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker build -t docker-copy .</span><br><span class="line">Sending build context to Docker daemon  878.1kB</span><br><span class="line">Step 1/2 : FROM python:3.9.5-alpine3.13</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">46a196bf50ae</span></span><br><span class="line">Step 2/2 : COPY tmp/ /app/tmp/</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">54edba980fe5</span></span><br><span class="line">Successfully built 54edba980fe5</span><br><span class="line">Successfully tagged docker-copy:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行容器 並進入交互模式 結束後直接刪除container</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm docker-copy sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切換目錄至tmp底下</span></span><br><span class="line">/ # cd app/tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看資料夾，的確有a、b兩個檔案，代表有複製到整個資料夾到container內部</span></span><br><span class="line">/app/tmp # ls</span><br><span class="line">a  b</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">離開container</span></span><br><span class="line">/app/tmp # exit</span><br></pre></td></tr></table></figure>



<h3 id="實驗記錄-ADD"><a href="#實驗記錄-ADD" class="headerlink" title="實驗記錄 ADD"></a>實驗記錄 ADD</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行tar指令壓縮資料夾</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# tar cvf copy.tar tmp</span><br><span class="line">tmp/</span><br><span class="line">tmp/b</span><br><span class="line">tmp/a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看清單</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# ls</span><br><span class="line">copy.tar  Dockerfile  hello  hello.c  hello.py  tmp</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerIm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先移除上一個剛產生的image</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image rm docker-copy</span><br><span class="line">Untagged: docker-copy:latest</span><br><span class="line">Deleted: sha256:54edba980fe511c2cfce44ce4e7615fd47171deea2a8cd668404b6f59545405c</span><br><span class="line">Deleted: sha256:6cff68147576a72f2121ea1da50b33ccc8328fc11683b668564baed2c3b7dbc6</span><br></pre></td></tr></table></figure>



<p>修改<code>Dockerfile</code>檔案內容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-alpine3.13</span><br><span class="line">ADD copy.tar /app/</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再進行構建</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker build -t docker-copy .</span><br><span class="line">Sending build context to Docker daemon  888.8kB</span><br><span class="line">Step 1/2 : FROM python:3.9.5-alpine3.13</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">46a196bf50ae</span></span><br><span class="line">Step 2/2 : ADD copy.tar /app/</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">9f31129139ea</span></span><br><span class="line">Successfully built 9f31129139ea</span><br><span class="line">Successfully tagged docker-copy:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">運行容器並進入交互模式</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm docker-copy sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">移動到tmp資料夾</span></span><br><span class="line">/ # cd app/tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看清單，果然有自動unzip資料夾</span></span><br><span class="line">/app/tmp # ls</span><br><span class="line">a  b</span><br></pre></td></tr></table></figure>





<h2 id="構建參數和環境變數-ARG-VS-ENV"><a href="#構建參數和環境變數-ARG-VS-ENV" class="headerlink" title="構建參數和環境變數(ARG VS ENV)"></a>構建參數和環境變數(ARG VS ENV)</h2><p><code>ARG</code>和<code>ENV</code>是經常容易被混淆的兩個Dockerfile的語法，都可以用來設置一個”變數”。但實際上兩者有很多的不同。</p>
<p>比方說有一個腳本</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_2.0.1_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<h3 id="使用ENV"><a href="#使用ENV" class="headerlink" title="使用ENV"></a>使用ENV</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="使用ARG"><a href="#使用ARG" class="headerlink" title="使用ARG"></a>使用ARG</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ARG</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="區別"><a href="#區別" class="headerlink" title="區別"></a>區別</h3><p><img src="https://i.imgur.com/c1DIgDo.png" alt="docker-image"></p>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h4><ul>
<li><p>ARG的生命週期在build 鏡像的過程</p>
</li>
<li><p>run container 內並不會有這組變數名稱可以使用</p>
</li>
<li><p>可以藉由build 指令去指定賦與值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -f .\Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg VERSION=2.0.0 .</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><ul>
<li>ENV的生命週期包含在build鏡像與run container 之後，變數仍存在。</li>
</ul>
<h2 id="CMD容器啟動命令"><a href="#CMD容器啟動命令" class="headerlink" title="CMD容器啟動命令"></a>CMD容器啟動命令</h2><p>CMD可以用來設置容器啟動時預設會執行的命令。</p>
<p>我們的dockerfile檔如下</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br></pre></td></tr></table></figure>



<p>進行鏡像構建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -f dockerfile-ipinfo -t ipinfo .</span><br></pre></td></tr></table></figure>



<h3 id="容器啟動時預設執行的命令"><a href="#容器啟動時預設執行的命令" class="headerlink" title="容器啟動時預設執行的命令"></a>容器啟動時預設執行的命令</h3><p>啟動一個<code>ipinfo container</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">啟動一個新容器</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker container run -it ipinfo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自動進入到容器內部了</span></span><br><span class="line">root@ecfe534f0f60:/# ls</span><br></pre></td></tr></table></figure>

<p>我們發現我們沒有在ipinfo 後面下command 為什麼會自動進入到shell模式呢？我們使用<code>docker image history ipinfo</code> 看一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看ipinfo</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker image history ipinfo</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">f68f17d7369f   27 minutes ago   /bin/sh -c apt-get update &amp;&amp;     apt-get ins…   47MB      </span><br><span class="line">53a4d53f91b3   29 minutes ago   /bin/sh -c #(nop)  ENV VERSION=2.0.1            0B        </span><br><span class="line">7cc39f89fa58   2 weeks ago      /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago      /bin/sh -c #(nop) ADD file:4cb90f4b06e581fee…   80MB   </span><br></pre></td></tr></table></figure>

<p>發現docker 的基礎鏡像中有<code>CMD[&quot;bash&quot;]</code>，所以就會變成預設是在這個模式下。</p>
<h3 id="如果docker-container-run啟動容器時指定了其它命令，則CMD命令會被忽略。"><a href="#如果docker-container-run啟動容器時指定了其它命令，則CMD命令會被忽略。" class="headerlink" title="如果docker container run啟動容器時指定了其它命令，則CMD命令會被忽略。"></a>如果docker container run啟動容器時指定了其它命令，則CMD命令會被忽略。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it --rm ipinfo ipinfo 8.8.8.8</span><br><span class="line">Core</span><br><span class="line">- IP           8.8.8.8</span><br><span class="line">- Anycast      true</span><br><span class="line">- Hostname     dns.google</span><br><span class="line">- City         Mountain View</span><br><span class="line">- Region       California</span><br><span class="line">- Country      United States (US)</span><br><span class="line">- Location     37.4056,-122.0775</span><br><span class="line">- Organization AS15169 Google LLC</span><br><span class="line">- Postal       94043</span><br><span class="line">- Timezone     America/Los_Angeles</span><br></pre></td></tr></table></figure>



<h3 id="如果定義了多個CMD-只有最後一個會被執行。"><a href="#如果定義了多個CMD-只有最後一個會被執行。" class="headerlink" title="如果定義了多個CMD,只有最後一個會被執行。"></a>如果定義了多個CMD,只有最後一個會被執行。</h3><p>以下腳本為例，參考了ubuntu的鏡像，ubuntu本身內部就有使用其它CMD，這時我們如果在最後多加了一個CMD的指令。那優先權最大就會變成</p>
<p><code>CMD [&quot;ipinfo&quot;]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">ENV VERSION=2.0.1</span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y wget &amp;&amp; \</span><br><span class="line">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-$&#123;VERSION&#125;/ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz &amp;&amp; \</span><br><span class="line">    mv ipinfo_$&#123;VERSION&#125;_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span><br><span class="line">    rm -rf ipinfo_$&#123;VERSION&#125;_linux_amd64.tar.gz</span><br><span class="line">CMD [&quot;ipinfo&quot;]</span><br></pre></td></tr></table></figure>


<p>迅速清理那些已經停止的container </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -f</span><br></pre></td></tr></table></figure>

<p>遽速清理沒有使用的image</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune -a</span><br></pre></td></tr></table></figure>

<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">2.0</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y wget &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="variable">$&#123;VERSION&#125;</span>/ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar zxf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf ipinfo_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> []</span></span><br></pre></td></tr></table></figure>

<p>把<code>CMD[]</code>設為空之後，再重新build一個新的鏡像，這樣子在輸入<code>docker run --it ipinfo</code> 時，就不會通過，要求使用者一定要在後面再接一個參數，比如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建容器，出現錯誤提示</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it ipinfo </span><br><span class="line">docker: Error response from daemon: No command specified.</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">帶參數</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/genDockerImagesFolder# docker run -it ipinfo ipinfo 8.8.8.8</span><br><span class="line">Core</span><br><span class="line">- IP           8.8.8.8</span><br><span class="line">- Anycast      true</span><br><span class="line">- Hostname     dns.google</span><br><span class="line">- City         Mountain View</span><br><span class="line">- Region       California</span><br><span class="line">- Country      United States (US)</span><br><span class="line">- Location     37.4056,-122.0775</span><br><span class="line">- Organization AS15169 Google LLC</span><br><span class="line">- Postal       94043</span><br><span class="line">- Timezone     America/Los_Angeles</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="容器啟動命令ENTRYPOINT"><a href="#容器啟動命令ENTRYPOINT" class="headerlink" title="容器啟動命令ENTRYPOINT"></a>容器啟動命令ENTRYPOINT</h2><p>ENTRYPOINT也可以設置容器啟動時要執行的命令，但是和CMD是有區別的。</p>
<ul>
<li><code>CMD</code>設置的命令，可以在docker container run 時傳入其它命令，覆蓋掉<code>CMD</code>的命令，但是<code>ENTRYPOINT</code>所設置的命令是<strong>一定會被執行</strong>的。</li>
<li><code>ENTRYPOINT</code>和<code>CMD</code>可以聯合使用，<code>ENTRYPOINT</code>設置執行的命令，CMD傳遞參數</li>
</ul>
<h2 id="SHELL格式和EXEC格式"><a href="#SHELL格式和EXEC格式" class="headerlink" title="SHELL格式和EXEC格式"></a>SHELL格式和EXEC格式</h2><p><code>CMD</code>和<code>ENTRYPOINT</code>同時支持SHELL格式和EXEC格式。</p>
<h3 id="shell格式"><a href="#shell格式" class="headerlink" title="shell格式"></a>shell格式</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="exec格式"><a href="#exec格式" class="headerlink" title="exec格式"></a>exec格式</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<h3 id="注意事項舉例"><a href="#注意事項舉例" class="headerlink" title="注意事項舉例"></a>注意事項舉例</h3><p>比方說要print 出<strong>hello docker</strong></p>
<p>shell版本</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> NAME=docker</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello <span class="variable">$NAME</span>&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>我們試著改成exec格式，如下面這樣，其實是不行的喔。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">21.04</span></span><br><span class="line"><span class="keyword">ENV</span> NAME=docker</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello <span class="variable">$NAME</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>具體方式要以shell腳本的方式去執行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:21.04</span><br><span class="line">ENV NAME=docker</span><br><span class="line">CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;echo hello $NAME&quot;]</span><br></pre></td></tr></table></figure>



<h2 id="一起構建一個python-Flask鏡像"><a href="#一起構建一個python-Flask鏡像" class="headerlink" title="一起構建一個python Flask鏡像"></a>一起構建一個python Flask鏡像</h2><h3 id="環境準備"><a href="#環境準備" class="headerlink" title="環境準備"></a>環境準備</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個資料夾名稱為pythonworkspace</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop$ mkdir pythonworkspace</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入pythonworkspace資料夾</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop$ cd pythonworkspace/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安裝python3-virtualenv套件</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ sudo apt install python3-virtualenv</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">python3-virtualenv is already the newest version (20.0.17-1ubuntu0.4).</span><br><span class="line">The following packages were automatically installed and are no longer required:</span><br><span class="line">  libc++1 libc++1-10 libc++abi1-10 libsss-nss-idmap0</span><br><span class="line">Use &#x27;sudo apt autoremove&#x27; to remove them.</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 36 not upgraded.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立一個獨立空間的python環境，名稱為flaskwebsite</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ python3 -m venv flaskwebsite</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行進入到flaskwebsite空間</span></span><br><span class="line">kite@kite-virtual-machine:~/Desktop/pythonworkspace$ source ./flaskwebsite/bin/activate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">發現前面就會帶(flaskwebsite)空間名稱囉，再用pip list看目前套件清單</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip list</span><br><span class="line">Package       Version</span><br><span class="line">------------- -------</span><br><span class="line">pip           20.0.2 </span><br><span class="line">pkg-resources 0.0.0  </span><br><span class="line">setuptools    44.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安裝flask套件</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip install Flask</span><br><span class="line"></span><br><span class="line">Collecting Flask</span><br><span class="line">  Downloading Flask-2.0.3-py3-none-any.whl (95 kB)</span><br><span class="line">     |████████████████████████████████| 95 kB 393 kB/s </span><br><span class="line">Collecting Jinja2&gt;=3.0</span><br><span class="line">  Downloading Jinja2-3.0.3-py3-none-any.whl (133 kB)</span><br><span class="line">     |████████████████████████████████| 133 kB 1.2 MB/s </span><br><span class="line">Collecting Werkzeug&gt;=2.0</span><br><span class="line">  Downloading Werkzeug-2.0.3-py3-none-any.whl (289 kB)</span><br><span class="line">     |████████████████████████████████| 289 kB 2.6 MB/s </span><br><span class="line">Collecting itsdangerous&gt;=2.0</span><br><span class="line">  Downloading itsdangerous-2.1.0-py3-none-any.whl (15 kB)</span><br><span class="line">Collecting click&gt;=7.1.2</span><br><span class="line">  Downloading click-8.0.4-py3-none-any.whl (97 kB)</span><br><span class="line">     |████████████████████████████████| 97 kB 3.4 MB/s </span><br><span class="line">Collecting MarkupSafe&gt;=2.0</span><br><span class="line">  Downloading MarkupSafe-2.1.0-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (25 kB)</span><br><span class="line">Installing collected packages: MarkupSafe, Jinja2, Werkzeug, itsdangerous, click, Flask</span><br><span class="line">Successfully installed Flask-2.0.3 Jinja2-3.0.3 MarkupSafe-2.1.0 Werkzeug-2.0.3 click-8.0.4 itsdangerous-2.1.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次確認套件清單</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ pip list</span><br><span class="line">Package       Version</span><br><span class="line">------------- -------</span><br><span class="line">click         8.0.4  </span><br><span class="line">Flask         2.0.3  </span><br><span class="line">itsdangerous  2.1.0  </span><br><span class="line">Jinja2        3.0.3  </span><br><span class="line">MarkupSafe    2.1.0  </span><br><span class="line">pip           20.0.2 </span><br><span class="line">pkg-resources 0.0.0  </span><br><span class="line">setuptools    44.0.0 </span><br><span class="line">Werkzeug      2.0.3  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行vscode 打開當前目錄</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$code . </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定環境變數，這步驟設定後，之後下flask run 會自動找這個設定值的內容</span></span><br><span class="line">(flaskwebsite) kite@kite-virtual-machine:~/Desktop/pythonworkspace$ export FLASK_APP=app.py</span><br></pre></td></tr></table></figure>



<h3 id="腳本與程式碼"><a href="#腳本與程式碼" class="headerlink" title="腳本與程式碼"></a>腳本與程式碼</h3><p>網站程式碼：<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>鏡像構建腳本：<code>Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="comment">#將本機檔 app.py copy到image內部指定路徑</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行安裝flask套件指令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定預設工作目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定image內部環境變數</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#對外公開5000 port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行網站啟動指令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>透過dockerhub官網去尋找python的docker image檔，這次特別找輕量的python，可以在tag頁籤底下查詢<code>slim</code>關鍵字。</p>
<p><img src="https://i.imgur.com/8InDVzo.png" alt="image-20220222111053601"></p>
<h2 id="合理使用緩存技巧"><a href="#合理使用緩存技巧" class="headerlink" title="合理使用緩存技巧"></a>合理使用緩存技巧</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line">FROM python:slim</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">將本機檔 app.py copy到image內部指定路徑 &lt;&lt; 我原本在這個位置，程式異動後重build，後面的步驟都會重新再來，不會找緩存</span></span><br><span class="line">COPY app.py /src/app.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行安裝flask套件指令</span></span><br><span class="line">RUN pip install flask</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定預設工作目錄</span></span><br><span class="line">WORKDIR /src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">設定image內部環境變數</span></span><br><span class="line">ENV FLASK=app.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">對外公開5000 port</span></span><br><span class="line">EXPOSE 5000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">執行網站啟動指令</span></span><br><span class="line">CMD [&quot;flask&quot;,&quot;run&quot;,&quot;-h&quot;,&quot;0.0.0.0&quot;]</span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#參考 python tag 為 slim 版的輕量 image</span></span><br><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="comment">#執行安裝flask套件指令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定預設工作目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#設定image內部環境變數</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#將本機檔 app.py copy到image內部指定路徑  &lt;&lt; 我換到這個位置，程式異後動後重build。前面那些指令就會預設去找緩存的資料囉</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#對外公開5000 port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行網站啟動指令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>在固定且不經常變動的指令放到最前面，常會變的比如<code>app.py</code>檔案的程式碼更新。就儘量放到最後面。</p>
<p>這樣在build的過程中，就可以使用到緩存的機制。</p>
<h2 id="dockerignore"><a href="#dockerignore" class="headerlink" title="dockerignore"></a>dockerignore</h2><p>我們可以透過<code>tree -L 1</code>來看一下結構目錄</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# tree -L 1</span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── flaskwebsite</span><br><span class="line">└── __pycache__</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我們發現其實<code>flaskwebsite資料夾</code>也包含在內，因此，指令<code>docker image build -t flask-demo .</code> 中的點也就是指當前路徑。</p>
<p>我們可以觀查在<code>Sending build context to Docker damon 11.12MB</code>這行顯示需要傳輸到<code>11.12MB</code>，但實際上我們的<code>app.py</code>程式碼才幾kb而已。原因就是因為包含了<code>flaskwebsite資料夾</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -t flask-demo .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon  11.12MB</span><br><span class="line">Step 1/7 : FROM python:slim</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">e4f3ae64bf20</span></span><br><span class="line">Step 2/7 : RUN pip install flask</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 2ad3e866c913</span></span><br></pre></td></tr></table></figure>

<p>我們來試著進行資料夾的排除，跟<code>.giteignore</code>概念一樣</p>
<p><code>.dockerignore</code>檔案</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./flaskwebsite</span><br></pre></td></tr></table></figure>

<p>這個檔案我們寫了一行<code>./flaskwebsite</code>，也就是請在build過程中忽略<code>flaskwebsite</code>資料夾。</p>
<p>資料結構加了一個檔案後如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# tree -L 1 -a</span><br><span class="line">.</span><br><span class="line">├── app.py</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── .dockerignore</span><br><span class="line">├── flaskwebsite</span><br><span class="line">└── __pycache__</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>我們再重build一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -t flask-demo .</span><br><span class="line">Sending build context to Docker daemon  5.632kB</span><br></pre></td></tr></table></figure>

<p>就發現變成5.632kb囉</p>
<h2 id="dockerfile技術之多段構建"><a href="#dockerfile技術之多段構建" class="headerlink" title="dockerfile技術之多段構建"></a>dockerfile技術之多段構建</h2><p>有時候我們只需要一個可編譯的系統環境，也不必在host主機上安裝完整的編譯環境。就可以透過docker的環境來幫我們做到這件事情。但我們會發現可編譯程式的gcc鏡像檔(以編譯c語言為例)，容量是很擁腫的，有<code>1.44GB</code>以上。</p>
<p>查看鏡像大容量，<code>gcc</code>為<code>1.14GB</code>、 <code>hello-apline</code>為<code>6.55MB</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# docker images</span><br><span class="line">REPOSITORY       TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">hello-apline     latest    aed1c277cad0   About a minute ago   6.55MB</span><br><span class="line">gcc              9.4       426442df2c0a   3 weeks ago          1.14GB</span><br><span class="line">alpine           3.13.5    6dbb9cc54074   10 months ago        5.61MB</span><br></pre></td></tr></table></figure>

<p>我們可以透過多段構建技巧，分段完成每一階段的任務。再最後階段再使用可執行c語言的鏡像檔幫我們build出小體積的鏡像檔。以下以這個為想法進行實驗與說明：</p>
<p>資料夾結構</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# tree</span><br><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── hello.c</span><br></pre></td></tr></table></figure>

<p><code>hello</code>檔</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello %s\n&quot;</span>, argv[argc - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>Dockerfile</code>檔</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 第一階段編譯</span></span><br><span class="line"><span class="comment">#拉取一個可編譯c語言的鏡像(image比較肥大)，別名為builder</span></span><br><span class="line"><span class="keyword">FROM</span> gcc:<span class="number">9.4</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment">#將檔案copy至內部容器之指定路徑</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hello.c /src/hello.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#預設當前目錄</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#執行編輯 hello</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gcc --static -o hello hello.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第二階段編譯(image比較輕量)</span></span><br><span class="line"><span class="comment">#拉取一個可執行c語言的鏡像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.13</span>.<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#從builder鏡像取出 src/hello 程式copy之當前鏡像容器內部</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /src/hello /src/hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#預設執行該指令碼</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/src/hello&quot;</span> ]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> []</span></span><br></pre></td></tr></table></figure>

<p>玩玩看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kite-virtual-machine:/home/kite/Desktop/cworkspace# docker container run  --rm -it hello-apline kite</span><br><span class="line">hello kite</span><br></pre></td></tr></table></figure>





<h2 id="dockerfile技巧之儘量使用非root用戶"><a href="#dockerfile技巧之儘量使用非root用戶" class="headerlink" title="dockerfile技巧之儘量使用非root用戶"></a>dockerfile技巧之儘量使用非root用戶</h2><p><code>dockerfile-root</code>檔</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> FLASK=app.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /src/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;run&quot;</span>,<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<p><code>dockerfile-no-root</code>檔</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9.5-slim</span><br><span class="line"></span><br><span class="line">RUN pip install flask &amp;&amp; \</span><br><span class="line">    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \</span><br><span class="line">    mkdir /src &amp;&amp; \</span><br><span class="line">    chown -R flask:flask /src</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用flask user帳號，避免使用root發生資安問題</span></span><br><span class="line">USER flask</span><br><span class="line"></span><br><span class="line">COPY app.py /src/app.py</span><br><span class="line"></span><br><span class="line">WORKDIR /src</span><br><span class="line">ENV FLASK_APP=app.py</span><br><span class="line"></span><br><span class="line">EXPOSE 5000</span><br><span class="line"></span><br><span class="line">CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">構建flask-no-root鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f dockerfile-no-root -t flask-no-root .</span><br><span class="line">Sending build context to Docker daemon   7.68kB</span><br><span class="line">Step 1/8 : FROM python:3.9.5-slim</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Successfully built b65dbef09eed</span><br><span class="line">Successfully tagged flask-no-root:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">構建flask-root鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f docker-root -t docker-root .</span><br><span class="line">unable to prepare context: unable to evaluate symlinks in Dockerfile path: lstat /home/kite/Desktop/pythonworkspace/docker-root: no such file or directory</span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker image build -f dockerfile-root -t flask-root .</span><br><span class="line">Sending build context to Docker daemon   7.68kB</span><br><span class="line">Step 1/7 : FROM python:slim</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Successfully built 50a0190d1105</span><br><span class="line">Successfully tagged flask-root:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看鏡像</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker images</span><br><span class="line">REPOSITORY       TAG          IMAGE ID       CREATED          SIZE</span><br><span class="line">flask-no-root    latest       b65dbef09eed   3 minutes ago    126MB</span><br><span class="line">flask-root       latest       50a0190d1105   2 hours ago      134MB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建啟動flask-no-root</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d --rm --name flask-no-root flask-no-root</span><br><span class="line">8699d07e199436126092b6310ecf1a1fe7d68300b4a430d1209e94af1ff1073c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">創建啟動flask-root</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container run -d --rm --name flask-root flask-root</span><br><span class="line">bb46a94bf7b5746ef0d3189fec59ae527531389955287c6df718cdb67c4a49a3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用container top 指令查看權限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#root權限的container</span></span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container top flask-root</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                54109               54086               0                   15:30               ?                   00:00:00            /usr/local/bin/python /usr/local/bin/flask run -h 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用container top 指令查看權限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#非root權限的container</span></span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker container top flask-no-root</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">systemd+            54216               54196               0                   15:30               ?                   00:00:00            /usr/local/bin/python /usr/local/bin/flask run -h 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入到flask-root container容器內，以井字號開頭就說明是root權限</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker run -it flask-root sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">進入到flask-no-root container容器內，以錢字號開頭就說明是非root權限</span></span><br><span class="line">root@kite-virtual-machine:/home/kite/Desktop/pythonworkspace# docker run -it flask-no-root sh</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="小總結"><a href="#小總結" class="headerlink" title="小總結"></a>小總結</h2><p>dockerfile可以多參考相關連結</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">dockerfile reference</a></p>
<ul>
<li>官網的dockerfile reference docs</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/docker-library/official-images">docker-library&#x2F;official-images</a></p>
<ul>
<li>官網釋出的image，可以臨摹裡面的dockerfile寫法</li>
</ul>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"># docker</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/18/2022-02-18%20Docker%20%E7%B3%BB%E5%88%97%20-%20(2)%20%E9%8F%A1%E5%83%8F%E7%9A%84%E5%89%B5%E5%BB%BA%E7%AE%A1%E7%90%86%E5%92%8C%E7%99%BC%E5%B8%83/" rel="prev" title="docker 系列 - (2) 鏡像的創建管理和發布">
      <i class="fa fa-chevron-left"></i> docker 系列 - (2) 鏡像的創建管理和發布
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/02/24/2022-02-23%20Docker%20%E7%B3%BB%E5%88%97%20-%20(4)%20Dockerfile%E5%AE%B9%E5%99%A8%E7%9A%84%E5%84%B2%E5%AD%98/" rel="next" title="docker 系列 - (4) Dockerfile容器的儲存">
      docker 系列 - (4) Dockerfile容器的儲存 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%81%B8%E6%93%87%E5%9F%BA%E7%A4%8E%E9%8F%A1%E5%83%8F-FROM"><span class="nav-number">1.</span> <span class="nav-text">如何選擇基礎鏡像(FROM)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%89%87"><span class="nav-number">1.1.</span> <span class="nav-text">基本原則</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E9%81%8ERUN%E5%9F%B7%E8%A1%8C%E6%8C%87%E4%BB%A4"><span class="nav-number">2.</span> <span class="nav-text">通過RUN執行指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-bad"><span class="nav-number">2.1.</span> <span class="nav-text">Dockerfile.bad</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-good"><span class="nav-number">2.2.</span> <span class="nav-text">Dockerfile.good</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%A4%87%E8%A3%BD%E5%92%8C%E7%9B%AE%E9%8C%84%E6%93%8D%E4%BD%9C-ADD-COPY-WORKDIR"><span class="nav-number">3.</span> <span class="nav-text">文件複製和目錄操作(ADD,COPY,WORKDIR)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A4%87%E8%A3%BD%E6%99%AE%E9%80%9A%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">複製普通文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A4%87%E8%A3%BD%E5%A3%93%E7%B8%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">複製壓縮文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%81%B8%E6%93%87"><span class="nav-number">3.3.</span> <span class="nav-text">如何選擇</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97%E8%A8%98%E9%8C%84-COPY"><span class="nav-number">3.4.</span> <span class="nav-text">實驗記錄 COPY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97%E8%A8%98%E9%8C%84-ADD"><span class="nav-number">3.5.</span> <span class="nav-text">實驗記錄 ADD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A7%8B%E5%BB%BA%E5%8F%83%E6%95%B8%E5%92%8C%E7%92%B0%E5%A2%83%E8%AE%8A%E6%95%B8-ARG-VS-ENV"><span class="nav-number">4.</span> <span class="nav-text">構建參數和環境變數(ARG VS ENV)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ENV"><span class="nav-number">4.1.</span> <span class="nav-text">使用ENV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ARG"><span class="nav-number">4.2.</span> <span class="nav-text">使用ARG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%80%E5%88%A5"><span class="nav-number">4.3.</span> <span class="nav-text">區別</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ARG"><span class="nav-number">4.3.1.</span> <span class="nav-text">ARG</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ENV"><span class="nav-number">4.3.2.</span> <span class="nav-text">ENV</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMD%E5%AE%B9%E5%99%A8%E5%95%9F%E5%8B%95%E5%91%BD%E4%BB%A4"><span class="nav-number">5.</span> <span class="nav-text">CMD容器啟動命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%95%9F%E5%8B%95%E6%99%82%E9%A0%90%E8%A8%AD%E5%9F%B7%E8%A1%8C%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="nav-number">5.1.</span> <span class="nav-text">容器啟動時預設執行的命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E6%9E%9Cdocker-container-run%E5%95%9F%E5%8B%95%E5%AE%B9%E5%99%A8%E6%99%82%E6%8C%87%E5%AE%9A%E4%BA%86%E5%85%B6%E5%AE%83%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%89%87CMD%E5%91%BD%E4%BB%A4%E6%9C%83%E8%A2%AB%E5%BF%BD%E7%95%A5%E3%80%82"><span class="nav-number">5.2.</span> <span class="nav-text">如果docker container run啟動容器時指定了其它命令，則CMD命令會被忽略。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%AE%9A%E7%BE%A9%E4%BA%86%E5%A4%9A%E5%80%8BCMD-%E5%8F%AA%E6%9C%89%E6%9C%80%E5%BE%8C%E4%B8%80%E5%80%8B%E6%9C%83%E8%A2%AB%E5%9F%B7%E8%A1%8C%E3%80%82"><span class="nav-number">5.3.</span> <span class="nav-text">如果定義了多個CMD,只有最後一個會被執行。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="nav-number">5.4.</span> <span class="nav-text">小技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%95%9F%E5%8B%95%E5%91%BD%E4%BB%A4ENTRYPOINT"><span class="nav-number">6.</span> <span class="nav-text">容器啟動命令ENTRYPOINT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SHELL%E6%A0%BC%E5%BC%8F%E5%92%8CEXEC%E6%A0%BC%E5%BC%8F"><span class="nav-number">7.</span> <span class="nav-text">SHELL格式和EXEC格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#shell%E6%A0%BC%E5%BC%8F"><span class="nav-number">7.1.</span> <span class="nav-text">shell格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exec%E6%A0%BC%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">exec格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85%E8%88%89%E4%BE%8B"><span class="nav-number">7.3.</span> <span class="nav-text">注意事項舉例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E8%B5%B7%E6%A7%8B%E5%BB%BA%E4%B8%80%E5%80%8Bpython-Flask%E9%8F%A1%E5%83%8F"><span class="nav-number">8.</span> <span class="nav-text">一起構建一個python Flask鏡像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%92%B0%E5%A2%83%E6%BA%96%E5%82%99"><span class="nav-number">8.1.</span> <span class="nav-text">環境準備</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%85%B3%E6%9C%AC%E8%88%87%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">8.2.</span> <span class="nav-text">腳本與程式碼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E7%B7%A9%E5%AD%98%E6%8A%80%E5%B7%A7"><span class="nav-number">9.</span> <span class="nav-text">合理使用緩存技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerignore"><span class="nav-number">10.</span> <span class="nav-text">dockerignore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerfile%E6%8A%80%E8%A1%93%E4%B9%8B%E5%A4%9A%E6%AE%B5%E6%A7%8B%E5%BB%BA"><span class="nav-number">11.</span> <span class="nav-text">dockerfile技術之多段構建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerfile%E6%8A%80%E5%B7%A7%E4%B9%8B%E5%84%98%E9%87%8F%E4%BD%BF%E7%94%A8%E9%9D%9Eroot%E7%94%A8%E6%88%B6"><span class="nav-number">12.</span> <span class="nav-text">dockerfile技巧之儘量使用非root用戶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%B8%BD%E7%B5%90"><span class="nav-number">13.</span> <span class="nav-text">小總結</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">kite</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">131</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kite</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="總字數">354k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">10:44</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
